<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StarsDrop Ultimate Fix</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        :root {
            --green: #a3e635;
            --dark-bg: #050a03;
            --panel: #080f04;
            --text-muted: #4a5246;
        }

        body {
            background-color: var(--dark-bg);
            color: white;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* КРАСИВАЯ ЗАГРУЗКА (ТЕМНО-ЗЕЛЕНАЯ) */
        #loader-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 50% 40%, #0d2105 0%, #050a03 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease;
        }

        .loader-hero {
            width: 160px;
            filter: drop-shadow(0 0 35px rgba(163, 230, 53, 0.3));
            animation: bounce-hero 2.5s ease-in-out infinite;
        }

        @keyframes bounce-hero {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }

        .progress-box {
            width: 220px;
            height: 6px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-top: 30px;
            border: 1px solid rgba(163, 230, 53, 0.1);
            overflow: hidden;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #4d7c0f, var(--green));
            box-shadow: 0 0 15px var(--green);
            transition: width 0.2s;
        }

        /* ТОТ САМЫЙ ТУЛБАР СО СВЕЧЕНИЕМ */
        .app-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: var(--panel);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom, 15px);
            border-top: 1px solid rgba(163, 230, 53, 0.08);
            z-index: 1000;
        }

        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 5px;
            color: var(--text-muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-link svg {
            width: 26px;
            height: 26px;
        }

        .nav-link span {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Эффект свечения для активной кнопки */
        .nav-link.active {
            color: var(--green);
        }

        .nav-link.active svg {
            filter: drop-shadow(0 0 12px rgba(163, 230, 53, 0.7));
            transform: scale(1.1);
        }

        .nav-link.active span {
            filter: drop-shadow(0 0 5px rgba(163, 230, 53, 0.4));
        }

        /* КНОПКИ ГЛАВНОГО ЭКРАНА */
        .main-btn {
            background: linear-gradient(135deg, #0d1a07 0%, #050a03 100%);
            border: 1px solid rgba(163, 230, 53, 0.1);
            border-radius: 25px;
            padding: 22px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: 0.2s;
        }

        .main-btn:active {
            transform: scale(0.97);
            border-color: var(--green);
            background: rgba(163, 230, 53, 0.05);
        }

        /* АНИМИРОВАННЫЙ ФОН */
        #stars-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        .content-layer {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* МОДАЛКИ */
        .modal-wrap {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-body {
            width: 100%;
            background: #0d1a07;
            border-top: 2px solid var(--green);
            border-radius: 35px 35px 0 0;
            padding: 40px 24px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        /* ТОСТЕР (УВЕДОМЛЕНИЯ) */
        #toast-msg {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--green);
            color: black;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 13px;
            text-transform: uppercase;
            z-index: 10000;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
    </style>
</head>
<body>

    <div id="toast-msg">Готово!</div>
    <canvas id="stars-canvas"></canvas>

    <div id="loader-screen">
        <img src="hero.png" class="loader-hero">
        <h1 class="text-white font-black italic text-3xl mt-6 tracking-tighter italic">STARS DROP</h1>
        <div class="progress-box">
            <div id="progress-bar"></div>
        </div>
        <p class="text-green-500/50 font-bold uppercase text-[10px] mt-4 tracking-widest animate-pulse">Establishing connection...</p>
    </div>

    <div class="content-layer">
        <header class="p-6 flex justify-between items-start">
            <div class="flex items-center gap-3">
                <div class="w-14 h-14 rounded-full border-2 border-green-500/20 p-1 shadow-lg shadow-green-900/20">
                    <img id="u-avatar" src="" class="w-full h-full rounded-full object-cover">
                </div>
                <div>
                    <div id="u-name" class="font-black italic uppercase text-sm tracking-tight">PLAYER</div>
                    <div id="u-id" class="text-[10px] text-green-500 font-bold opacity-40 uppercase">ID: 000000</div>
                </div>
            </div>
            
            <div class="flex flex-col gap-1 items-end">
                <div class="bg-black/60 border border-green-500/20 rounded-2xl px-4 py-2 flex items-center gap-2" onclick="toggleModal('wallet', true)">
                    <span id="bal-ton" class="font-black text-sm">0.00</span>
                    <img src="ton.png" class="w-4 h-4">
                </div>
                <div class="flex items-center gap-1 pr-1">
                    <span id="bal-star" class="text-yellow-400 font-black text-xs">0</span>
                    <img src="star.png" class="w-3 h-3">
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto px-6 pt-4 pb-32">
            
            <section id="view-home" class="view-pane active">
                <div class="flex justify-center mb-10 mt-4">
                    <img src="hero.png" class="w-64 h-64 object-contain animate-float" style="filter: drop-shadow(0 20px 40px rgba(0,0,0,0.6));">
                </div>

                <div class="flex flex-col gap-4">
                    <div class="main-btn" onclick="openGame('blast.html')">
                        <div class="w-14 h-14 bg-green-500/10 rounded-2xl flex items-center justify-center">
                            <svg class="w-8 h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-black italic text-lg leading-none uppercase">Block Blast</h3>
                            <p class="text-[10px] font-bold text-green-500/40 uppercase mt-1 tracking-tighter">Играй и получай звёзды</p>
                        </div>
                        <svg class="w-5 h-5 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
                    </div>

                    <div class="main-btn opacity-50 grayscale">
                        <div class="w-14 h-14 bg-blue-500/10 rounded-2xl flex items-center justify-center">
                            <svg class="w-8 h-8 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4zM3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path></svg>
                        </div>
                        <div>
                            <h3 class="font-black italic text-lg leading-none uppercase">Кейсы</h3>
                            <p class="text-[10px] font-bold text-gray-500 uppercase mt-1">В разработке</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-profile" class="view-pane hidden">
                <div class="bg-white/5 border border-white/5 rounded-[35px] p-8 mt-4 text-center">
                    <div class="w-24 h-24 rounded-full border-4 border-green-500 mx-auto mb-4 p-1">
                        <img id="p-avatar" src="" class="w-full h-full rounded-full object-cover">
                    </div>
                    <h2 id="p-name" class="font-black italic text-2xl uppercase">PLAYER</h2>
                    <div class="inline-block bg-green-500/10 text-green-500 text-[10px] font-black px-4 py-1.5 rounded-full mt-3 uppercase tracking-widest border border-green-500/20">
                        Diamond Rank
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-10">
                        <div class="bg-black/40 p-5 rounded-3xl">
                            <div class="text-[10px] font-bold text-white/30 uppercase mb-1">Всего игр</div>
                            <div class="text-xl font-black italic">421</div>
                        </div>
                        <div class="bg-black/40 p-5 rounded-3xl">
                            <div class="text-[10px] font-bold text-white/30 uppercase mb-1">Выиграно</div>
                            <div class="text-xl font-black italic text-green-400">12.5 T</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <nav class="app-toolbar">
            <div class="nav-link" onclick="toggleModal('wallet', true)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                <span>Кошелёк</span>
            </div>
            <div id="nav-home" class="nav-link active" onclick="switchTab('home')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span>Главная</span>
            </div>
            <div id="nav-profile" class="nav-link" onclick="switchTab('profile')">
                <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                <span>Профиль</span>
            </div>
        </nav>
    </div>

    <div id="modal-wallet" class="modal-wrap" onclick="toggleModal('wallet', false)">
        <div class="modal-body" onclick="event.stopPropagation()">
            <div class="w-12 h-1.5 bg-white/10 mx-auto rounded-full mb-10"></div>
            <h2 class="text-3xl font-black italic uppercase mb-8">Магазин</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-10">
                <div class="bg-white/5 border border-white/10 p-6 rounded-[30px] active:scale-95 transition-all" onclick="buyTon(1)">
                    <div class="text-blue-400 font-black text-[10px] uppercase mb-1">Пополнение</div>
                    <div class="text-xl font-black italic">1.0 TON</div>
                </div>
                <div class="bg-white/5 border border-white/10 p-6 rounded-[30px] active:scale-95 transition-all" onclick="buyTon(5)">
                    <div class="text-blue-400 font-black text-[10px] uppercase mb-1">Пополнение</div>
                    <div class="text-xl font-black italic">5.0 TON</div>
                </div>
            </div>

            <div class="bg-yellow-500/5 border border-yellow-500/20 p-8 rounded-[35px]">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-yellow-500 font-black italic uppercase">Telegram Stars</span>
                    <img src="star.png" class="w-6 h-6">
                </div>
                <input type="number" id="star-qty" placeholder="Количество" class="w-full bg-black/40 border border-white/10 rounded-2xl p-5 text-white font-black text-xl outline-none focus:border-yellow-500">
                <button onclick="buyStars()" class="w-full bg-yellow-500 text-black font-black py-5 rounded-2xl mt-5 uppercase tracking-widest shadow-lg shadow-yellow-500/20 active:scale-95 transition-all">Купить</button>
            </div>

            <button onclick="toggleModal('wallet', false)" class="w-full mt-10 text-white/30 font-black uppercase text-[10px] tracking-widest">Назад</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;
        const API_BASE = 'https://stars-drop.vercel.app/api';

        tg.expand();
        tg.enableClosingConfirmation();

        // Инициализация профиля
        if (user) {
            const name = (user.username || user.first_name).toUpperCase();
            document.getElementById('u-name').innerText = name;
            document.getElementById('p-name').innerText = name;
            document.getElementById('u-id').innerText = `ID: ${user.id}`;
            const avatar = user.photo_url || `https://ui-avatars.com/api/?name=${user.first_name}&background=0D1A07&color=a3e635`;
            document.getElementById('u-avatar').src = avatar;
            document.getElementById('p-avatar').src = avatar;
            updateBalance();
        }

        // ЖЕСТКАЯ ЛОГИКА СОХРАНЕНИЯ ПРИ ВЫХОДЕ ИЗ ИГРЫ
        function openGame(url) {
            tg.HapticFeedback.impactOccurred('medium');
            const gameWindow = window.open(url, '_blank');
            
            // Как только окно игры закрывается, принудительно обновляем баланс
            const checkGame = setInterval(() => {
                if (gameWindow.closed) {
                    clearInterval(checkGame);
                    showToast('Синхронизация...');
                    // Опрашиваем сервер 3 раза с задержкой, чтобы точно поймать обновление
                    setTimeout(updateBalance, 500);
                    setTimeout(updateBalance, 2000);
                    setTimeout(updateBalance, 5000);
                }
            }, 1000);
        }

        async function updateBalance() {
            if (!user) return;
            try {
                const res = await fetch(`${API_BASE}/get_balance/${user.id}`);
                const data = await res.json();
                document.getElementById('bal-ton').innerText = parseFloat(data.balance).toFixed(2);
                document.getElementById('bal-star').innerText = data.stars || 0;
            } catch (e) { console.error("Balance sync failed"); }
        }

        // Вкладки
        function switchTab(tab) {
            document.querySelectorAll('.view-pane').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        // Модалки
        function toggleModal(id, show) {
            const m = document.getElementById(`modal-${id}`);
            if (show) {
                m.style.display = 'flex';
                setTimeout(() => {
                    m.style.opacity = '1';
                    m.querySelector('.modal-body').style.transform = 'translateY(0)';
                }, 10);
            } else {
                m.querySelector('.modal-body').style.transform = 'translateY(100%)';
                m.style.opacity = '0';
                setTimeout(() => m.style.display = 'none', 400);
            }
            tg.HapticFeedback.impactOccurred('light');
        }

        function showToast(text) {
            const t = document.getElementById('toast-msg');
            t.innerText = text;
            t.style.transform = 'translateX(-50%) translateY(0px)';
            setTimeout(() => {
                t.style.transform = 'translateX(-50%) translateY(-100px)';
            }, 3000);
        }

        // Звёздный фон
        const canvas = document.getElementById('stars-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = Array.from({length: 80}, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                s: Math.random() * 2,
                o: Math.random(),
                v: Math.random() * 0.3 + 0.1
            }));
        }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(s => {
                ctx.fillStyle = `rgba(163, 230, 53, ${s.o})`;
                ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
                s.y += s.v; if (s.y > canvas.height) s.y = 0;
            });
            requestAnimationFrame(draw);
        }

        // Плавная загрузка
        window.onload = () => {
            initStars(); draw();
            let p = 0;
            const bar = document.getElementById('progress-bar');
            const int = setInterval(() => {
                p += Math.random() * 20;
                if (p >= 100) {
                    p = 100; clearInterval(int);
                    setTimeout(() => {
                        document.getElementById('loader-screen').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader-screen').style.display = 'none', 800);
                    }, 500);
                }
                bar.style.width = p + '%';
            }, 200);
        };
    </script>
</body>
</html>
