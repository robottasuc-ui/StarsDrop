<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StarDrop Nova - Deluxe Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --neon: #4ade80;
            --bg-start: #050505;
            --bg-end: #0a0a0a;
            --card-bg: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --trans: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-start);
            color: white; overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        #main-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, var(--bg-end) 0%, var(--bg-start) 100%);
            transition: var(--trans);
        }

        .app-shell {
            display: flex; flex-direction: column;
            height: 100vh; max-width: 430px; margin: 0 auto;
            position: relative;
        }

        .header-ui { padding: 40px 20px 10px; text-align: center; z-index: 10; }
        
        .balance-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 25px; padding: 20px;
            border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; gap: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }

        #balance-num {
            font-size: 38px; font-weight: 900; margin: 0;
            background: linear-gradient(to bottom, #fff, #999);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            transition: transform 0.1s;
        }

        .main-coin { width: 45px; height: 45px; object-fit: contain; }

        .energy-container { margin-top: 25px; padding: 0 30px; }
        .energy-bar-bg {
            width: 100%; height: 14px; background: rgba(255,255,255,0.1);
            border-radius: 20px; overflow: hidden; border: 1.5px solid rgba(255,255,255,0.05);
        }
        #energy-fill {
            height: 100%; width: 100%; background: linear-gradient(90deg, var(--neon), #fff);
            box-shadow: 0 0 15px var(--neon); transition: width 0.3s ease-out;
        }
        .energy-text { 
            font-size: 13px; font-weight: 800; margin-top: 10px; 
            display: flex; justify-content: center; align-items: center; gap: 6px; 
            letter-spacing: 1px;
        }

        .game-core { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        .hero-platform {
            width: 280px; height: 80px; background: var(--neon);
            border-radius: 50%; filter: blur(60px); opacity: 0.15;
            position: absolute; bottom: 22%; transition: var(--trans);
        }

        #hero-img {
            width: 280px; z-index: 5; cursor: pointer;
            filter: drop-shadow(0 0 30px rgba(0,0,0,0.8));
            transition: transform 0.05s ease-out;
            will-change: transform;
            -webkit-user-drag: none;
        }
        .tap-anim { transform: scale(0.92) rotate(1deg) !important; }

        .drawer-wardrobe {
            position: absolute; bottom: 90px; left: 0; width: 100%; height: 75%;
            background: rgba(5, 5, 5, 0.98); backdrop-filter: blur(40px);
            border-radius: 40px 40px 0 0; z-index: 100;
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
            padding: 25px; box-sizing: border-box;
            border-top: 2px solid var(--neon);
            transform: translateY(120%);
            display: flex; flex-direction: column;
        }
        .drawer-wardrobe.active { transform: translateY(0); }

        .drawer-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px;
        }
        .drawer-header h3 { margin: 0; font-weight: 900; letter-spacing: 1px; font-size: 20px; }
        .close-btn { 
            cursor: pointer; color: var(--neon); font-weight: 900; 
            padding: 5px 15px; border-radius: 10px; background: rgba(255,255,255,0.05);
        }

        .scroll-area {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            flex: 1; overflow-y: auto; padding-bottom: 30px;
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .scroll-area::-webkit-scrollbar { display: none; }

        .leader-list-container { grid-template-columns: 1fr !important; }

        .card-item {
            background: rgba(255,255,255,0.03); border-radius: 24px;
            padding: 20px 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05);
            position: relative; transition: var(--trans); display: flex; flex-direction: column;
            justify-content: space-between; min-height: 180px;
        }
        .card-item.active-item { border-color: var(--neon); background: rgba(74,222,128,0.05); }

        .leader-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 20px; background: rgba(255,255,255,0.03);
            border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 8px;
        }
        .leader-row.me { border-color: var(--neon); background: rgba(74,222,128,0.1); }
        .leader-rank { font-weight: 900; color: var(--neon); width: 30px; }
        .leader-name { flex: 1; text-align: left; font-weight: 700; font-size: 14px; margin-left: 10px; }
        .leader-score { font-weight: 800; font-size: 12px; opacity: 0.8; }
        
        .lvl-badge {
            position: absolute; top: 12px; right: 12px;
            background: var(--neon); color: black; font-size: 9px;
            font-weight: 900; padding: 2px 8px; border-radius: 6px;
        }

        .card-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        .card-img { width: 80px; height: 80px; border-radius: 18px; object-fit: cover; margin: 0 auto 10px; }
        .card-title { font-size: 13px; font-weight: 800; margin-bottom: 5px; opacity: 0.9; }
        .card-desc { font-size: 10px; color: var(--neon); font-weight: 700; margin-bottom: 15px; }

        .btn-action {
            width: 100%; padding: 12px 5px; border-radius: 14px; border: none;
            font-weight: 900; font-size: 11px; cursor: pointer; text-transform: uppercase;
            transition: var(--trans);
        }
        .btn-buy { background: var(--neon); color: black; box-shadow: 0 4px 15px rgba(74,222,128,0.3); }
        .btn-buy:disabled { background: #222; color: #555; box-shadow: none; cursor: not-allowed; }
        .btn-owned { background: #1a1a1a; color: white; border: 1px solid var(--border); }

        .nav-bar {
            position: fixed; bottom: 0; width: 100%; max-width: 430px;
            height: 90px; background: rgba(0,0,0,0.95);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid var(--border); z-index: 110; padding-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        .nav-item { color: #555; font-size: 10px; font-weight: 800; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: var(--trans); }
        .nav-item.active { color: var(--neon); transform: translateY(-5px); }
        .nav-item svg { width: 22px; height: 22px; }

        .click-pop {
            position: absolute; pointer-events: none; z-index: 9999;
            font-weight: 900; font-size: 32px; color: #fff;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            animation: float-up 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            will-change: transform, opacity;
        }

        @keyframes float-up {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translate(-50%, -20px) scale(1.2); }
            100% { transform: translate(-50%, -120px) scale(1); opacity: 0; }
        }

        .back-nav { padding: 15px 20px; display: flex; align-items: center; z-index: 200; }
        .btn-back {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 12px;
            color: white; text-decoration: none;
            font-size: 12px; font-weight: 800; transition: var(--trans);
            backdrop-filter: blur(10px);
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –û–ë–ú–ï–ù–ê --- */
        .exchange-container {
            background: rgba(255,255,255,0.03); border-radius: 30px; padding: 25px;
            border: 1px solid var(--border); text-align: center;
        }
        .exchange-input-group { margin-bottom: 20px; text-align: left; }
        .exchange-input-group label { display: block; font-size: 12px; font-weight: 900; margin-bottom: 10px; opacity: 0.6; }
        .ex-input {
            width: 100%; background: rgba(0,0,0,0.3); border: 2px solid var(--border);
            border-radius: 15px; padding: 15px; color: white; font-family: 'Montserrat';
            font-weight: 900; font-size: 18px; outline: none; box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .ex-input:focus { border-color: var(--neon); }
        .exchange-arrow { font-size: 24px; color: var(--neon); margin: 15px 0; display: block; }
        .exchange-result {
            background: rgba(74,222,128,0.1); border-radius: 15px; padding: 20px;
            border: 1px solid rgba(74,222,128,0.2); margin-bottom: 25px;
        }
        .ex-res-val { font-size: 32px; font-weight: 900; color: var(--neon); display: block; }
        .ex-res-label { font-size: 10px; font-weight: 800; opacity: 0.7; }
        .btn-confirm-ex {
            background: var(--neon); color: black; padding: 18px; border-radius: 18px;
            width: 100%; font-weight: 900; border: none; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 10px 20px rgba(74,222,128,0.2);
        }
        .btn-confirm-ex:disabled { background: #222; color: #555; box-shadow: none; }
        .min-info { font-size: 10px; color: #ef4444; margin-top: 10px; font-weight: 700; }
    </style>
</head>
<body>

<div id="main-bg"></div>

<div class="app-shell">
    <div class="back-nav">
        <a href="index.html" class="btn-back">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            –ù–ê–ó–ê–î
        </a>
    </div>

    <div class="header-ui">
        <div class="balance-card">
            <img src="img/Nova Token.png" class="main-coin" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1205/1205194.png'">
            <h1 id="balance-num">0</h1>
        </div>
        <div class="energy-container">
            <div class="energy-bar-bg"><div id="energy-fill"></div></div>
            <div class="energy-text">‚ö° <span id="energy-val">1000</span> / <span id="max-energy-val">1000</span></div>
        </div>
    </div>

    <div class="game-core" id="tap-zone">
        <div class="hero-platform"></div>
        <img src="hero.png" id="hero-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1144/1144760.png'">
    </div>

    <div class="drawer-wardrobe" id="exchange-panel">
        <div class="drawer-header"><h3>–û–ë–ú–ï–ù –í–ê–õ–Æ–¢–´</h3><div class="close-btn" onclick="closeAllPanels()">–ó–ê–ö–†–´–¢–¨</div></div>
        <div class="exchange-container">
            <div class="exchange-input-group">
                <label>–û–¢–î–ê–ï–¢–ï (Nova Tokens)</label>
                <input type="number" id="ex-input-amount" class="ex-input" placeholder="0" oninput="updateExchangeResult()">
                <div class="min-info">–ú–∏–Ω–∏–º—É–º: 5,000,000,000</div>
            </div>
            
            <span class="exchange-arrow">‚Üì</span>

            <div class="exchange-result">
                <span class="ex-res-label">–ü–û–õ–£–ß–ò–¢–ï –ó–í–ï–ó–î</span>
                <span class="ex-res-val" id="ex-stars-res">0</span>
            </div>

            <button class="btn-confirm-ex" id="btn-ex-confirm" disabled onclick="confirmExchange()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –û–ë–ú–ï–ù</button>
        </div>
    </div>

    <div class="drawer-wardrobe" id="market-panel">
        <div class="drawer-header"><h3>–£–°–ò–õ–ï–ù–ò–Ø</h3><div class="close-btn" onclick="closeAllPanels()">–ó–ê–ö–†–´–¢–¨</div></div>
        <div class="scroll-area" id="market-list"></div>
    </div>

    <div class="drawer-wardrobe" id="wardrobe-panel">
        <div class="drawer-header"><h3>–ì–ï–†–û–ò</h3><div class="close-btn" onclick="closeAllPanels()">–ó–ê–ö–†–´–¢–¨</div></div>
        <div class="scroll-area" id="skin-list"></div>
    </div>

    <div class="drawer-wardrobe" id="leader-panel">
        <div class="drawer-header"><h3>–¢–û–ü 100 –ò–ì–†–û–ö–û–í</h3><div class="close-btn" onclick="closeAllPanels()">–ó–ê–ö–†–´–¢–¨</div></div>
        <div class="scroll-area leader-list-container" id="leader-list"></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item" onclick="openPanel('market-panel', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
            <div>–ú–ê–†–ö–ï–¢</div>
        </div>
        <div class="nav-item" onclick="openPanel('exchange-panel', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 16V4m0 0L3 8m4-4l4 4m9 4v12m0 0l4-4m-4 4l-4-4"/></svg>
            <div>–û–ë–ú–ï–ù</div>
        </div>
        <div class="nav-item active" id="nav-main" onclick="closeAllPanels()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
            <div>–ì–õ–ê–í–ù–ê–Ø</div>
        </div>
        <div class="nav-item" onclick="openPanel('leader-panel', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            <div>–¢–û–ü 100</div>
        </div>
        <div class="nav-item" onclick="openPanel('wardrobe-panel', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"/></svg>
            <div>–ì–ï–†–û–ò</div>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

const BACKEND_URL = "https://stars-drop.vercel.app";

    const heroes = [
        { id: 0, name: "–ù–æ–≤–∏—á–æ–∫", x: 1, price: 0, img: "hero.png", color: "#4ade80", bg: "#0f2a1a" },
        { id: 1, name: "–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫", x: 5, price: 500000, img: "img/hero1.jpg", color: "#facc15", bg: "#2a250f" },
        { id: 2, name: "–®–∞–º–∞–Ω", x: 10, price: 1000000, img: "img/hero2.jpg", color: "#a855f7", bg: "#251635" },
        { id: 3, name: "–ù–∏–Ω–¥–∑—è", x: 20, price: 5000000, img: "img/hero3.jpg", color: "#3b82f6", bg: "#162235" },
        { id: 4, name: "–ö–æ—Ä–æ–ª—å", x: 30, price: 15000000, img: "img/hero5.jpg", color: "#eab308", bg: "#352e16" },
        { id: 5, name: "–ü–∏—Ä–∞—Ç", x: 45, price: 100000000, img: "img/hero6.jpg", color: "#ef4444", bg: "#351616" },
        { id: 6, name: "–ö–æ—Å–º–æ–Ω–∞–≤—Ç", x: 55, price: 10000000000, img: "img/hero7.jpg", color: "#60a5fa", bg: "#162235" }
    ];

    const marketData = [
        { id: 0, name: "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫", baseAdd: 5, basePrice: 150, icon: "‚ö°Ô∏è", type: "click" },
        { id: 1, name: "–ü–µ—Ä—á–∞—Ç–∫–∏", baseAdd: 15, basePrice: 1000, icon: "üß§", type: "click" },
        { id: 2, name: "–ó–æ–ª–æ—Ç–æ–π –ø–∞–ª–µ—Ü", baseAdd: 60, basePrice: 5000, icon: "‚òùÔ∏è", type: "click" },
        { id: 3, name: "–ö–ª–∏–∫–µ—Ä-–±–æ—Ç", baseAdd: 250, basePrice: 20000, icon: "ü§ñ", type: "click" },
        { id: 4, name: "–¢—è–∂–µ–ª–∞—è –≥–∏—Ä—è", baseAdd: 1000, basePrice: 100000, icon: "üèãÔ∏è", type: "click" },
        { id: 5, name: "–ú–µ–≥–∞-–ë–∞—Ç–∞—Ä–µ—è", baseAdd: 500, basePrice: 50000, icon: "üîã", type: "energy" }
    ];

    let state = {
        coins: 0,
        energy: 1000,
        maxEnergy: 1000,
        ownedHeroes: [0],
        activeHeroId: 0,
        clickPower: 1,
        marketLevels: {},
        completedQuests: [],
        lastUnix: Date.now()
    };

function init() {
    const saved = localStorage.getItem('nova_engine_save');
    if (saved) {
        const data = JSON.parse(saved);
        state = { ...state, ...data };

        // --- –õ–û–ì–ò–ö–ê –û–§–§–õ–ê–ô–ù –≠–ù–ï–†–ì–ò–ò ---
        const now = Date.now();
        const elapsedMs = now - state.lastUnix; // –°–∫–æ–ª—å–∫–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –ø—Ä–æ—à–ª–æ
        const elapsedSeconds = Math.floor(elapsedMs / 1000);
        
        // –î–æ–ø—É—Å—Ç–∏–º, —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: 1 –µ–¥–∏–Ω–∏—Ü–∞ —ç–Ω–µ—Ä–≥–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É
        // (–ú–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å —á–∏—Å–ª–æ 1 –Ω–∞ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ)
        const energyToRestore = elapsedSeconds * 1; 
        
        state.energy = Math.min(state.maxEnergy, state.energy + energyToRestore);
        // ------------------------------
    }
    applyHeroVisuals();
    updateUI();
    startLoops();
}

    function startLoops() {
        setInterval(() => {
            if (state.energy < state.maxEnergy) {
                state.energy = Math.min(state.maxEnergy, state.energy + (state.maxEnergy / 4000));
                updateUI();
            }
        }, 1000);
        setInterval(save, 10000);
    }

    const tapZone = document.getElementById('tap-zone');
    const heroImg = document.getElementById('hero-img');

function handleTapLogic(x, y) {
        if (state.energy < 1) return;
        heroImg.classList.add('tap-anim');
        setTimeout(() => heroImg.classList.remove('tap-anim'), 50);
        const hero = heroes.find(h => h.id === state.activeHeroId);
        const profit = state.clickPower * hero.x;
        state.coins += profit;
        state.energy -= 1;

        // –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£ –ù–ò–ñ–ï:
        state.lastUnix = Date.now(); 

        showPop(x, y, profit);
        updateUI();
    }

    tapZone.addEventListener('touchstart', (e) => {
        e.preventDefault();
        for (let i = 0; i < e.changedTouches.length; i++) {
            handleTapLogic(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
        }
    }, { passive: false });

    function showPop(x, y, val) {
        const p = document.createElement('div');
        p.className = 'click-pop';
        p.innerHTML = `+${Math.floor(val).toLocaleString()}`;
        p.style.left = x + 'px';
        p.style.top = y + 'px';
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 800);
    }

    // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–ú–ï–ù–ê ---
    window.updateExchangeResult = function() {
        const input = document.getElementById('ex-input-amount');
        const resLabel = document.getElementById('ex-stars-res');
        const btn = document.getElementById('btn-ex-confirm');
        const amount = parseFloat(input.value) || 0;
        
        // –ö—É—Ä—Å 1 –º–ª—Ä–¥ = 1 –∑–≤–µ–∑–¥–∞
        const stars = Math.floor(amount / 1000000000);
        resLabel.innerText = stars.toLocaleString();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –±–∞–ª–∞–Ω—Å >= –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –ò –≤–≤–µ–¥–µ–Ω–Ω–æ–µ >= 5 –º–ª—Ä–¥
        if (state.coins >= amount && amount >= 5000000000 && stars > 0) {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    }

    window.confirmExchange = function() {
        const input = document.getElementById('ex-input-amount');
        const amount = parseFloat(input.value) || 0;
        const starsToGet = Math.floor(amount / 1000000000);

        if (state.coins >= amount && amount >= 5000000000) {
            // 1. –°–Ω–∏–º–∞–µ–º –±–∞–ª–∞–Ω—Å –≤ –∫–ª–∏–∫–µ—Ä–µ
            state.coins -= amount;
            
            // 2. –ù–∞—á–∏—Å–ª—è–µ–º –∑–≤–µ–∑–¥—ã (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç index.html)
            let currentStars = parseInt(localStorage.getItem('user_stars')) || 0;
            localStorage.setItem('user_stars', (currentStars + starsToGet).toString());

            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–∫–µ—Ä–∞
            save();
            updateUI();
            
            // –°–±—Ä–æ—Å –ø–æ–ª—è
            input.value = '';
            updateExchangeResult();
            
            tg.HapticFeedback.notificationOccurred('success');
            alert(`–£—Å–ø–µ—à–Ω—ã–π –æ–±–º–µ–Ω! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${starsToGet} ‚≠ê`);
        }
    }

    function renderMarket() {
        const container = document.getElementById('market-list');
        container.innerHTML = '';
        marketData.forEach(item => {
            const lvl = state.marketLevels[item.id] || 0;
            const price = Math.floor(item.basePrice * Math.pow(1.6, lvl));
            const bonus = item.baseAdd * (lvl + 1);
            container.innerHTML += `
                <div class="card-item">
                    <span class="lvl-badge">LVL ${lvl}</span>
                    <span class="card-icon">${item.icon}</span>
                    <div class="card-title">${item.name}</div>
                    <div class="card-desc">${item.type === 'click' ? '+' + bonus + ' –∫ –∫–ª–∏–∫—É' : '+' + item.baseAdd + ' –∫ –ª–∏–º–∏—Ç—É'}</div>
                    <button class="btn-action btn-buy" ${state.coins < price ? 'disabled' : ''} onclick="buyMarketItem(${item.id})">
                        ${price.toLocaleString()}
                    </button>
                </div>`;
        });
    }

    window.buyMarketItem = function(id) {
        const item = marketData.find(i => i.id === id);
        const lvl = state.marketLevels[item.id] || 0;
        const price = Math.floor(item.basePrice * Math.pow(1.6, lvl));
        if (state.coins >= price) {
            state.coins -= price;
            state.marketLevels[id] = lvl + 1;
            if (item.type === 'click') state.clickPower += item.baseAdd;
            else { state.maxEnergy += item.baseAdd; state.energy += item.baseAdd; }
            renderMarket(); updateUI(); save();
        }
    }

    function renderSkins() {
        const container = document.getElementById('skin-list');
        container.innerHTML = '';
        heroes.forEach(h => {
            const isOwned = state.ownedHeroes.includes(h.id);
            const isActive = state.activeHeroId === h.id;
            container.innerHTML += `
                <div class="card-item ${isActive ? 'active-item' : ''}">
                    <img src="${h.img}" class="card-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1144/1144760.png'">
                    <div class="card-title">${h.name}</div>
                    <div class="card-desc">–ú–ù–û–ñ–ò–¢–ï–õ–¨ x${h.x}</div>
                    <button class="btn-action ${isOwned ? 'btn-owned' : 'btn-buy'}" 
                            ${(!isOwned && state.coins < h.price) ? 'disabled' : ''} 
                            onclick="handleHero(${h.id})">
                        ${isOwned ? (isActive ? '–ê–ö–¢–ò–í–ï–ù' : '–í–´–ë–†–ê–¢–¨') : h.price.toLocaleString()}
                    </button>
                </div>`;
        });
    }

    window.handleHero = function(id) {
        const h = heroes.find(x => x.id === id);
        if (state.ownedHeroes.includes(id)) state.activeHeroId = id;
        else if (state.coins >= h.price) {
            state.coins -= h.price;
            state.ownedHeroes.push(id);
            state.activeHeroId = id;
        }
        applyHeroVisuals(); renderSkins(); updateUI(); save();
    }

    async function loadRealLeaderboard() {
        const list = document.getElementById('leader-list');
        list.innerHTML = '<div style="grid-column: 1/-1; padding: 20px; opacity: 0.5;">–ó–∞–≥—Ä—É–∑–∫–∞ –∂–∏–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤...</div>';
        try {
            await fetch(`${BACKEND_URL}/api/sync`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: tg.initDataUnsafe?.user?.id || "local_user",
                    name: tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫",
                    coins: state.coins
                })
            });
            const res = await fetch(`${BACKEND_URL}/api/leaderboard`);
            const topData = await res.json();
            list.innerHTML = '';
            topData.forEach((p, i) => {
                const isMe = p.id == (tg.initDataUnsafe?.user?.id || "0");
                list.innerHTML += `
                    <div class="leader-row ${isMe ? 'me' : ''}">
                        <div class="leader-rank">#${i+1}</div>
                        <div class="leader-name">${p.name} ${isMe ? '(–í–´)' : ''}</div>
                        <div class="leader-score">${Math.floor(p.coins).toLocaleString()} ‚≠ê</div>
                    </div>`;
            });
        } catch (e) {
            list.innerHTML = '<div style="grid-column: 1/-1; padding: 20px; color: #ff4444;">–ù—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä –¥–ª—è –¢–û–ü-100</div>';
        }
    }

    function openPanel(id, navEl) {
        document.querySelectorAll('.drawer-wardrobe').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        navEl.classList.add('active');
        if (id === 'market-panel') renderMarket();
        if (id === 'wardrobe-panel') renderSkins();
        if (id === 'leader-panel') loadRealLeaderboard();
        if (id === 'exchange-panel') updateExchangeResult();
    }

    function closeAllPanels() {
        document.querySelectorAll('.drawer-wardrobe').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('nav-main').classList.add('active');
    }

function updateUI() {
    document.getElementById('balance-num').innerText = Math.floor(state.coins).toLocaleString();
    document.getElementById('energy-val').innerText = Math.floor(state.energy);
    document.getElementById('max-energy-val').innerText = state.maxEnergy;
    document.getElementById('energy-fill').style.width = (state.energy / state.maxEnergy * 100) + '%';
    
    // –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ó–í–ï–ó–î (—á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ç–µ —Å–∞–º—ã–µ 1310)
    const stars = localStorage.getItem('user_stars') || "0";
    // –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∑–≤–µ–∑–¥ –≤ —Ö–µ–¥–µ—Ä–µ, –æ–±–Ω–æ–≤–∏ –µ–≥–æ:
    // document.getElementById('stars-display').innerText = stars; 
}

    function applyHeroVisuals() {
        const h = heroes.find(x => x.id === state.activeHeroId);
        document.getElementById('hero-img').src = h.img;
        document.documentElement.style.setProperty('--neon', h.color);
        document.getElementById('main-bg').style.background = `radial-gradient(circle at 50% 50%, ${h.bg} 0%, #050505 100%)`;
    }

function save() {
    state.lastUnix = Date.now(); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    localStorage.setItem('nova_engine_save', JSON.stringify(state));
}

    window.onload = init;
</script>
</body>
</html>
