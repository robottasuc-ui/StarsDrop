<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stars Plinko Official</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@700;900&display=swap');
        :root { --accent: #a855f7; --bg: #0b0b0b; }
        
        body { 
            background: var(--bg); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }

        /* Хедер на всю ширину */
        header {
            width: 100%;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Область игры - центрируем и поднимаем */
        #game-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Поднимаем к верху */
            padding-top: 5vh;
        }

        #plinko-container { 
            width: 400px; 
            height: 440px; 
            position: relative;
        }

        .multiplier-bar { 
            display: flex; 
            justify-content: center; 
            gap: 4px; 
            position: absolute; 
            bottom: 0; 
            width: 100%; 
        }

        .x-badge { 
            width: 38px; height: 28px; background: var(--accent); border-radius: 6px; 
            font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
        }

        /* Панель управления */
        .controls-ui {
            width: 100%;
            max-width: 600px;
            background: #141414;
            padding: 25px 40px;
            border-radius: 30px 30px 0 0;
            border: 1px solid rgba(255,255,255,0.05);
            margin-top: auto;
        }

        .btn-bet { 
            background: var(--accent); color: white; font-weight: 900; border-radius: 18px; 
            padding: 18px; width: 100%; border: none; cursor: pointer; text-transform: uppercase;
            font-size: 18px; box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4); 
        }
        .btn-bet:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <header>
        <div class="font-black text-2xl uppercase tracking-tighter italic">Stars<span class="text-purple-500">Plinko</span></div>
        <div class="bg-white/10 px-5 py-2 rounded-full flex items-center gap-3 border border-white/10">
            <span id="balance" class="font-black text-purple-400 text-xl">1000</span>
            <img src="img/star.png" class="w-6 h-6 object-contain" alt="logo">
        </div>
    </header>

    <div id="game-view">
        <div id="plinko-container">
            <div class="multiplier-bar" id="m-bar">
                </div>
        </div>

        <div class="controls-ui">
            <div class="grid grid-cols-3 gap-4 mb-5">
                <div class="bg-white/5 p-3 rounded-2xl border border-white/5 text-center">
                    <p class="text-[10px] opacity-40 uppercase font-bold">Ставка</p>
                    <input id="bet-input" type="number" value="10" class="bg-transparent w-full text-center font-black text-purple-400 text-xl outline-none">
                </div>
                <div class="bg-white/5 p-3 rounded-2xl border border-white/5 text-center">
                    <p class="text-[10px] opacity-40 uppercase font-bold">Риск</p>
                    <p class="font-black text-sm mt-1">MEDIUM</p>
                </div>
                <div class="bg-white/5 p-3 rounded-2xl border border-white/5 text-center">
                    <p class="text-[10px] opacity-40 uppercase font-bold">Ряды</p>
                    <p class="font-black text-sm mt-1">8</p>
                </div>
            </div>
            <button onclick="dropBall()" class="btn-bet">Сбросить шарик</button>
        </div>
    </div>

<script>
    // 1. КОНФИГ БАЗЫ
    const SB_URL = 'https://mwsbkpfarhdankpyifbm.supabase.co';
    const SB_KEY = 'sb_publishable_Bj40x3HKomgXSyLMiVqXig_FqCgOSmA';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    const userId = 8015661230;

    let balance = 0; 
    const multiValues = [5, 0.2, 2, 1.2, 1, 0.5, 1.2, 2, 10];

    // 2. РЕНДЕР КНОПОК (чтобы не ехали)
    const mBar = document.getElementById('m-bar');
    multiValues.forEach((val, i) => {
        const div = document.createElement('div');
        div.className = 'x-badge';
        if(val === 0.2) div.style.background = '#3b0764';
        div.innerText = val + 'X';
        mBar.appendChild(div);
    });

    // 3. ФИЗИКА MATTER.JS
    const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
    const engine = Engine.create();
    engine.gravity.y = 1.4;

    const render = Render.create({
        element: document.getElementById('plinko-container'),
        engine: engine,
        options: { width: 400, height: 440, wireframes: false, background: 'transparent' }
    });

    // Стены
    Composite.add(engine.world, [
        Bodies.rectangle(5, 220, 10, 440, { isStatic: true, render: { visible: false } }),
        Bodies.rectangle(395, 220, 10, 440, { isStatic: true, render: { visible: false } })
    ]);

    // Пирамида
    for (let i = 2; i <= 9; i++) {
        for (let j = 0; j < i; j++) {
            const x = 200 + (j - (i - 1) / 2) * 42;
            const y = 30 + i * 40;
            Composite.add(engine.world, Bodies.circle(x, y, 4, { isStatic: true, render: { fillStyle: '#444' } }));
        }
    }

    // Зоны
    for (let i = 0; i < 9; i++) {
        Composite.add(engine.world, Bodies.rectangle(32 + i * 42, 430, 38, 40, { 
            isStatic: true, isSensor: true, label: `bucket-${i}`, render: { visible: false } 
        }));
    }

    Render.run(render);
    Runner.run(Runner.create(), engine);

    // 4. ФУНКЦИИ
    async function syncBalance() {
        try {
            const { data } = await supabaseClient.from('users').select('stars').eq('user_id', userId).single();
            if (data) { 
                balance = data.stars; 
                document.getElementById('balance').innerText = Math.floor(balance); 
            }
        } catch(e) { console.error("DB Error"); }
    }

    async function dropBall() {
        const bet = parseInt(document.getElementById('bet-input').value) || 0;
        if (balance < bet) return alert("Мало звезд!");
        
        balance -= bet;
        document.getElementById('balance').innerText = Math.floor(balance);

        const ball = Bodies.circle(200 + (Math.random() * 4 - 2), 0, 9, {
            restitution: 0.5, frictionAir: 0.04, render: { fillStyle: '#a855f7' },
            label: 'ball', betAmount: bet
        });
        Composite.add(engine.world, ball);
    }

    Events.on(engine, 'collisionStart', (event) => {
        event.pairs.forEach(async (pair) => {
            const { bodyA, bodyB } = pair;
            if (bodyB.label === 'ball' && bodyA.label.startsWith('bucket-')) {
                const idx = parseInt(bodyA.label.split('-')[1]);
                const win = Math.floor(bodyB.betAmount * multiValues[idx]);
                Composite.remove(engine.world, bodyB);
                
                balance += win;
                document.getElementById('balance').innerText = Math.floor(balance);
                await supabaseClient.from('users').update({ stars: balance }).eq('user_id', userId);
            }
        });
    });

    window.onload = syncBalance;
</script>
</body>
</html>
