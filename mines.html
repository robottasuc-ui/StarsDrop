<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stars Mines — TMA Edition</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --bg: #0a0510; --accent: #a855f7; --panel-bg: #120a1f; --cell-bg: #1a1025; }
        
        body { 
            background: var(--bg); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex;
            flex-direction: column;
        }

        header { 
            background: #08040d; 
            border-bottom: 1px solid #221536; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 10; 
        }

        /* Адаптация под вертикаль ТГ */
        .game-layout { 
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            justify-content: center;
        }

        .mines-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            width: 100%; 
            max-width: 380px; 
            margin: 0 auto;
        }

        .cell { 
            aspect-ratio: 1/1; 
            background: var(--cell-bg); 
            border-radius: 10px; 
            border: 1px solid #3b225a; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.1s; 
            border-bottom: 3px solid #000; 
        }
        
        .cell.open { background: #08040d; border-bottom: 0; cursor: default; }
        .cell img { width: 70%; height: 70%; object-fit: contain; animation: pop 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        
        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }

        /* Нижняя панель управления как в Crash */
        .ui-panel {
            background: var(--panel-bg);
            padding: 15px 20px;
            border-radius: 20px 20px 0 0;
            border-top: 1px solid rgba(168, 85, 247, 0.3);
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .currency-btn { background: #1a1025; padding: 10px; border: 1px solid #3b225a; border-radius: 10px; text-align: center; font-size: 11px; font-weight: 900; color: #a19bb0; flex: 1; }
        .currency-btn.active { border-color: var(--accent); background: #2d164d; color: #fff; }

        .btn-main { background: var(--accent); color: white; font-weight: 900; padding: 15px; border-radius: 12px; text-transform: uppercase; width: 100%; font-size: 16px; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); }
        .btn-main.btn-cashout { background: #10b981 !important; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4) !important; }
        
        .input-box { background: #08040d; border: 1px solid #3b225a; padding: 8px; border-radius: 10px; font-weight: 900; color: #fff; text-align: center; font-size: 1.1rem; width: 100%; outline: none; }
        
        select.input-box { font-size: 14px; appearance: none; }
    </style>
</head>
<body>

    <header>
        <div onclick="location.href='index.html'" class="font-black text-accent text-lg italic tracking-tighter uppercase">
            STARS<span class="text-white">MINES</span>
        </div>
        
        <div class="flex gap-3 font-bold text-[12px]">
            <div class="flex items-center gap-1.5 bg-black/40 px-2 py-1 rounded-lg border border-white/5">
                <img src="img/star.png" class="w-3.5 h-3.5"> <span id="val-stars">0</span>
            </div>
            <div class="flex items-center gap-1.5 bg-black/40 px-2 py-1 rounded-lg border border-white/5">
                <img src="img/ton.png" class="w-3.5 h-3.5"> <span id="val-ton">0.00</span>
            </div>
        </div>
    </header>

    <main class="game-layout">
        <div id="grid" class="mines-grid"></div>
        
        <div id="stats" class="hidden mt-6 bg-black/40 p-3 rounded-xl border border-white/5 max-w-[380px] mx-auto w-full">
            <div class="flex justify-between text-[11px] font-black text-gray-400 mb-1">МНОЖИТЕЛЬ <span id="cur-mult" class="text-white text-sm">1.00x</span></div>
            <div class="flex justify-between text-[11px] font-black text-gray-400">ВЫИГРЫШ 
                <div class="flex items-center gap-1 text-green-400 text-sm">
                    <span id="cur-win">0</span>
                    <img id="cur-icon" src="img/star.png" class="w-3 h-3">
                </div>
            </div>
        </div>
    </main>

    <aside class="ui-panel">
        <div class="flex gap-2">
            <div id="mode-stars" onclick="switchCur('stars')" class="currency-btn active">STARS</div>
            <div id="mode-ton" onclick="switchCur('ton')" class="currency-btn">TON</div>
        </div>

        <div class="flex gap-2">
            <div class="flex-1">
                <input id="input-bet" type="number" class="input-box" value="10">
            </div>
            <div class="flex-1">
                <select id="mines-count" class="input-box cursor-pointer">
                    <option value="1">1 МИНА</option>
                    <option value="3" selected>3 МИНЫ</option>
                    <option value="5">5 МИН</option>
                    <option value="10">10 МИН</option>
                    <option value="20">20 МИН</option>
                </select>
            </div>
        </div>

        <button id="btn-main" onclick="onMainAction()" class="btn-main">Играть</button>
    </aside>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const SB_URL = "https://mwsbkpfarhdankpyifbm.supabase.co"; 
    const SB_KEY = "sb_publishable_Bj40x3HKomgXSyLMiVqXig_FqCgOSmA"; 
    const SB = supabase.createClient(SB_URL, SB_KEY);

    let currentUser = null, cur = 'stars', isPlaying = false;
    let mines = [], opened = 0, betVal = 0;

    async function checkAuth() {
        const saved = localStorage.getItem('stars_user');
        if (!saved) { location.href = 'index.html'; return; }
        currentUser = JSON.parse(saved);
        syncBalances();
        renderGrid();
    }

    async function syncBalances() {
        const { data } = await SB.from('users').select('*').eq('user_id', currentUser.user_id).single();
        if (data) {
            document.getElementById('val-stars').innerText = Math.floor(Number(data.stars || 0)).toLocaleString();
            document.getElementById('val-ton').innerText = Number(data.balance || 0).toFixed(2);
        }
    }

    function switchCur(m) {
        if (isPlaying) return;
        cur = m;
        tg.HapticFeedback.impactOccurred('light');
        document.querySelectorAll('.currency-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mode-' + m).classList.add('active');
        document.getElementById('cur-icon').src = `img/${m === 'stars' ? 'star' : 'ton'}.png`;
        updateStats();
    }

    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for (let i = 0; i < 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.idx = i;
            cell.onclick = () => openCell(i);
            grid.appendChild(cell);
        }
    }

    async function onMainAction() {
        const btn = document.getElementById('btn-main');
        const dbCol = cur === 'stars' ? 'stars' : 'balance';
        tg.HapticFeedback.impactOccurred('medium');
        
        if (!isPlaying) {
            const amount = Number(document.getElementById('input-bet').value);
            const { data: user } = await SB.from('users').select('*').eq('user_id', currentUser.user_id).single();
            
            if (!user || Number(user[dbCol]) < amount) return tg.showAlert("Недостаточно средств!");

            const { error } = await SB.from('users').update({ [dbCol]: Number(user[dbCol]) - amount }).eq('user_id', currentUser.user_id);
            
            if (!error) {
                isPlaying = true; betVal = amount; opened = 0;
                const mCount = parseInt(document.getElementById('mines-count').value);
                mines = [];
                while(mines.length < mCount) {
                    let r = Math.floor(Math.random() * 25);
                    if(!mines.includes(r)) mines.push(r);
                }
                syncBalances(); renderGrid();
                btn.innerText = "ЗАБРАТЬ"; btn.disabled = true;
                btn.classList.add('btn-cashout');
                document.getElementById('stats').classList.remove('hidden');
                updateStats();
            }
        } else {
            const mult = calcMult(opened, mines.length);
            const win = betVal * mult;
            const { data: user } = await SB.from('users').select(dbCol).eq('user_id', currentUser.user_id).single();
            await SB.from('users').update({ [dbCol]: Number(user[dbCol]) + win }).eq('user_id', currentUser.user_id);
            tg.HapticFeedback.notificationOccurred('success');
            finishGame(true);
        }
    }

    function calcMult(opened, mCount) {
        if (opened === 0) return 0;
        let p = 1;
        for (let i = 0; i < opened; i++) { p = p * (25 - i - mCount) / (25 - i); }
        return (0.97 / p);
    }

    function updateStats() {
        const mult = calcMult(opened, mines.length);
        document.getElementById('cur-mult').innerText = mult.toFixed(2) + 'x';
        const winText = (betVal * mult).toFixed(cur === 'stars' ? 0 : 2);
        document.getElementById('cur-win').innerText = winText;
        if (opened > 0) {
            document.getElementById('btn-main').innerText = `ЗАБРАТЬ ` + winText;
            document.getElementById('btn-main').disabled = false;
        }
    }

    async function openCell(idx) {
        if (!isPlaying) return;
        const cell = document.querySelector(`[data-idx="${idx}"]`);
        if (cell.classList.contains('open')) return;

        cell.classList.add('open');
        if (mines.includes(idx)) {
            tg.HapticFeedback.notificationOccurred('error');
            cell.innerHTML = '<img src="img/bomb.png">';
            cell.style.backgroundColor = '#3d1616';
            finishGame(false);
        } else {
            tg.HapticFeedback.impactOccurred('light');
            cell.innerHTML = '<img src="img/kolechko.png">';
            opened++;
            updateStats();
            if (opened + mines.length === 25) onMainAction();
        }
    }

    function finishGame(win) {
        isPlaying = false;
        document.querySelectorAll('.cell').forEach((c, idx) => {
            if (mines.includes(idx)) {
                c.classList.add('open');
                c.innerHTML = `<img src="img/bomb.png" style="opacity:${win ? '0.4' : '1'}">`;
            }
        });
        setTimeout(() => { 
            document.getElementById('stats').classList.add('hidden');
            document.getElementById('btn-main').classList.remove('btn-cashout');
            document.getElementById('btn-main').innerText = "ИГРАТЬ";
            document.getElementById('btn-main').disabled = false;
            renderGrid();
            syncBalances();
        }, 2500);
    }

    checkAuth();
</script>
</body>
</html>
