<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StarsDrop - Ultimate Profile</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-dark: #0a1205;
            --accent-green: #a3e635;
            --deep-green: #166534;
        }

        body { 
            background: var(--bg-dark); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            overflow-x: hidden; 
            touch-action: pan-y;
            -webkit-user-select: none;
            user-select: none;
        }

        #stars-canvas { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 0; pointer-events: none; 
        }

        .main-wrapper { 
            position: relative; z-index: 1; min-height: 100vh; 
            padding: 24px 20px 140px; 
            background: radial-gradient(circle at 50% 30%, #5d9e1c 0%, #0a1205 80%); 
        }

        .glass-card { 
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(163, 230, 53, 0.2); 
            backdrop-filter: blur(20px); 
            border-radius: 28px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .inventory-slot { 
            aspect-ratio: 1/1; 
            background: rgba(163, 230, 53, 0.05); 
            border: 1px dashed rgba(163, 230, 53, 0.3); 
            border-radius: 22px; 
            display: flex; align-items: center; justify-content: center; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .active-item { 
            background: rgba(163, 230, 53, 0.1); 
            border: 1px solid var(--accent-green); 
            box-shadow: 0 0 15px rgba(163, 230, 53, 0.2);
            cursor: pointer;
        }
        .active-item:active { transform: scale(0.9); }

        .btn-green {
            background: var(--accent-green);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
            border-radius: 20px;
            transition: 0.2s;
        }
        .btn-green:active { transform: scale(0.96); opacity: 0.9; }

        .dock-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(5, 10, 3, 0.98); 
            backdrop-filter: blur(25px); 
            border-top: 1px solid rgba(163, 230, 53, 0.15); 
            display: flex; justify-content: space-around; 
            padding: 18px 10px 40px; z-index: 1000; 
        }
        .dock-btn { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #4b5563; flex: 1; }
        .dock-btn.active { color: var(--accent-green); filter: drop-shadow(0 0 8px var(--accent-green)); }
        .dock-btn span { font-size: 10px; font-weight: 900; text-transform: uppercase; }

        input {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(163, 230, 53, 0.1);
            border-radius: 16px;
            padding: 14px;
            color: white;
            outline: none;
            font-weight: 700;
        }
        input:focus { border-color: var(--accent-green); }

        .stat-badge {
            background: rgba(255,255,255,0.05);
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            color: #a3e635;
            border: 1px solid rgba(163, 230, 53, 0.2);
        }
    </style>
</head>
<body>
    <canvas id="stars-canvas"></canvas>

    <div class="main-wrapper">
        <div class="flex flex-col items-center mt-4 mb-8">
            <div class="relative">
                <img id="user-avatar" src="" class="w-24 h-24 rounded-full border-4 border-green-500/30 bg-gray-900 shadow-2xl object-cover">
                <div class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 border-4 border-[#0a1205] rounded-full"></div>
            </div>
            <h2 id="user-name" class="text-3xl font-black uppercase italic mt-4 tracking-tighter">ЗАГРУЗКА...</h2>
            <div class="flex gap-2 mt-2">
                <div id="user-id" class="stat-badge">ID: 000000</div>
                <div id="stars-display" class="stat-badge text-yellow-400">⭐ 0</div>
            </div>
        </div>

        <div class="glass-card p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[10px] font-black uppercase text-green-400 tracking-[0.2em]">Реферальная система</h3>
                <span id="ref-count" class="text-xs font-bold text-white">0 ПРИГЛ.</span>
            </div>
            <p class="text-[10px] text-gray-400 mb-4 uppercase font-bold tracking-tighter">Получай 50 ⭐ за каждого приглашенного друга!</p>
            <button onclick="shareReferral()" class="w-full btn-green py-4 text-xs tracking-widest">Пригласить друга</button>
        </div>

        <div class="glass-card p-6 mb-6">
            <h3 class="text-[10px] font-black uppercase text-green-400 mb-4 tracking-[0.2em]">Промокод</h3>
            <div class="flex gap-3">
                <input type="text" id="promo-input" class="flex-1 text-sm uppercase" placeholder="ВВЕДИТЕ КОД...">
                <button onclick="applyPromo()" class="btn-green px-8 py-4 text-xs">ОК</button>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xs font-black uppercase tracking-widest text-green-400">Твой инвентарь</h3>
                <span class="text-[10px] font-bold text-gray-500" id="item-count">0 / 6</span>
            </div>
            <div id="inventory-grid" class="grid grid-cols-3 gap-4"></div>
        </div>
    </div>

    <div id="item-modal" class="fixed inset-0 z-[2000] hidden items-center justify-center bg-black/95 backdrop-blur-xl">
        <div class="glass-card p-8 w-[88%] max-w-[340px] text-center border-green-500/40">
            <div class="w-28 h-28 bg-green-500/10 rounded-[35px] flex items-center justify-center mx-auto mb-6 shadow-inner">
                <img id="modal-img" src="" class="w-16 h-16 object-contain">
            </div>
            <h2 id="modal-title" class="text-2xl font-black uppercase italic mb-1">ПРЕДМЕТ</h2>
            <p class="text-gray-500 text-[10px] uppercase mb-8 tracking-[0.3em]">Выберите действие</p>
            
            <div class="flex flex-col gap-4">
                <button onclick="handleWithdraw()" class="w-full btn-green py-5 shadow-lg shadow-green-500/20 text-sm">ВЫВЕСТИ В БОТ</button>
                <button id="sell-btn" onclick="handleSell()" class="w-full bg-white/5 border border-white/10 py-5 rounded-2xl font-black uppercase text-[11px] tracking-wider active:bg-white/10 transition-all">ПРОДАТЬ</button>
                <button onclick="closeModal()" class="w-full py-2 text-gray-600 text-[10px] font-black uppercase mt-2 tracking-widest">ОТМЕНА</button>
            </div>
        </div>
    </div>

    <div class="dock-bar">
        <div onclick="buyStars(100)" class="dock-btn">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 8c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"/><path stroke-width="2" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z"/></svg>
            <span>Депозит</span>
        </div>
        <div onclick="location.href='index.html'" class="dock-btn">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span>Главная</span>
        </div>
        <div class="dock-btn active">
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path></svg>
            <span>Профиль</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let selectedIdx = null;
        let isPaid75 = localStorage.getItem('isPaid75') === 'true';

        // ПОЛНАЯ БАЗА ЦЕН (БЕЗ УДАЛЕНИЙ)
        const PRICE_DB = {
            "1may.jpg": { n: "1 May", p: 100 }, "2025.jpg": { n: "2025", p: 500 },
            "bear.png": { n: "Bear", p: 3500 }, "book.jpg": { n: "Book", p: 1000 },
            "boooox.png": { n: "Berry Box", p: 700 }, "botinok.png": { n: "Boot", p: 400 },
            "box.png": { n: "Jack Box", p: 600 }, "car.png": { n: "Car", p: 5000 },
            "raketa.png": { n: "Rocket", p: 50 }, "ccolso2.png": { n: "Star Ring", p: 3000 },
            "cerrrdce.jpg": { n: "Gingerbread", p: 500 }, "chemodan.jpg": { n: "Suitcase", p: 5000 },
            "ciga.png": { n: "Cigar", p: 3000 }, "colso.png": { n: "Blue Ring", p: 2500 },
            "costum.jpg": { n: "Costume", p: 10000 }, "cvetok.png": { n: "Flower", p: 1000 },
            "dog.png": { n: "Rich Dog", p: 500 }, "dyxi.png": { n: "Perfume", p: 10000 },
            "fonarik.jpg": { n: "Lantern", p: 100 }, "grob.jpg": { n: "Coffin", p: 5000 },
            "gyba.png": { n: "Lava Lips", p: 5000 }, "happybirthday.jpg": { n: "B-Day Cake", p: 200 },
            "heart.png": { n: "Heart Lock", p: 2000 }, "helmet.png": { n: "Spartan", p: 25000 },
            "kalendar.png": { n: "Calendar", p: 400 }, "kepka.png": { n: "Red Cap", p: 100000 },
            "kirpitch.jpg": { n: "Brick", p: 10000 }, "koks.jpg": { n: "Cocktail", p: 150 },
            "koktel.png": { n: "Green Mix", p: 500 }, "kot.png": { n: "Atomic Cat", p: 10000 },
            "kotel.png": { n: "Cauldron", p: 500 }, "krovatka.jpg": { n: "Bow Tie", p: 600 },
            "lolipop.png": { n: "Lollipop", p: 500 }, "lucky.jpg": { n: "Clover", p: 500 },
            "mafin.jpg": { n: "Muffin", p: 700 }, "metch.png": { n: "Lightsaber", p: 700 },
            "narkotiki.png": { n: "SD Token", p: 600 }, "obyv.jpg": { n: "Sneakers", p: 10000 },
            "otchki.jpg": { n: "Glasses", p: 30000 }, "orel.jpg": { n: "Eagle", p: 5000 },
            "otkritka.jpg": { n: "Dove Post", p: 150 }, "paska.jpg": { n: "Easter Cake", p: 75 },
            "rozza.png": { n: "Rose", p: 2000 }, "rykzak.jpg": { n: "Backpack", p: 500 },
            "shapka.png": { n: "Santa Hat", p: 500 }, "shar.jpg": { n: "Crystal Ball", p: 1000 },
            "shlem.png": { n: "Helmet Biker", p: 3500 }, "soska.jpg": { n: "Pacifier", p: 3000 },
            "star.png": { n: "Golden Star", p: 15 }, "statyya.jpg": { n: "Statue", p: 41000 },
            "venok.jpg": { n: "Wreath", p: 500 }, "yayko.png": { n: "Spotted Egg", p: 600 },
            "zhele.png": { n: "Green Slime", p: 700 }, "zmei.png": { n: "Snake", p: 500 },
            "kolechko.png": { n: "Ring", p: 100 }
        };

        function updateBalanceUI() {
            const stars = localStorage.getItem('user_stars') || "0";
            document.getElementById('stars-display').innerText = `⭐ ${stars}`;
        }

        function loadInventory() {
            const grid = document.getElementById('inventory-grid');
            const items = JSON.parse(localStorage.getItem('user_inventory')) || [];
            grid.innerHTML = '';
            document.getElementById('item-count').innerText = `${items.length} / 6`;

            for (let i = 0; i < 6; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                if (items[i]) {
                    slot.classList.add('active-item');
                    slot.innerHTML = `<img src="${items[i].img}" class="w-12 h-12 object-contain">`;
                    slot.onclick = () => openItem(i, items[i]);
                } else {
                    slot.innerHTML = `<span class="text-[8px] text-green-900 font-black">EMPTY</span>`;
                }
                grid.appendChild(slot);
            }
        }

        function openItem(index, item) {
            selectedIdx = index;
            const fileName = item.img.split('/').pop().toLowerCase();
            const data = PRICE_DB[fileName] || { n: item.name || "Item", p: 1 };
            
            document.getElementById('modal-img').src = item.img;
            document.getElementById('modal-title').innerText = data.n.toUpperCase();
            document.getElementById('sell-btn').innerText = `ПРОДАТЬ ЗА ${data.p} ⭐`;
            document.getElementById('item-modal').style.display = 'flex';
        }

        function handleSell() {
            let items = JSON.parse(localStorage.getItem('user_inventory')) || [];
            const item = items[selectedIdx];
            const fileName = item.img.split('/').pop().toLowerCase();
            const price = PRICE_DB[fileName]?.p || 1;

            let currentStars = parseInt(localStorage.getItem('user_stars')) || 0;
            localStorage.setItem('user_stars', (currentStars + price).toString());

            items.splice(selectedIdx, 1);
            localStorage.setItem('user_inventory', JSON.stringify(items));
            
            closeModal();
            loadInventory();
            updateBalanceUI();
            tg.HapticFeedback.notificationOccurred('success');
        }

        function handleWithdraw() {
            // ПРОВЕРКА ЗВЕЗД (ВЕРИФИКАЦИЯ)
            if (!isPaid75) {
                tg.showConfirm("Для вывода предметов нужно разово оплатить комиссию верификации (75 Stars). Перейти к оплате?", (ok) => {
                    if (ok) {
                        // Эмулируем оплату. В продакшене тут вызов инвойса.
                        isPaid75 = true;
                        localStorage.setItem('isPaid75', 'true');
                        tg.showAlert("Аккаунт верифицирован! Теперь вы можете выводить любые предметы.");
                    }
                });
                return;
            }

            const items = JSON.parse(localStorage.getItem('user_inventory')) || [];
            const item = items[selectedIdx];
            const user = tg.initDataUnsafe?.user || { id: 0, first_name: "User" };

            tg.showConfirm(`Вывести "${item.name || 'Предмет'}"? Администратор получит уведомление.`, (ok) => {
                if (ok) {
                    // Отправка данных в ТГ бот
                    const requestData = {
                        action: "WITHDRAW_REQUEST",
                        user_id: user.id,
                        user_name: user.username || user.first_name,
                        item: item
                    };
                    tg.sendData(JSON.stringify(requestData));

                    // Удаление из инвентаря
                    items.splice(selectedIdx, 1);
                    localStorage.setItem('user_inventory', JSON.stringify(items));
                    closeModal();
                    loadInventory();
                }
            });
        }

        function applyPromo() {
            const val = document.getElementById('promo-input').value.trim().toUpperCase();
            if (!val) return;

            // Расширенный список промокодов
            const PROMOS = { "START": 500, "GIFT100": 100, "WEB3": 50, "BONUS": 1000 };

            if (PROMOS[val]) {
                let currentStars = parseInt(localStorage.getItem('user_stars')) || 0;
                localStorage.setItem('user_stars', (currentStars + PROMOS[val]).toString());
                tg.showAlert(`Промокод активирован! +${PROMOS[val]} ⭐`);
                updateBalanceUI();
            } else {
                tg.showAlert("Неверный промокод!");
            }
            document.getElementById('promo-input').value = '';
        }

        function shareReferral() {
            const uid = tg.initDataUnsafe?.user?.id || 0;
            const link = `https://t.me/StarsDropBot?start=${uid}`;
            const text = "Залетай в StarsDrop! Дают халявные звезды при регистрации!";
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
        }

        function buyStars(amount) {
            tg.showConfirm(`Вы точно хотите пополнить баланс на ${amount} ⭐?`, (ok) => {
                if (ok) {
                    // Имитация депозита
                    let current = parseInt(localStorage.getItem('user_stars')) || 0;
                    localStorage.setItem('user_stars', (current + amount).toString());
                    tg.showAlert("Баланс пополнен!");
                    updateBalanceUI();
                }
            });
        }

        function closeModal() { document.getElementById('item-modal').style.display = 'none'; }

        // АНИМАЦИЯ ЗВЕЗД
        const canvas = document.getElementById('stars-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];

        function initStars() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = Array.from({length: 60}, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                s: Math.random() * 2,
                sp: Math.random() * 0.4 + 0.1,
                o: Math.random()
            }));
        }

        function drawStars() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            stars.forEach(s => {
                ctx.beginPath();
                ctx.globalAlpha = s.o;
                ctx.fillStyle = "#a3e635";
                ctx.arc(s.x, s.y, s.s, 0, Math.PI*2);
                ctx.fill();
                s.y += s.sp;
                if(s.y > canvas.height) s.y = -5;
            });
            requestAnimationFrame(drawStars);
        }

        window.onload = () => {
            if (tg.initDataUnsafe?.user) {
                const u = tg.initDataUnsafe.user;
                document.getElementById('user-name').innerText = (u.username || u.first_name).toUpperCase();
                document.getElementById('user-id').innerText = `ID: ${u.id}`;
                document.getElementById('user-avatar').src = u.photo_url || `https://ui-avatars.com/api/?name=${u.first_name}&background=166534&color=fff`;
            }
            initStars();
            drawStars();
            loadInventory();
            updateBalanceUI();
            tg.expand();
        };

        window.addEventListener('resize', initStars);
    </script>
</body>
</html>
