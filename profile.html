<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>StarsDrop - Profile</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #050208; color: white; font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
        #stars-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .main-wrapper { position: relative; z-index: 1; min-height: 100vh; padding: 24px 20px 120px 20px; background: radial-gradient(circle at 50% 0%, rgba(139, 92, 246, 0.15) 0%, transparent 50%); }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border-radius: 24px; }
        .inventory-slot { aspect-ratio: 1/1; background: rgba(139, 92, 246, 0.05); border: 1px dashed rgba(139, 92, 246, 0.2); border-radius: 18px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .dock-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 6, 15, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-around; padding: 15px 10px 35px 10px; z-index: 100; }
        .dock-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #4b5563; cursor: pointer; }
        .dock-btn.active { color: #8b5cf6; }
    </style>
</head>
<body>
    <canvas id="stars-canvas"></canvas>
    <div class="main-wrapper">
        <div class="flex flex-col items-center mt-10 mb-10">
            <img id="user-avatar" src="" class="w-24 h-24 rounded-full border-2 border-purple-500/50 bg-gray-900 mb-4">
            <h2 id="user-name" class="text-2xl font-black uppercase italic">ЗАГРУЗКА...</h2>
            <p id="user-id" class="text-[10px] text-purple-400 opacity-60 uppercase">ID: 00000000</p>
        </div>

        <div class="glass-card p-6">
            <h3 class="text-xs font-black uppercase tracking-widest text-purple-400 mb-6 text-center">Ваш Инвентарь</h3>
            <div id="inventory-grid" class="grid grid-cols-3 gap-4"></div>
        </div>
    </div>

    <div id="item-modal" class="fixed inset-0 z-[150] hidden items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="glass-card p-8 w-[85%] max-w-[320px] text-center border-purple-500/50">
            <img id="modal-img" src="" class="w-24 h-24 mx-auto mb-6 object-contain">
            <h2 class="text-xl font-black uppercase mb-8">Что сделать?</h2>
            <div class="flex flex-col gap-3">
                <button onclick="handleWithdraw()" class="w-full bg-purple-600 py-4 rounded-xl font-bold uppercase active:scale-95">Вывести</button>
                <button onclick="handleSell()" class="w-full bg-white/10 py-4 rounded-xl font-bold uppercase active:scale-95">Продать за 1 ⭐</button>
                <button onclick="closeModal()" class="w-full py-2 text-gray-500 text-xs uppercase mt-2">Отмена</button>
            </div>
        </div>
    </div>

    <div class="dock-bar">
        <div onclick="window.location.href='index.html'" class="dock-btn"><span>Банк</span></div>
        <div onclick="window.location.href='index.html'" class="dock-btn"><span>Главная</span></div>
        <div class="dock-btn active"><span>Профиль</span></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let selectedIndex = null;

        // Загрузка данных юзера
        if (tg.initDataUnsafe?.user) {
            const u = tg.initDataUnsafe.user;
            document.getElementById('user-name').innerText = (u.username || u.first_name).toUpperCase();
            document.getElementById('user-id').innerText = `ID: ${u.id}`;
            document.getElementById('user-avatar').src = u.photo_url || `https://ui-avatars.com/api/?name=${u.first_name}`;
        }

        function loadInventory() {
            const grid = document.getElementById('inventory-grid');
            const items = JSON.parse(localStorage.getItem('user_inventory')) || [];
            grid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                if (items[i]) {
                    slot.classList.add('cursor-pointer', 'bg-purple-500/10', 'border-purple-500/50');
                    slot.innerHTML = `<img src="${items[i].img}" class="w-12 h-12 object-contain">`;
                    slot.onclick = () => {
                        selectedIndex = i;
                        document.getElementById('modal-img').src = items[i].img;
                        document.getElementById('item-modal').style.display = 'flex';
                    };
                } else {
                    slot.innerHTML = `<span class="text-[8px] text-gray-600 uppercase">Пусто</span>`;
                }
                grid.appendChild(slot);
            }
        }

        function closeModal() { document.getElementById('item-modal').style.display = 'none'; }

        function handleSell() {
            let items = JSON.parse(localStorage.getItem('user_inventory')) || [];
            items.splice(selectedIndex, 1);
            localStorage.setItem('user_inventory', JSON.stringify(items));
            let stars = Number(localStorage.getItem('stars_balance')) || 0;
            localStorage.setItem('stars_balance', stars + 1);
            closeModal(); loadInventory();
            tg.HapticFeedback.notificationOccurred('success');
        }

        function handleWithdraw() {
            const items = JSON.parse(localStorage.getItem('user_inventory')) || [];
            const item = items[selectedIndex];
            // Отправляем данные боту (работает в Keyboard Button)
            tg.sendData(JSON.stringify({ action: 'withdraw', item: item.name }));
            // Оповещение для версии 6.0
            alert("Запрос отправлен боту! Он проверит ваши донаты (мин. 50 звёзд).");
            closeModal();
        }

        // Анимация звезд (упрощенная)
        const canvas = document.getElementById('stars-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            for(let i=0; i<50; i++) stars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2});
        }
        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = "white";
            stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill(); s.y += 0.2; if(s.y > canvas.height) s.y = 0; });
            requestAnimationFrame(draw);
        }
        initStars(); draw(); loadInventory();
    </script>
</body>
</html>
