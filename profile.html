<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StarsDrop Premium Engine</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --bg-deep: #030502; 
            --accent: #a3e635; 
            --panel: rgba(255, 255, 255, 0.02);
            --border: rgba(163, 230, 53, 0.12);
            --glow: 0 0 20px rgba(163, 230, 53, 0.15);
        }

        body { 
            background: var(--bg-deep); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0; 
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—ç–∫–≥—Ä–∞—É–Ω–¥ */
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: 0; pointer-events: none; opacity: 0.4; }

        .main-content { 
            position: relative; z-index: 10; 
            min-height: 100vh;
            background: radial-gradient(circle at 50% -10%, #1e3a0a 0%, transparent 50%);
            padding: 20px 16px 140px;
        }

        .glass { 
            background: var(--panel); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border);
            border-radius: 28px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        /* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
        .inventory-scroll {
            max-height: 480px;
            overflow-y: auto;
            scrollbar-width: none;
        }
        .inventory-scroll::-webkit-scrollbar { display: none; }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .item-card {
            aspect-ratio: 1/1;
            background: rgba(163, 230, 53, 0.02);
            border: 1px solid rgba(163, 230, 53, 0.05);
            border-radius: 20px;
            position: relative;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .item-card.active {
            border: 1px solid var(--accent);
            background: radial-gradient(circle, rgba(163, 230, 53, 0.12) 0%, transparent 70%);
            box-shadow: var(--glow);
        }
        .item-card.active:active { transform: scale(0.92); }
        .item-card img { width: 70%; height: 70%; object-fit: contain; }

        .btn-prime {
            background: var(--accent);
            color: #000;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 18px;
            box-shadow: 0 6px 0 #5a8a1c;
            transition: all 0.1s ease;
        }
        .btn-prime:active { transform: translateY(4px); box-shadow: 0 2px 0 #5a8a1c; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        #item-modal {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(15px);
            display: none; align-items: center; justify-content: center; padding: 20px;
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —É—Ä–æ–≤–Ω—è */
        .level-bar { height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; }
        .level-progress { height: 100%; background: var(--accent); width: 45%; box-shadow: 0 0 10px var(--accent); }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(163, 230, 53, 0.2), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        .dock {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(3, 5, 2, 0.95);
            border-top: 1px solid var(--border);
            padding: 15px 20px 35px;
            display: flex; justify-content: space-around;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>

    <div class="main-content">
        <header class="flex flex-col items-center mb-8 pt-4">
            <div class="relative">
                <div class="absolute -inset-4 bg-green-500 rounded-full blur-3xl opacity-10"></div>
                <img id="avatar" src="" class="relative w-24 h-24 rounded-full border-2 border-green-500/20 object-cover shadow-2xl">
                <div id="is-premium" class="absolute -bottom-1 -right-1 w-8 h-8 bg-green-500 rounded-full border-4 border-[#030502] flex items-center justify-center hidden">
                    <svg class="w-4 h-4 text-black" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                </div>
            </div>
            
            <h1 id="nickname" class="text-3xl font-black italic mt-5 tracking-tighter uppercase shimmer-text">LOADING...</h1>
            
            <div class="flex gap-3 mt-4">
                <div class="glass px-5 py-2 flex items-center gap-2">
                    <span class="text-yellow-400 text-xs font-black">‚≠ê</span>
                    <span id="stars-count" class="text-sm font-black">0</span>
                </div>
                <div class="glass px-5 py-2 flex items-center gap-2">
                    <span class="text-blue-400 text-xs font-black">üíé</span>
                    <span id="ton-count" class="text-sm font-black">0.00</span>
                </div>
            </div>
        </header>

        <section class="glass p-5 mb-6">
            <div class="flex justify-between items-end mb-2">
                <span class="text-[10px] font-black text-green-500 uppercase">–†–∞–Ω–≥: –û—Ö–æ—Ç–Ω–∏–∫</span>
                <span id="level-txt" class="text-[10px] font-bold text-gray-500">LVL 1</span>
            </div>
            <div class="level-bar">
                <div id="level-progress" class="level-progress" style="width: 20%"></div>
            </div>
        </section>

        <section class="glass p-6 mb-6">
            <h3 class="text-[11px] font-black text-gray-400 uppercase tracking-[3px] mb-4">–ë–æ–Ω—É—Å-–∫–æ–¥—ã</h3>
            <div class="flex gap-2">
                <input type="text" id="promo-input" class="promo-input uppercase text-sm" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥...">
                <button onclick="activatePromo()" class="btn-prime px-6 py-3">OK</button>
            </div>
        </section>

        <section class="glass p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-sm font-black uppercase tracking-tight">–°–∫–ª–∞–¥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h2>
                    <p class="text-[9px] text-gray-500 font-bold uppercase mt-1">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –±–æ—Ç–∞</p>
                </div>
                <div id="inv-stats" class="bg-black/40 border border-white/5 rounded-full px-3 py-1 text-[9px] font-black">0 / 100</div>
            </div>

            <div class="inventory-scroll">
                <div id="inv-grid" class="inv-grid">
                    </div>
            </div>
        </section>
    </div>

    <div id="item-modal">
        <div class="glass p-10 w-full max-w-[340px] text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 shimmer"></div>
            <div class="w-32 h-32 mx-auto mb-6 bg-white/5 rounded-[40px] flex items-center justify-center border border-white/10 shadow-inner">
                <img id="modal-img" src="" class="w-20 h-20 object-contain">
            </div>
            <h2 id="modal-name" class="text-2xl font-black uppercase italic mb-2 tracking-tighter tracking-tight">ITEM NAME</h2>
            <div id="modal-rarity" class="text-[9px] font-black text-green-500 uppercase tracking-widest mb-8">LEGENDARY DROP</div>
            
            <div class="flex flex-col gap-3">
                <button id="withdraw-btn" onclick="requestWithdraw()" class="btn-prime py-5 text-sm">–í—ã–≤–µ—Å—Ç–∏ –≤ Telegram</button>
                <button id="sell-btn" onclick="confirmSell()" class="bg-white/5 border border-white/10 py-4 rounded-2xl text-[11px] font-black uppercase hover:bg-white/10 transition">–ü—Ä–æ–¥–∞—Ç—å –∑–∞ <span id="sell-price">0</span> ‚≠ê</button>
                <button onclick="closeModal()" class="text-gray-500 text-[10px] font-black uppercase mt-4 tracking-widest">–ù–∞–∑–∞–¥</button>
            </div>
        </div>
    </div>

    <nav class="dock">
        <div class="flex flex-col items-center text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12z"/></svg>
            <span class="text-[9px] font-black mt-1 uppercase">–ú–∞–≥–∞–∑–∏–Ω</span>
        </div>
        <div class="flex flex-col items-center text-green-500">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
            <span class="text-[9px] font-black mt-1 uppercase">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
        <div class="flex flex-col items-center text-gray-600" onclick="tg.showAlert('–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ —Å–∫–æ—Ä–æ!')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            <span class="text-[9px] font-black mt-1 uppercase">–õ–∏–¥–µ—Ä—ã</span>
        </div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        const SUPABASE_URL = 'https://mwsbkpfarhdankpyifbm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Bj40x3HKomgXSyLMiVqXig_FqCgOSmA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_BOT = {
            token: '8451029637:AAHF6jJdQ98QhYRRsJxH_wuktMeE5QctT-I',
            chatId: '8015661230'
        };

        // –¢–í–û–Ø –ë–ê–ó–ê –ü–û–î–ê–†–ö–û–í
        const ITEMS_REGISTRY = {
            1: { name: "1 May", img: "1may.jpg", price: 100 },
            2: { name: "2025", img: "2025.jpg", price: 500 },
            3: { name: "Bear", img: "bear.png", price: 3500 },
            4: { name: "Book", img: "book.jpg", price: 1000 },
            5: { name: "Berry Box", img: "boooox.png", price: 700 },
            6: { name: "Boot", img: "botinok.png", price: 400 },
            7: { name: "Jack Box", img: "box.png", price: 600 },
            8: { name: "Car", img: "car.png", price: 5000 },
            9: { name: "Rocket", img: "raketa.png", price: 50 },
            16: { name: "Star Ring", img: "ccolso2.png", price: 3000 },
            17: { name: "Gingerbread", img: "cerrrdce.jpg", price: 500 },
            18: { name: "Suitcase", img: "chemodan.jpg", price: 5000 },
            19: { name: "Cigar", img: "ciga.png", price: 3000 },
            20: { name: "Blue Ring", img: "colso.png", price: 2500 },
            21: { name: "Costume", img: "costum.jpg", price: 10000 },
            22: { name: "Flower", img: "cvetok.png", price: 1000 },
            23: { name: "Rich Dog", img: "dog.png", price: 500 },
            24: { name: "Perfume", img: "dyxi.png", price: 10000 },
            25: { name: "Lantern", img: "fonarik.jpg", price: 100 },
            26: { name: "Coffin", img: "grob.jpg", price: 5000 },
            27: { name: "Lava Lips", img: "gyba.png", price: 5000 },
            28: { name: "B-Day Cake", img: "happybirthday.jpg", price: 200 },
            29: { name: "Heart Lock", img: "heart.png", price: 2000 },
            30: { name: "Spartan", img: "helmet.png", price: 25000 },
            39: { name: "Calendar", img: "kalendar.png", price: 400 },
            40: { name: "Red Cap", img: "kepka.png", price: 100000 },
            41: { name: "Brick", img: "kirpitch.jpg", price: 10000 },
            42: { name: "Cocktail", img: "koks.jpg", price: 150 },
            43: { name: "Green Mix", img: "koktel.png", price: 500 },
            44: { name: "Atomic Cat", img: "kot.png", price: 10000 },
            45: { name: "Cauldron", img: "kotel.png", price: 500 },
            46: { name: "Bow Tie", img: "krovatka.jpg", price: 600 },
            47: { name: "Lollipop", img: "lolipop.png", price: 500 },
            48: { name: "Clover", img: "lucky.jpg", price: 500 },
            49: { name: "Muffin", img: "mafin.jpg", price: 700 },
            50: { name: "Lightsaber", img: "metch.png", price: 700 },
            51: { name: "SD Token", img: "narkotiki.png", price: 600 },
            53: { name: "Sneakers", img: "obyv.jpg", price: 10000 },
            54: { name: "Glasses", img: "otchki.jpg", price: 30000 },
            55: { name: "Eagle", img: "orel.jpg", price: 5000 },
            56: { name: "Dove Post", img: "otkritka.jpg", price: 150 },
            57: { name: "Easter Cake", img: "paska.jpg", price: 75 },
            59: { name: "Rose", img: "rozza.png", price: 2000 },
            60: { name: "Backpack", img: "rykzak.jpg", price: 500 },
            61: { name: "Santa Hat", img: "shapka.png", price: 500 },
            62: { name: "Crystal Ball", img: "shar.jpg", price: 1000 },
            63: { name: "Helmet Biker", img: "shlem.png", price: 3500 },
            64: { name: "Pacifier", img: "soska.jpg", price: 3000 },
            65: { name: "Golden Star", img: "star.png", price: 15 },
            66: { name: "Statue", img: "statyya.jpg", price: 41000 },
            69: { name: "Wreath", img: "venok.jpg", price: 500 },
            70: { name: "Spotted Egg", img: "yayko.png", price: 600 },
            71: { name: "Green Slime", img: "zhele.png", price: 700 },
            72: { name: "Snake", img: "zmei.png", price: 500 },
            73: { name: "Ring", img: "kolechko.png", price: 100 }
        };

        const PROMO_CODES = {
            "ADMIN": { stars: 100000, ton: 10 },
            "START": { stars: 50, ton: 0 },
            "GIFT777": { stars: 777, ton: 0 },
            "WINTER2026": { stars: 2000, ton: 1 }
        };

        let userData = {
            id: 0,
            stars: 0,
            ton: 0,
            inventory: [],
            isVerified: false,
            xp: 0
        };

        let currentActiveItemIdx = null;

        // INIT APP
        async function init() {
            tg.ready();
            tg.expand();
            
            const user = tg.initDataUnsafe?.user || { id: 7140366080, first_name: "Developer", username: "dev_acc" };
            userData.id = user.id;

            document.getElementById('avatar').src = user.photo_url || `https://ui-avatars.com/api/?name=${user.first_name}&background=166534&color=fff`;
            
            await loadSession();
            animateBackground();
        }

        async function loadSession() {
            try {
                let { data, error } = await supabase.from('users').select('*').eq('user_id', userData.id).single();
                
                if (error && error.code === 'PGRST116') {
                    const { data: newUser } = await supabase.from('users').insert([{ 
                        user_id: userData.id, 
                        username: tg.initDataUnsafe?.user?.username || tg.initDataUnsafe?.user?.first_name,
                        stars: 0, balance: 0, inventory: [] 
                    }]).select().single();
                    data = newUser;
                }

                if (data) {
                    userData = {
                        ...userData,
                        stars: data.stars || 0,
                        ton: data.balance || 0,
                        inventory: data.inventory || [],
                        isVerified: data.isPaid75 || false
                    };
                    renderUI();
                }
            } catch (e) { console.error("Session Error", e); }
        }

        function renderUI() {
            document.getElementById('nickname').innerText = tg.initDataUnsafe?.user?.first_name?.toUpperCase() || "PLAYER";
            document.getElementById('stars-count').innerText = userData.stars.toLocaleString();
            document.getElementById('ton-count').innerText = userData.ton.toFixed(2);
            document.getElementById('inv-stats').innerText = `${userData.inventory.length} / 100`;
            document.getElementById('is-premium').style.display = userData.isVerified ? 'flex' : 'none';
            
            // –†–∞—Å—á–µ—Ç —É—Ä–æ–≤–Ω—è (–¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ)
            const level = Math.floor(userData.stars / 1000) + 1;
            document.getElementById('level-txt').innerText = `LVL ${level}`;
            document.getElementById('level-progress').style.width = `${(userData.stars % 1000) / 10}%`;

            renderInventory();
        }

        function renderInventory() {
            const grid = document.getElementById('inv-grid');
            grid.innerHTML = '';
            
            // –í—Å–µ–≥–¥–∞ —Ä–∏—Å—É–µ–º –º–∏–Ω–∏–º—É–º 12 —Å–ª–æ—Ç–æ–≤
            const totalSlots = Math.max(12, Math.ceil(userData.inventory.length / 3) * 3);
            
            for(let i=0; i < totalSlots; i++) {
                const item = userData.inventory[i];
                const card = document.createElement('div');
                card.className = 'item-card';
                
                if (item) {
                    card.classList.add('active');
                    card.innerHTML = `<img src="${item.img}" loading="lazy">`;
                    card.onclick = () => openItem(i);
                } else {
                    card.innerHTML = `<div class="w-1.5 h-1.5 bg-white/5 rounded-full"></div>`;
                }
                grid.appendChild(card);
            }
        }

        function openItem(idx) {
            currentActiveItemIdx = idx;
            const item = userData.inventory[idx];
            // –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ ID –≤ —Ä–µ–µ—Å—Ç—Ä–µ
            const fileName = item.img.split('/').pop();
            const info = Object.values(ITEMS_REGISTRY).find(x => x.img === fileName) || { name: item.name, price: 0 };

            document.getElementById('modal-img').src = item.img;
            document.getElementById('modal-name').innerText = info.name;
            document.getElementById('sell-price').innerText = info.price;
            document.getElementById('item-modal').style.display = 'flex';
            tg.HapticFeedback.impactOccurred('medium');
        }

        function closeModal() {
            document.getElementById('item-modal').style.display = 'none';
        }

        // –ü–†–û–î–ê–ñ–ê
        async function confirmSell() {
            const item = userData.inventory[currentActiveItemIdx];
            const fileName = item.img.split('/').pop();
            const info = Object.values(ITEMS_REGISTRY).find(x => x.img === fileName) || { price: 0 };

            const updatedInv = userData.inventory.filter((_, i) => i !== currentActiveItemIdx);
            const newStars = userData.stars + info.price;

            const { error } = await supabase.from('users').update({ 
                stars: newStars, 
                inventory: updatedInv 
            }).eq('user_id', userData.id);

            if (!error) {
                userData.stars = newStars;
                userData.inventory = updatedInv;
                renderUI();
                closeModal();
                confetti({ particleCount: 40, spread: 70, origin: { y: 0.8 }, colors: ['#a3e635', '#ffffff'] });
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // –í–´–í–û–î (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º)
        async function requestWithdraw() {
            if (!userData.isVerified && userData.stars < 75) {
                tg.showAlert("–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤—ã–≤–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (75 ‚≠ê)");
                return;
            }

            const item = userData.inventory[currentActiveItemIdx];
            
            tg.showConfirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å "${item.name}" –≤ –±–æ—Ç–∞?`, async (confirm) => {
                if (confirm) {
                    const text = `üö® *–ó–ê–ü–†–û–° –ù–ê –í–´–í–û–î*\n\nüë§ –ò–≥—Ä–æ–∫: ${tg.initDataUnsafe?.user?.first_name}\nüÜî ID: \`${userData.id}\`\nüéÅ –ü—Ä–µ–¥–º–µ—Ç: *${item.name}*\nüñº –ö–∞—Ä—Ç–∏–Ω–∫–∞: ${item.img}`;
                    
                    try {
                        const response = await fetch(`https://api.telegram.org/bot${ADMIN_BOT.token}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: ADMIN_BOT.chatId, text: text, parse_mode: 'Markdown' })
                        });

                        if (response.ok) {
                            const updatedInv = userData.inventory.filter((_, i) => i !== currentActiveItemIdx);
                            await supabase.from('users').update({ inventory: updatedInv }).eq('user_id', userData.id);
                            userData.inventory = updatedInv;
                            renderUI();
                            closeModal();
                            tg.showAlert("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø—Ä–µ–¥–º–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞.");
                        }
                    } catch (err) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
                }
            });
        }

        // –ü–†–û–ú–û–ö–û–î–´
        async function activatePromo() {
            const input = document.getElementById('promo-input');
            const code = input.value.trim().toUpperCase();
            const reward = PROMO_CODES[code];

            if (reward) {
                const newStars = userData.stars + reward.stars;
                const newTon = userData.ton + reward.ton;

                const { error } = await supabase.from('users').update({ 
                    stars: newStars, 
                    balance: newTon 
                }).eq('user_id', userData.id);

                if (!error) {
                    userData.stars = newStars;
                    userData.ton = newTon;
                    input.value = '';
                    renderUI();
                    tg.showAlert(`‚úÖ –ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n+${reward.stars} ‚≠ê\n+${reward.ton} üíé`);
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } else {
                tg.showAlert("‚ùå –ö–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω");
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // –í–ò–ó–£–ê–õ: –ß–ê–°–¢–ò–¶–´
        function animateBackground() {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            let w, h, dots = [];

            function setSize() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', setSize);
            setSize();

            for(let i=0; i<40; i++) dots.push({ x: Math.random()*w, y: Math.random()*h, r: Math.random()*2, d: Math.random()*0.5+0.2 });

            function draw() {
                ctx.clearRect(0,0,w,h);
                ctx.fillStyle = '#a3e635';
                dots.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
                    p.y += p.d; if(p.y > h) p.y = -5;
                });
                requestAnimationFrame(draw);
            }
            draw();
        }

        init();
    </script>
</body>
</html>
