<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StarsDrop - Profile Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --accent-green: #a3e635; --dark-green: #166534; }
        body { background: #0a1205; color: white; font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; touch-action: pan-y; -webkit-user-select: none; user-select: none; overscroll-behavior-y: none; }
        .main-wrapper { position: relative; z-index: 1; min-height: 100vh; padding: 24px 20px 140px 20px; background: radial-gradient(circle at 50% 30%, #5d9e1c 0%, #0a1205 80%); }
        .glass-card { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(163, 230, 53, 0.2); backdrop-filter: blur(15px); border-radius: 28px; }
        .inventory-slot { aspect-ratio: 1/1; background: rgba(163, 230, 53, 0.05); border: 1px dashed rgba(163, 230, 53, 0.3); border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; transition: 0.3s; }
        .inventory-slot.active-item { background: rgba(163, 230, 53, 0.1); border: 1px solid var(--accent-green); }
        .btn-green { background: var(--accent-green); color: black; font-weight: 900; text-transform: uppercase; border-radius: 18px; transition: 0.3s; }
        .dock-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(5, 10, 3, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(163, 230, 53, 0.1); display: flex; justify-content: space-around; padding: 15px 10px 35px 10px; z-index: 100; }
        .dock-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #4b5563; cursor: pointer; }
        .dock-btn.active { color: var(--accent-green); }
        .ref-box { background: rgba(163, 230, 53, 0.1); border-radius: 20px; padding: 15px; border: 1px solid rgba(163, 230, 53, 0.2); }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="flex flex-col items-center mt-6 mb-8">
            <div class="relative">
                <img id="user-avatar" src="" class="w-28 h-28 rounded-full border-4 border-green-500/30 bg-gray-900 shadow-2xl">
                <div class="absolute bottom-1 right-1 w-6 h-6 bg-green-500 border-4 border-[#0a1205] rounded-full"></div>
            </div>
            <h2 id="user-name" class="text-3xl font-black uppercase italic mt-4 tracking-tighter">ЗАГРУЗКА...</h2>
            <div class="flex items-center gap-2 mt-1">
                <span id="user-stars-display" class="text-[12px] bg-yellow-500/20 text-yellow-400 px-3 py-1 rounded-full font-black">⭐ 0</span>
                <span id="user-id" class="text-[10px] bg-green-500/20 text-green-400 px-3 py-1 rounded-full font-bold uppercase">ID: 000000</span>
            </div>
        </div>

        <div class="glass-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xs font-black uppercase tracking-widest text-green-400">Реферальная система</h3>
            </div>
            <div class="ref-box flex items-center justify-between gap-3">
                <code class="text-[11px] text-green-200 truncate" id="ref-link">ЗАГРУЗКА...</code>
                <button onclick="copyRef()" class="btn-green px-4 py-2 text-[10px]">Копия</button>
            </div>
        </div>

        <div class="glass-card p-6">
            <h3 class="text-xs font-black uppercase tracking-widest text-green-400 mb-6">Ваш Инвентарь <span id="item-count" class="text-gray-500 ml-2">0/6</span></h3>
            <div id="inventory-grid" class="grid grid-cols-3 gap-4"></div>
        </div>
    </div>

    <div id="item-modal" class="fixed inset-0 z-[150] hidden items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="glass-card p-8 w-[85%] max-w-[320px] text-center border-green-500/50">
            <img id="modal-img" src="" class="w-24 h-24 mx-auto mb-6 object-contain">
            <h2 id="modal-title" class="text-xl font-black uppercase mb-8 tracking-tighter">ПРЕДМЕТ</h2>
            <div class="flex flex-col gap-3">
                <button onclick="handleWithdraw()" class="w-full btn-green py-4 shadow-lg">Вывести в бот</button>
                <button id="modal-sell-btn" onclick="handleSell()" class="w-full bg-white/5 border border-white/10 py-4 rounded-xl font-bold uppercase text-xs">ПРОДАТЬ</button>
                <button onclick="closeModal()" class="w-full py-2 text-gray-500 text-[10px] font-black uppercase">Отмена</button>
            </div>
        </div>
    </div>

    <div class="dock-bar">
        <div onclick="window.location.href='index.html'" class="dock-btn"><span>Депозит</span></div>
        <div onclick="window.location.href='index.html'" class="dock-btn"><span>Главная</span></div>
        <div class="dock-btn active"><span>Профиль</span></div>
    </div>

    <script>
    const tg = window.Telegram.WebApp;
    let selectedIndex = null;

    // ОБЯЗАТЕЛЬНО: ТА ЖЕ БАЗА ЧТО В РУЛЕТКЕ
    const GLOBAL_ITEMS = {
        65: { name: "1 Звезда", price: 1 },
        23: { name: "Rich Dog", price: 500 },
        7: { name: "Jack Box", price: 600 },
        3: { name: "Bear", price: 3500 },
        27: { name: "Lava Lips", price: 5000 },
        44: { name: "Atomic Cat", price: 10000 }
    };

    function loadInventory() {
        const grid = document.getElementById('inventory-grid');
        const items = JSON.parse(localStorage.getItem('user_inventory')) || [];
        const stars = localStorage.getItem('user_stars') || "0";
        
        document.getElementById('user-stars-display').innerText = `⭐ ${stars}`;
        document.getElementById('item-count').innerText = `${items.length} / 6`;
        grid.innerHTML = '';

        for (let i = 0; i < 6; i++) {
            const slot = document.createElement('div');
            slot.className = 'inventory-slot';
            if (items[i]) {
                slot.classList.add('active-item', 'cursor-pointer');
                slot.innerHTML = `<img src="${items[i].img}" class="w-12 h-12 object-contain">`;
                slot.onclick = () => {
                    selectedIndex = i;
                    const itemData = GLOBAL_ITEMS[items[i].id] || { name: items[i].name, price: 1 };
                    document.getElementById('modal-img').src = items[i].img;
                    document.getElementById('modal-title').innerText = itemData.name;
                    document.getElementById('modal-sell-btn').innerText = `ПРОДАТЬ ЗА ${itemData.price} ⭐`;
                    document.getElementById('item-modal').style.display = 'flex';
                };
            } else {
                slot.innerHTML = `<span class="text-[8px] text-green-900 font-black uppercase">Пусто</span>`;
            }
            grid.appendChild(slot);
        }
    }

    async function handleSell() {
        let items = JSON.parse(localStorage.getItem('user_inventory')) || [];
        const item = items[selectedIndex];
        const price = GLOBAL_ITEMS[item.id]?.price || 1;

        // 1. Плюсуем баланс локально
        let s = parseInt(localStorage.getItem('user_stars')) || 0;
        localStorage.setItem('user_stars', (s + price).toString());

        // 2. Отправляем на сервер (если есть API)
        if (tg.initDataUnsafe?.user) {
            try {
                await fetch('https://stars-drop.vercel.app/api/update_balance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id, stars: price })
                });
            } catch(e) {}
        }

        // 3. Удаляем из сумки
        items.splice(selectedIndex, 1);
        localStorage.setItem('user_inventory', JSON.stringify(items));
        
        closeModal();
        loadInventory();
        tg.HapticFeedback.notificationOccurred('success');
    }

    function closeModal() { document.getElementById('item-modal').style.display = 'none'; }
    function copyRef() {
        const link = document.getElementById('ref-link').innerText;
        navigator.clipboard.writeText(link);
        tg.showPopup({ message: "Ссылка скопирована!" });
    }

    window.onload = () => {
        if (tg.initDataUnsafe?.user) {
            const u = tg.initDataUnsafe.user;
            document.getElementById('user-name').innerText = (u.username || u.first_name).toUpperCase();
            document.getElementById('user-id').innerText = `ID: ${u.id}`;
            document.getElementById('user-avatar').src = u.photo_url || `https://ui-avatars.com/api/?name=${u.first_name}`;
            document.getElementById('ref-link').innerText = `t.me/starsdrop_bot?start=${u.id}`;
        }
        loadInventory();
    };
    </script>
</body>
</html>
