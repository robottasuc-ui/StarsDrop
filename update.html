<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StarDrop Upgrade Cloud</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
        body { background: #050a04; color: white; font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; }
        .wheel-container { width: 210px; height: 210px; border-radius: 50%; background: #000; border: 4px solid #1a2e0a; margin: 10px auto; position: relative; display: flex; align-items: center; justify-content: center; }
        #wheel-progress { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(#a3e635 0deg, #000 0deg); opacity: 0.7; }
        #pointer-wrapper { position: absolute; inset: -15px; z-index: 30; transition: transform 3.5s cubic-bezier(0.15, 0, 0.15, 1); }
        #pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 35px; background: #fff; border-radius: 10px; box-shadow: 0 0 15px #fff; }
        .scroll-area { height: 200px; overflow-y: auto; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 8px; border: 1px solid rgba(163,230,53,0.1); }
        .item-card { display: flex; align-items: center; gap: 8px; padding: 8px; margin-bottom: 6px; border-radius: 10px; background: rgba(255,255,255,0.04); border: 2px solid transparent; cursor: pointer; transition: 0.2s; }
        .item-card.active { border-color: #a3e635; background: rgba(163, 230, 53, 0.1); }
        .slot { width: 100%; height: 70px; background: rgba(255,255,255,0.03); border: 1px solid rgba(163,230,53,0.2); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-main { background: #a3e635; color: #000; font-weight: 900; text-transform: uppercase; width: 100%; padding: 16px; border-radius: 20px; box-shadow: 0 0 20px rgba(163, 230, 53, 0.3); }
        .btn-main:disabled { background: #1a2e0a; color: #3e5c1e; opacity: 0.6; }
        #res-msg { position: absolute; font-size: 28px; font-weight: 900; z-index: 40; display: none; text-shadow: 0 0 20px #000; text-align: center; width: 100%; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #a3e635; }
    </style>
</head>
<body class="p-4">

    <div class="flex justify-between items-center mb-2">
        <button onclick="window.history.back()" class="text-[10px] font-black opacity-40 uppercase">← Назад</button>
        <div id="status" class="text-[8px] font-black text-white opacity-50 uppercase">Connecting...</div>
    </div>

    <div class="wheel-container">
        <div id="wheel-progress"></div>
        <div id="pointer-wrapper"><div id="pointer"></div></div>
        <div id="res-msg"></div>
        <div id="center-ui" class="relative z-10 text-center">
            <img id="view-target" src="" class="w-24 h-24 object-contain hidden mx-auto">
            <div id="view-empty" class="text-6xl font-black opacity-10 uppercase">UP</div>
        </div>
    </div>

    <div id="info-chance" class="text-center text-[#a3e635] font-black text-[11px] mb-3 uppercase italic">Загрузка данных...</div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="slot" id="slot-1">
            <img id="img-1" src="" class="w-10 h-10 object-contain hidden">
            <div class="text-[7px] font-black opacity-30 mt-1 uppercase">Инвентарь</div>
        </div>
        <div class="slot" id="slot-2">
            <img id="img-2" src="" class="w-10 h-10 object-contain hidden">
            <div class="text-[7px] font-black opacity-30 mt-1 uppercase">Цель</div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
        <div>
            <h3 class="text-[9px] font-black uppercase mb-2 opacity-40 text-center text-[#a3e635]">Твой шмот</h3>
            <div id="mine-list" class="scroll-area"></div>
        </div>
        <div>
            <h3 class="text-[9px] font-black uppercase mb-2 opacity-40 text-center">Магазин</h3>
            <div id="target-list" class="scroll-area"></div>
        </div>
    </div>

    <button id="upg-btn" onclick="startUpgrade()" class="btn-main mt-4" disabled>Апгрейд</button>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- КОНФИГУРАЦИЯ SUPABASE ---
    const SUPABASE_URL = 'https://mwsbkpfarhdankpyifbm.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_Bj40x3HKomgXSyLMiVqXig_FqCgOSmA';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // БАЗА ДАННЫХ ПРЕДМЕТОВ (названия и цены)
    const SHOP_ITEMS = [
        { name: "1 May", img: "1may.jpg", price: 100 },
        { name: "Bear", img: "bear.png", price: 3500 },
        { name: "Book", img: "book.jpg", price: 1000 },
        { name: "Berry Box", img: "boooox.png", price: 700 },
        { name: "Boot", img: "botinok.png", price: 400 },
        { name: "Jack Box", img: "box.png", price: 600 },
        { name: "Car", img: "car.png", price: 5000 },
        { name: "Star Ring", img: "ccolso2.png", price: 3000 },
        { name: "Gingerbread", img: "cerrrdce.jpg", price: 500 },
        { name: "Suitcase", img: "chemodan.jpg", price: 5000 },
        { name: "Cigar", img: "ciga.png", price: 3000 },
        { name: "Blue Ring", img: "colso.png", price: 2500 },
        { name: "Costume", img: "costum.jpg", price: 10000 },
        { name: "Flower", img: "cvetok.png", price: 1000 },
        { name: "Rich Dog", img: "dog.png", price: 500 },
        { name: "Perfume", img: "dyxi.png", price: 10000 },
        { name: "Lantern", img: "fonarik.jpg", price: 100 },
        { name: "Coffin", img: "grob.jpg", price: 5000 },
        { name: "Lava Lips", img: "gyba.png", price: 5000 },
        { name: "B-Day Cake", img: "happybirthday.jpg", price: 200 },
        { name: "Heart Lock", img: "heart.png", price: 2000 },
        { name: "Spartan", img: "helmet.png", price: 25000 },
        { name: "Red Cap", img: "kepka.png", price: 100000 },
        { name: "Brick", img: "kirpitch.jpg", price: 10000 },
        { name: "Lightsaber", img: "metch.png", price: 700 },
        { name: "Sneakers", img: "obyv.jpg", price: 10000 },
        { name: "Glasses", img: "ochki.jpg", price: 30000 },
        { name: "Eagle", img: "orel.jpg", price: 5000 },
        { name: "Rose", img: "rozza.png", price: 2000 },
        { name: "Helmet Biker", img: "shlem.png", price: 3500 },
        { name: "Statue", img: "statyya.jpg", price: 41000 },
        { name: "Snake", img: "zmei.png", price: 500 }
    ];

    let userInventory = [];
    let selectedMine = null;
    let selectedTarget = null;
    const userId = tg.initDataUnsafe?.user?.id || 12345678; // 12345678 для теста в браузере

    function fixPath(p) { return p.startsWith('img/') ? p : 'img/' + p; }

    async function init() {
        document.getElementById('status').innerText = "DB FETCHING...";
        const { data, error } = await _supabase
            .from('users')
            .select('inventory')
            .eq('user_id', userId)
            .single();

        if (error) {
            console.error("DB Error:", error);
            document.getElementById('status').innerText = "ERROR DB";
        } else {
            userInventory = Array.isArray(data.inventory) ? data.inventory : [];
            document.getElementById('status').innerText = "CONNECTED";
            render();
        }
    }

    function render() {
        const mList = document.getElementById('mine-list');
        const tList = document.getElementById('target-list');

        mList.innerHTML = userInventory.map((it, i) => `
            <div class="item-card ${selectedMine?.idx === i ? 'active' : ''}" onclick="selMine(${i},'${it.img}',${it.price || 0},'${it.name}')">
                <img src="${fixPath(it.img)}" class="w-8 h-8 object-contain">
                <div class="text-[8px] font-black truncate">${it.name}</div>
            </div>`).join('');

        tList.innerHTML = SHOP_ITEMS
            .filter(it => !selectedMine || it.price > selectedMine.price)
            .sort((a,b) => a.price - b.price)
            .map(it => `
                <div class="item-card ${selectedTarget?.name === it.name ? 'active' : ''}" onclick="selTarget('${it.img}',${it.price},'${it.name}')">
                    <img src="${fixPath(it.img)}" class="w-8 h-8 object-contain">
                    <div class="text-[8px] font-black truncate">${it.name}</div>
                </div>`).join('');
        
        updateUI();
    }

    function selMine(idx, img, price, name) {
        selectedMine = {idx, img, price, name};
        document.getElementById('img-1').src = fixPath(img);
        document.getElementById('img-1').classList.remove('hidden');
        selectedTarget = null; render();
    }

    function selTarget(img, price, name) {
        selectedTarget = {img, price, name};
        document.getElementById('img-2').src = fixPath(img);
        document.getElementById('img-2').classList.remove('hidden');
        document.getElementById('view-target').src = fixPath(img);
        document.getElementById('view-target').classList.remove('hidden');
        document.getElementById('view-empty').classList.add('hidden');
        render();
    }

    function updateUI() {
        const btn = document.getElementById('upg-btn');
        const info = document.getElementById('info-chance');
        const wheel = document.getElementById('wheel-progress');
        
        if(selectedMine && selectedTarget) {
            let chance = (selectedMine.price / selectedTarget.price) * 100;
            if (selectedMine.price === 0) chance = 5; // Если цена не указана
            chance = Math.min(Math.max(chance, 1), 80);
            
            info.innerText = `ШАНС: ${chance.toFixed(1)}%`;
            wheel.style.background = `conic-gradient(#a3e635 ${chance * 3.6}deg, #000 0deg)`;
            btn.disabled = false;
        } else {
            btn.disabled = true;
            info.innerText = "ВЫБЕРИТЕ ПРЕДМЕТЫ";
        }
    }

    async function startUpgrade() {
        const btn = document.getElementById('upg-btn');
        const pointer = document.getElementById('pointer-wrapper');
        const resMsg = document.getElementById('res-msg');
        
        btn.disabled = true;
        
        let chance = Math.min((selectedMine.price / selectedTarget.price) * 100, 80);
        if (selectedMine.price === 0) chance = 5;

        const isWin = (Math.random() * 100) <= chance;
        const spins = 1800; // 5 оборотов
        const winDeg = chance * 3.6;
        const finalDeg = isWin ? (spins + Math.random() * winDeg) : (spins + winDeg + Math.random() * (360 - winDeg));

        pointer.style.transform = `rotate(${finalDeg}deg)`;
        tg.HapticFeedback.impactOccurred('medium');

        setTimeout(async () => {
            let newInv = [...userInventory];
            if (isWin) {
                resMsg.innerText = "УСПЕХ!";
                resMsg.style.color = "#a3e635";
                newInv[selectedMine.idx] = { 
                    name: selectedTarget.name, 
                    img: fixPath(selectedTarget.img), 
                    price: selectedTarget.price 
                };
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                resMsg.innerText = "ПРОВАЛ";
                resMsg.style.color = "#ff4d4d";
                newInv.splice(selectedMine.idx, 1);
                tg.HapticFeedback.notificationOccurred('error');
            }

            resMsg.style.display = "block";
            document.getElementById('center-ui').style.opacity = "0.2";

            // СОХРАНЕНИЕ В SUPABASE
            const { error } = await _supabase
                .from('users')
                .update({ inventory: newInv })
                .eq('user_id', userId);

            if (error) console.error("Update Error:", error);

            setTimeout(() => location.reload(), 2000);
        }, 3600);
    }

    init();
</script>
</body>
</html>
