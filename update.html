<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StarDrop Smart Upgrade</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
        body { background: #050a04; color: white; font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; }
        .wheel-container { width: 200px; height: 200px; border-radius: 50%; background: #000; border: 4px solid #1a2e0a; margin: 10px auto; position: relative; display: flex; align-items: center; justify-content: center; }
        #wheel-progress { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(#a3e635 0deg, #000 0deg); opacity: 0.7; }
        #pointer-wrapper { position: absolute; inset: -15px; z-index: 30; transition: transform 3.5s cubic-bezier(0.15, 0, 0.15, 1); }
        #pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 30px; background: #fff; border-radius: 10px; box-shadow: 0 0 15px #fff; }
        .scroll-area { height: 210px; overflow-y: auto; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 8px; border: 1px solid rgba(163,230,53,0.1); }
        .item-card { display: flex; align-items: center; gap: 8px; padding: 8px; margin-bottom: 6px; border-radius: 10px; background: rgba(255,255,255,0.04); border: 2px solid transparent; cursor: pointer; }
        .item-card.active { border-color: #a3e635; background: rgba(163, 230, 53, 0.1); }
        .slot { width: 100%; height: 70px; background: rgba(255,255,255,0.03); border: 1px solid rgba(163,230,53,0.2); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-main { background: #a3e635; color: #000; font-weight: 900; text-transform: uppercase; width: 100%; padding: 16px; border-radius: 20px; box-shadow: 0 0 20px rgba(163, 230, 53, 0.3); transition: 0.3s; }
        .btn-main:disabled { background: #1a2e0a; color: #3e5c1e; opacity: 0.6; }
        #res-msg { position: absolute; font-size: 24px; font-weight: 900; z-index: 40; display: none; text-shadow: 0 0 20px #000; text-align: center; width: 100%; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #a3e635; }
    </style>
</head>
<body class="p-4">

    <div class="flex justify-between items-center mb-2">
        <button onclick="window.history.back()" class="text-[10px] font-black opacity-40 uppercase">← Назад</button>
        <div class="text-[10px] font-black text-[#a3e635]">UPGRADE SYSTEM</div>
    </div>

    <div class="wheel-container">
        <div id="wheel-progress"></div>
        <div id="pointer-wrapper"><div id="pointer"></div></div>
        <div id="res-msg"></div>
        <div id="center-ui" class="relative z-10 text-center">
            <img id="view-target" src="" class="w-20 h-20 object-contain hidden mx-auto">
            <div id="view-empty" class="text-5xl font-black opacity-10">?</div>
        </div>
    </div>

    <div id="info-chance" class="text-center text-[#a3e635] font-black text-[10px] mb-3 uppercase italic">Загрузка...</div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="slot" id="slot-1">
            <img id="img-1" src="" class="w-8 h-8 object-contain hidden">
            <div class="text-[7px] font-black opacity-30 mt-1 uppercase">Инвентарь</div>
        </div>
        <div class="slot" id="slot-2">
            <img id="img-2" src="" class="w-8 h-8 object-contain hidden">
            <div class="text-[7px] font-black opacity-30 mt-1 uppercase">Цель</div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
        <div>
            <h3 class="text-[9px] font-black uppercase mb-2 opacity-40 text-center">Твой шмот</h3>
            <div id="mine-list" class="scroll-area"></div>
        </div>
        <div>
            <h3 class="text-[9px] font-black uppercase mb-2 text-[#a3e635] text-center">Апгрейд</h3>
            <div id="target-list" class="scroll-area"></div>
        </div>
    </div>

    <button id="upg-btn" onclick="startUpgrade()" class="btn-main mt-4" disabled>Сделать апгрейд</button>

<script>
    const tg = window.Telegram.WebApp;
    const SUPABASE_URL = 'https://mwsbkpfarhdankpyifbm.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_Bj40x3HKomgXSyLMiVqXig_FqCgOSmA';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const userId = tg.initDataUnsafe?.user?.id || 8015661230;

    const ITEMS_DATA = {
        "1may.jpg": { name: "1 May", price: 100 }, "2025.jpg": { name: "2025", price: 500 },
        "bear.png": { name: "Bear", price: 3500 }, "book.jpg": { name: "Book", price: 1000 },
        "boooox.png": { name: "Berry Box", price: 700 }, "botinok.png": { name: "Boot", price: 400 },
        "box.png": { name: "Jack Box", price: 600 }, "car.png": { name: "Car", price: 5000 },
        "ccolso2.png": { name: "Star Ring", price: 3000 }, "cerrrdce.jpg": { name: "Gingerbread", price: 500 },
        "chemodan.jpg": { name: "Suitcase", price: 5000 }, "ciga.png": { name: "Cigar", price: 3000 },
        "colso.png": { name: "Blue Ring", price: 2500 }, "costum.jpg": { name: "Costume", price: 10000 },
        "cvetok.png": { name: "Flower", price: 1000 }, "dog.png": { name: "Rich Dog", price: 500 },
        "dyxi.png": { name: "Perfume", price: 10000 }, "fonarik.jpg": { name: "Lantern", price: 100 },
        "grob.jpg": { name: "Coffin", price: 5000 }, "gyba.png": { name: "Lava Lips", price: 5000 },
        "happybirthday.jpg": { name: "B-Day Cake", price: 200 }, "heart.png": { name: "Heart Lock", price: 2000 },
        "helmet.png": { name: "Spartan", price: 25000 }, "kepka.png": { name: "Red Cap", price: 100000 },
        "kirpitch.jpg": { name: "Brick", price: 10000 }, "metch.png": { name: "Lightsaber", price: 700 },
        "obyv.jpg": { name: "Sneakers", price: 10000 }, "ochki.jpg": { name: "Glasses", price: 30000 },
        "orel.jpg": { name: "Eagle", price: 5000 }, "rozza.png": { name: "Rose", price: 2000 },
        "shlem.png": { name: "Helmet Biker", price: 3500 }, "statyya.jpg": { name: "Statue", price: 41000 },
        "zmei.png": { name: "Snake", price: 500 }
    };

    let userInventory = [];
    let s1 = null; let s2 = null;

    async function loadFromDB() {
        const { data, error } = await _supabase.from('users').select('inventory').eq('user_id', userId).single();
        if (!error && data?.inventory) {
            userInventory = Array.isArray(data.inventory) ? data.inventory : [];
        }
        document.getElementById('info-chance').innerText = userInventory.length > 0 ? "Выбери шмот для улучшения" : "Инвентарь пуст";
        render();
    }

    function render() {
        const mList = document.getElementById('mine-list');
        const tList = document.getElementById('target-list');

        // Мой шмот
        mList.innerHTML = userInventory.map((it, i) => {
            const imgPath = typeof it === 'string' ? it : it.img;
            const file = imgPath.split('/').pop();
            const info = ITEMS_DATA[file] || { name: "Подарок", price: 0 };
            const src = imgPath.startsWith('img/') ? imgPath : 'img/' + imgPath;
            return `
                <div class="item-card ${s1?.idx === i ? 'active' : ''}" onclick="sel1(${i},'${src}','${info.name}', ${info.price})">
                    <img src="${src}" class="w-8 h-8 object-contain">
                    <div class="flex-1 overflow-hidden">
                        <div class="text-[8px] font-black truncate">${info.name}</div>
                        <div class="text-[6px] opacity-50">${info.price} ⭐</div>
                    </div>
                </div>`;
        }).join('');

        // Список апгрейдов (ТОЛЬКО ДОРОЖЕ, ЧЕМ ВЫБРАННЫЙ)
        tList.innerHTML = Object.entries(ITEMS_DATA)
            .filter(([file, info]) => !s1 || info.price > s1.price) // Фильтр: только если дороже
            .sort((a,b) => a[1].price - b[1].price)
            .map(([file, info]) => `
                <div class="item-card ${s2?.name === info.name ? 'active' : ''}" onclick="sel2('img/${file}','${info.name}', ${info.price})">
                    <img src="img/${file}" class="w-8 h-8 object-contain">
                    <div class="flex-1 overflow-hidden">
                        <div class="text-[8px] font-black truncate">${info.name}</div>
                        <div class="text-[6px] text-[#a3e635]">${info.price} ⭐</div>
                    </div>
                </div>`).join('');
    }

    function sel1(idx, img, name, price) {
        s1 = {idx, img, name, price};
        document.getElementById('img-1').src = img;
        document.getElementById('img-1').classList.remove('hidden');
        s2 = null; // Сбрасываем цель, так как список обновится
        updateUI(); render();
    }

    function sel2(img, name, price) {
        s2 = {img, name, price};
        document.getElementById('img-2').src = img;
        document.getElementById('img-2').classList.remove('hidden');
        document.getElementById('view-target').src = img;
        document.getElementById('view-target').classList.remove('hidden');
        document.getElementById('view-empty').classList.add('hidden');
        updateUI(); render();
    }

    function updateUI() {
        const btn = document.getElementById('upg-btn');
        const info = document.getElementById('info-chance');
        const wheel = document.getElementById('wheel-progress');
        
        if(s1 && s2) {
            // МАТЕМАТИЧЕСКИЙ ШАНС С ПОПРАВКОЙ НА КАЗИНО (0.7)
            let rawChance = (s1.price / s2.price) * 100;
            let riggedChance = Math.min(rawChance * 0.7, 75); // Макс шанс 75%
            
            info.innerText = `Шанс успеха: ${riggedChance.toFixed(1)}%`;
            wheel.style.background = `conic-gradient(#a3e635 ${riggedChance * 3.6}deg, #000 0deg)`;
            btn.disabled = false;
        } else {
            btn.disabled = true;
            wheel.style.background = `conic-gradient(#a3e635 0deg, #000 0deg)`;
            info.innerText = s1 ? "Выбери цель апгрейда" : "Выбери шмот из инвентаря";
        }
    }

    async function startUpgrade() {
        const btn = document.getElementById('upg-btn');
        const pointer = document.getElementById('pointer-wrapper');
        const resMsg = document.getElementById('res-msg');
        btn.disabled = true;

        let rawChance = (s1.price / s2.price) * 100;
        let finalChance = Math.min(rawChance * 0.7, 75);
        
        const isWin = (Math.random() * 100) < finalChance; 
        
        const winDeg = finalChance * 3.6;
        const spins = 360 * 5;
        let finalDeg = isWin ? (spins + Math.random() * (winDeg - 2)) : (spins + winDeg + Math.random() * (358 - winDeg));

        pointer.style.transform = `rotate(${finalDeg}deg)`;
        tg.HapticFeedback.impactOccurred('medium');

        setTimeout(async () => {
            document.getElementById('center-ui').style.opacity = "0";
            resMsg.style.display = "block";

            let newInv = [...userInventory];
            if (isWin) {
                resMsg.innerText = "УСПЕХ"; resMsg.style.color = "#a3e635";
                newInv[s1.idx] = { img: s2.img, name: s2.name };
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                resMsg.innerText = "ПРОВАЛ"; resMsg.style.color = "#ff4d4d";
                newInv.splice(s1.idx, 1);
                tg.HapticFeedback.notificationOccurred('error');
            }

            await _supabase.from('users').update({ inventory: newInv }).eq('user_id', userId);
            setTimeout(() => location.reload(), 2000);
        }, 3600);
    }

    window.onload = () => { tg.expand(); loadFromDB(); };
</script>
</body>
</html>
