<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StarDrop Upgrade Fix</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
        body { background: #050a04; color: white; font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; }
        .wheel-container { width: 200px; height: 200px; border-radius: 50%; background: #000; border: 4px solid #1a2e0a; margin: 10px auto; position: relative; display: flex; align-items: center; justify-content: center; }
        #wheel-progress { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(#a3e635 0deg, #000 0deg); opacity: 0.7; }
        #pointer-wrapper { position: absolute; inset: -15px; z-index: 30; transition: transform 3.5s cubic-bezier(0.15, 0, 0.15, 1); }
        #pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 30px; background: #fff; border-radius: 10px; box-shadow: 0 0 15px #fff; }
        .scroll-area { height: 210px; overflow-y: auto; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 8px; border: 1px solid rgba(163,230,53,0.1); }
        .item-card { display: flex; align-items: center; gap: 8px; padding: 8px; margin-bottom: 6px; border-radius: 10px; background: rgba(255,255,255,0.04); border: 2px solid transparent; cursor: pointer; }
        .item-card.active { border-color: #a3e635; background: rgba(163, 230, 53, 0.1); }
        .slot { width: 100%; height: 70px; background: rgba(255,255,255,0.03); border: 1px solid rgba(163,230,53,0.2); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-main { background: #a3e635; color: #000; font-weight: 900; text-transform: uppercase; width: 100%; padding: 16px; border-radius: 20px; box-shadow: 0 0 20px rgba(163, 230, 53, 0.3); transition: 0.3s; }
        .btn-main:disabled { background: #1a2e0a; color: #3e5c1e; opacity: 0.6; }
        #res-msg { position: absolute; font-size: 24px; font-weight: 900; z-index: 40; display: none; text-shadow: 0 0 20px #000; text-align: center; width: 100%; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #a3e635; }
    </style>
</head>
<body class="p-4">

    <div class="flex justify-between items-center mb-2">
        <button onclick="window.history.back()" class="text-[10px] font-black opacity-40 uppercase">← Назад</button>
        <div class="text-[10px] font-black text-[#a3e635]">UPGRADE SYSTEM</div>
    </div>

    <div class="wheel-container">
        <div id="wheel-progress"></div>
        <div id="pointer-wrapper"><div id="pointer"></div></div>
        <div id="res-msg"></div>
        <div id="center-ui" class="relative z-10 text-center">
            <img id="view-target" src="" class="w-20 h-20 object-contain hidden mx-auto">
            <div id="view-empty" class="text-5xl font-black opacity-10">?</div>
        </div>
    </div>

    <div id="info-chance" class="text-center text-[#a3e635] font-black text-[10px] mb-3 uppercase italic">Выберите предметы</div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="slot" id="slot-1">
            <img id="img-1" src="" class="w-8 h-8 object-contain hidden">
            <div class="text-[7px] font-black opacity-30 mt-1 uppercase">Инвентарь</div>
        </div>
        <div class="slot" id="slot-2">
            <img id="img-2" src="" class="w-8 h-8 object-contain hidden">
            <div class="text-[7px] font-black opacity-30 mt-1 uppercase">Цель</div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
        <div>
            <h3 class="text-[9px] font-black uppercase mb-2 opacity-40 text-center">Инвентарь</h3>
            <div id="mine-list" class="scroll-area"></div>
        </div>
        <div>
            <h3 class="text-[9px] font-black uppercase mb-2 text-[#a3e635] text-center">Апгрейд</h3>
            <div id="target-list" class="scroll-area"></div>
        </div>
    </div>

    <button id="upg-btn" onclick="startUpgrade()" class="btn-main mt-4" disabled>Сделать апгрейд</button>

<script>
    const tg = window.Telegram.WebApp;
    
    // БАЗА ДАННЫХ (Пути теперь совпадают с профилем)
    const ITEMS_DATA = {
        1: { name: "1 May", img: "1may.jpg", price: 100 },
        2: { name: "2025", img: "2025.jpg", price: 500 },
        3: { name: "Bear", img: "bear.png", price: 3500 },
        4: { name: "Book", img: "book.jpg", price: 1000 },
        5: { name: "Berry Box", img: "boooox.png", price: 700 }, // исправлено опечатка в пути
        6: { name: "Boot", img: "botinok.png", price: 400 },
        7: { name: "Jack Box", img: "box.png", price: 600 },
        8: { name: "Car", img: "car.png", price: 5000 },
        16: { name: "Star Ring", img: "ccolso2.png", price: 3000 },
        17: { name: "Gingerbread", img: "cerrrdce.jpg", price: 500 },
        18: { name: "Suitcase", img: "chemodan.jpg", price: 5000 },
        19: { name: "Cigar", img: "ciga.png", price: 3000 },
        20: { name: "Blue Ring", img: "colso.png", price: 2500 },
        21: { name: "Costume", img: "costum.jpg", price: 10000 },
        22: { name: "Flower", img: "cvetok.png", price: 1000 },
        23: { name: "Rich Dog", img: "dog.png", price: 500 },
        24: { name: "Perfume", img: "dyxi.png", price: 10000 },
        25: { name: "Lantern", img: "fonarik.jpg", price: 100 },
        26: { name: "Coffin", img: "grob.jpg", price: 5000 },
        27: { name: "Lava Lips", img: "gyba.png", price: 5000 },
        28: { name: "B-Day Cake", img: "happybirthday.jpg", price: 200 },
        29: { name: "Heart Lock", img: "heart.png", price: 2000 },
        30: { name: "Spartan", img: "helmet.png", price: 25000 },
        40: { name: "Red Cap", img: "kepka.png", price: 100000 },
        41: { name: "Brick", img: "kirpitch.jpg", price: 10000 },
        50: { name: "Lightsaber", img: "metch.png", price: 700 },
        53: { name: "Sneakers", img: "obyv.jpg", price: 10000 },
        54: { name: "Glasses", img: "ochki.jpg", price: 30000 },
        55: { name: "Eagle", img: "orel.jpg", price: 5000 },
        59: { name: "Rose", img: "rozza.png", price: 2000 },
        63: { name: "Helmet Biker", img: "shlem.png", price: 3500 },
        66: { name: "Statue", img: "statyya.jpg", price: 41000 },
        72: { name: "Snake", img: "zmei.png", price: 500 }
    };

    let s1 = null; let s2 = null;

    function render() {
        // Читаем из того же ключа, что и профиль
        const inv = JSON.parse(localStorage.getItem('user_inventory')) || [];
        const mList = document.getElementById('mine-list');
        const tList = document.getElementById('target-list');

        mList.innerHTML = inv.map((it, i) => `
            <div class="item-card ${s1?.idx === i ? 'active' : ''}" onclick="sel1(${i},'${it.img}',${it.price},'${it.name}')">
                <img src="${it.img.startsWith('img/') ? it.img : 'img/' + it.img}" class="w-8 h-8 object-contain">
                <div class="text-[8px] font-black truncate">${it.name}</div>
            </div>`).join('');

        tList.innerHTML = Object.values(ITEMS_DATA)
            .filter(it => !s1 || it.price > s1.price)
            .sort((a,b) => a.price - b.price)
            .map(it => `
                <div class="item-card ${s2?.name === it.name ? 'active' : ''}" onclick="sel2('img/${it.img}',${it.price},'${it.name}')">
                    <img src="img/${it.img}" class="w-8 h-8 object-contain">
                    <div class="text-[8px] font-black truncate">${it.name}</div>
                </div>`).join('');
    }

    function sel1(idx, img, price, name) {
        s1 = {idx, img, price, name};
        document.getElementById('img-1').src = img.startsWith('img/') ? img : 'img/' + img;
        document.getElementById('img-1').classList.remove('hidden');
        s2 = null; updateUI(); render();
    }

    function sel2(img, price, name) {
        s2 = {img, price, name};
        document.getElementById('img-2').src = img;
        document.getElementById('img-2').classList.remove('hidden');
        document.getElementById('view-target').src = img;
        document.getElementById('view-target').classList.remove('hidden');
        document.getElementById('view-empty').classList.add('hidden');
        updateUI(); render();
    }

    function updateUI() {
        const btn = document.getElementById('upg-btn');
        const info = document.getElementById('info-chance');
        const wheel = document.getElementById('wheel-progress');
        if(s1 && s2) {
            let chance = (s1.price / s2.price) * 100;
            if(chance > 80) chance = 80;
            info.innerText = `ШАНС: ${chance.toFixed(2)}%`;
            wheel.style.background = `conic-gradient(#a3e635 ${chance * 3.6}deg, #000 0deg)`;
            btn.disabled = false;
        } else {
            btn.disabled = true;
            wheel.style.background = `conic-gradient(#a3e635 0deg, #000 0deg)`;
        }
    }

    function startUpgrade() {
        const btn = document.getElementById('upg-btn');
        const pointer = document.getElementById('pointer-wrapper');
        const resMsg = document.getElementById('res-msg');
        const center = document.getElementById('center-ui');
        
        btn.disabled = true;

        const visualChance = (s1.price / s2.price) * 100;
        const limitedVisual = Math.min(visualChance, 80); 
        const isWin = (Math.random() * 100) <= limitedVisual; // Исправлено: теперь шанс реальный
        
        const winDeg = limitedVisual * 3.6; 
        const spins = 360 * 5;
        let finalDeg;

        if (isWin) {
            finalDeg = spins + (Math.random() * (winDeg - 2)) + 1;
        } else {
            finalDeg = spins + winDeg + (Math.random() * (358 - winDeg)) + 2;
        }

        pointer.style.transform = `rotate(${finalDeg}deg)`;
        tg.HapticFeedback.impactOccurred('medium');

        setTimeout(() => {
            center.style.opacity = "0";
            resMsg.style.display = "block";
            let inv = JSON.parse(localStorage.getItem('user_inventory')) || [];

            if (isWin) {
                resMsg.innerText = "УДАЧА";
                resMsg.style.color = "#a3e635";
                // СОХРАНЯЕМ В ПРОФИЛЬ (чистое имя картинки)
                const cleanImg = s2.img.replace('img/', '');
                inv[s1.idx] = { name: s2.name, img: 'img/' + cleanImg, price: s2.price };
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                resMsg.innerText = "ПРОВАЛ";
                resMsg.style.color = "#ff4d4d";
                inv.splice(s1.idx, 1);
                tg.HapticFeedback.notificationOccurred('error');
            }

            localStorage.setItem('user_inventory', JSON.stringify(inv));
            setTimeout(() => location.reload(), 2000);
        }, 3600);
    }

    window.onload = render;
</script>
</body>
</html>
