<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StarDrop - Catch Master</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #00ff41;
            --danger: #ff4444;
            --bg-dark: #040d04;
        }
        body { 
            margin: 0; 
            background: var(--bg-dark); 
            color: white; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            overflow: hidden; 
            touch-action: none;
        }
        #game-screen { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
            background: radial-gradient(circle at center, #0a1a0a 0%, #000 100%);
        }
        
        .ui-panel { 
            position: absolute; 
            top: 40px; 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            padding: 0 20px; 
            box-sizing: border-box; 
            z-index: 100; 
        }
        #score-cont { 
            font-size: 18px; 
            font-weight: 900; 
            color: var(--primary); 
            background: rgba(0,0,0,0.6); 
            padding: 8px 15px; 
            border-radius: 15px; 
            border: 1px solid rgba(0,255,65,0.3);
            box-shadow: 0 0 15px rgba(0,255,65,0.1);
        }
        #pause-btn { 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 12px; 
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        #danger-zone {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(to top, rgba(255,68,68,0.3), transparent);
            border-top: 2px solid var(--danger);
            z-index: 10;
            box-shadow: 0 -10px 20px rgba(255,68,68,0.1);
        }

        .falling-item { 
            position: absolute; 
            cursor: pointer; 
            user-select: none; 
            z-index: 50; 
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
            will-change: transform;
        }
        .falling-item img { width: 65px; height: 65px; object-fit: contain; pointer-events: none; }

        .modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            text-align: center;
            backdrop-filter: blur(10px);
        }
        .modal h2 { font-size: 32px; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .m-btn { 
            width: 260px; 
            padding: 20px; 
            margin: 10px; 
            border-radius: 30px; 
            border: none; 
            font-weight: 900; 
            font-size: 16px; 
            cursor: pointer; 
            text-transform: uppercase;
            transition: 0.3s;
        }
        .btn-green { background: var(--primary); color: black; box-shadow: 0 0 25px rgba(0,255,65,0.4); }
        .btn-exit { background: #111; color: white; border: 1px solid #333; }
        
        .item-star { filter: drop-shadow(0 0 15px #ffd700); }
    </style>
</head>
<body>

<div id="game-screen">
    <div class="ui-panel">
        <button id="pause-btn" onclick="togglePause()">|| –ü–ê–£–ó–ê</button>
        <div id="score-cont">üéÅ <span id="gift-count">0</span>/50 | ‚≠ê <span id="star-count">0</span></div>
    </div>
    <div id="danger-zone"></div>
</div>

<div id="pause-modal" class="modal">
    <h2>–ü–ê–£–ó–ê</h2>
    <button class="m-btn btn-green" onclick="togglePause()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
    <button class="m-btn btn-exit" onclick="saveAndExit()">–í–´–ô–¢–ò –ò –°–û–•–†–ê–ù–ò–¢–¨</button>
</div>

<div id="fail-modal" class="modal">
    <img id="fail-icon" src="img/bomb.png" style="width: 100px; margin-bottom: 20px;">
    <h2 id="fail-title" style="color: var(--danger);">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h2>
    <p id="fail-msg">–í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –ø–æ–¥–∞—Ä–æ–∫!</p>
    <div id="final-res" style="font-size: 24px; margin-bottom: 30px; font-weight: bold; color: #fff;">0 ‚≠ê</div>
    <button id="exit-btn" class="m-btn btn-exit" onclick="saveAndExit()">–í–ï–†–ù–£–¢–¨–°–Ø –í –ú–ï–ù–Æ</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const screen = document.getElementById('game-screen');
    const giftLabel = document.getElementById('gift-count');
    const starLabel = document.getElementById('star-count');

    const BACKEND_URL = 'https://stars-drop.vercel.app/api';
    const user = tg.initDataUnsafe?.user;

    let giftsCollected = 0;
    let starsEarned = 0;
    let isPaused = false;
    let gameActive = true;
    let isSaving = false;

    let baseSpeed = 2.5;
    let spawnRate = 800;
    let bombChance = 0.12;

// –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–≤–æ–∏—Ö –∞—Å—Å–µ—Ç–æ–≤
const ASSETS = [
    '1may.jpg', '2025.jpg', 'bear.png', 'book.jpg', 'boooox.png', 'botinok.png', 'box.png', 'car.png',
    'ccolso2.png', 'cerrrdce.jpg', 'chassiki.png', 'chemodan.jpg', 'ciga.png', 'colso.png', 'costum.jpg',
    'cvetok.png', 'dog.png', 'dyxi.png', 'fonarik.jpg', 'grob.jpg', 'gyba.png', 'happybirthday.jpg',
    'heart.png', 'helmet.png', 'kalendar.png', 'kepka.png', 'kirpitch.jpg', 'koks.jpg', 'koktel.png',
    'kolechko.png', 'kot.png', 'kotel.png', 'krovatka.jpg', 'lolipop.png', 'lucky.jpg', 'mafin.jpg',
    'metch.png', 'narkotiki.png', 'obyv.jpg', 'otchki.jpg', 'orel.jpg', 'otkritka.jpg', 'paska.jpg',
    'pepe.png', 'raketa.png', 'rozza.png', 'rykazak.jpg', 'shapka.png', 'shar.jpg', 'shlem.png',
    'sliva.png', 'soska.jpg', 'statyya.jpg', 'statyyetka.png', 'venok.jpg', 'yayko.png', 'zhele.png', 'zmei.png',
    'star.png', 'bomb.png', 'case.png' // –î–æ–±–∞–≤–∏–ª —Ç–µ, —á—Ç–æ –≤–∏–¥–µ–ª –≤ —Ç–≤–æ–µ–º GitHub
];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ø—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
function getAssetUrl(fileName) {
    // –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–π URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://stars-drop.vercel.app/)
    const baseUrl = window.location.origin;
    return `${baseUrl}/${fileName}`;
}

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–∞—Ä–∫–∞ –≤ –∏–≥—Ä–µ:
// –í–º–µ—Å—Ç–æ item.src = "img/" + name;
// –ò—Å–ø–æ–ª—å–∑—É–π: 
// const randomImg = ASSETS[Math.floor(Math.random() * ASSETS.length)];
// giftElement.src = getAssetUrl(randomImg);

    function spawnItem() {
        if (!gameActive || isPaused) return;

        const item = document.createElement('div');
        item.className = 'falling-item';
        
        let type = 'gift';
        let imgName = ASSETS[Math.floor(Math.random() * ASSETS.length)];
        let isCaught = false; // –§–ª–∞–≥, —á—Ç–æ –ø—Ä–µ–¥–º–µ—Ç —É–∂–µ –Ω–∞–∂–∞—Ç

        if (Math.random() < bombChance) {
            type = 'bomb';
            imgName = 'bomb.png';
        } else if (giftsCollected >= 50) {
            type = 'star';
            imgName = 'star.png';
            item.classList.add('item-star');
            giftsCollected = 0;
        }

        item.setAttribute('data-type', type);
        item.innerHTML = `<img src="img/${imgName}">`;
        item.style.left = Math.random() * (window.innerWidth - 75) + 'px';
        item.style.top = '-100px';
        screen.appendChild(item);

        const handleHit = (e) => {
            if (e.cancelable) e.preventDefault();
            if (!gameActive || isPaused || isCaught) return;

            isCaught = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–∞–¥–µ–Ω–∏—è –≤ –∫—Ä–∞—Å–Ω—É—é –∑–æ–Ω—É
            const currentType = item.getAttribute('data-type');
            
            if (currentType === 'bomb') {
                endGame('bomb');
            } else if (currentType === 'star') {
                starsEarned++;
                starLabel.innerText = starsEarned;
                tg.HapticFeedback.notificationOccurred('success');
                item.remove();
            } else {
                giftsCollected++;
                giftLabel.innerText = giftsCollected;
                if (giftsCollected % 10 === 0) baseSpeed += 0.3;
                tg.HapticFeedback.impactOccurred('light');
                item.remove();
            }
        };

        item.onmousedown = item.ontouchstart = handleHit;

        let pos = -100;
        let speed = baseSpeed + Math.random() * 2;
        const dangerLine = window.innerHeight - 60;
        
        function fall() {
            if (!gameActive || isCaught) return; // –ï—Å–ª–∏ –ø–æ–π–º–∞–Ω ‚Äî –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º —Ü–∏–∫–ª –ø–∞–¥–µ–Ω–∏—è –¥–ª—è –Ω–µ–≥–æ
            if (!isPaused) {
                pos += speed;
                item.style.top = pos + 'px';
            }

            // –§–∏–∫—Å ‚Ññ2: –ë–æ–º–±—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç –∫—Ä–∞—Å–Ω—É—é –∑–æ–Ω—É
            if (pos + 60 > dangerLine && type !== 'bomb') {
                endGame('miss');
                item.remove();
                return;
            }

            if (pos > window.innerHeight) {
                item.remove();
            } else {
                requestAnimationFrame(fall);
            }
        }
        requestAnimationFrame(fall);
    }

    function togglePause() {
        isPaused = !isPaused;
        document.getElementById('pause-modal').style.display = isPaused ? 'flex' : 'none';
    }

    function endGame(reason) {
        gameActive = false;
        tg.HapticFeedback.notificationOccurred('error');
        
        const modal = document.getElementById('fail-modal');
        const title = document.getElementById('fail-title');
        const msg = document.getElementById('fail-msg');
        const icon = document.getElementById('fail-icon');

        if (reason === 'bomb') {
            title.innerText = "–ë–ê–ë–ê–•!";
            msg.innerText = "–í—ã –Ω–∞–∂–∞–ª–∏ –Ω–∞ –±–æ–º–±—É!";
            icon.src = "img/bomb.png";
        } else {
            title.innerText = "–ü–†–û–ü–£–°–ö!";
            msg.innerText = "–ü—Ä–µ–¥–º–µ—Ç —É–ø–∞–ª –≤ –∫—Ä–∞—Å–Ω—É—é –∑–æ–Ω—É!";
            icon.src = "img/star.png";
        }

        document.getElementById('final-res').innerText = `–í–ê–® –î–†–û–ü: ${starsEarned} ‚≠ê`;
        modal.style.display = 'flex';
        localStorage.setItem('last_gift_time', Date.now().toString());
    }

    async function saveAndExit() {
        if (isSaving) return;
        isSaving = true;
        const exitBtn = document.getElementById('exit-btn');
        if (exitBtn) exitBtn.innerText = "–°–û–•–†–ê–ù–ï–ù–ò–ï...";

        let currentStars = parseInt(localStorage.getItem('user_stars')) || 0;
        localStorage.setItem('user_stars', (currentStars + starsEarned).toString());

        if (user?.id && starsEarned > 0) {
            try {
                await fetch(`${BACKEND_URL}/update_balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user.id,
                        stars: starsEarned,
                        points: 0
                    })
                });
            } catch (e) { console.error("Server error"); }
        }
        window.location.href = 'index.html';
    }

    function gameLoop() {
        if (gameActive && !isPaused) {
            spawnItem();
        }
        setTimeout(gameLoop, spawnRate);
    }

    gameLoop();
</script>
</body>
</html>
