<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Lucky Wheel - StarDrop Green</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --green-primary: #a3e635;
            --green-dark: #166534;
            --bg-dark: #0a1205;
        }

        body { 
            background: var(--bg-dark); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            margin: 0; 
        }

        .bg-glow { 
            position: fixed; 
            inset: 0; 
            background: radial-gradient(circle at 50% 50%, rgba(163, 230, 53, 0.15) 0%, transparent 80%); 
            z-index: 1; 
            pointer-events: none; 
        }

        .back-button { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 100; 
            background: rgba(163, 230, 53, 0.1); 
            border: 1px solid rgba(163, 230, 53, 0.3); 
            width: 48px; 
            height: 48px; 
            border-radius: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            backdrop-filter: blur(10px);
            transition: all 0.2s; 
        }
        .back-button:active { transform: scale(0.9); background: var(--green-primary); color: black; }

        .content { 
            position: relative; 
            z-index: 10; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }

        .wheel-outer { 
            position: relative; 
            width: 100%; 
            background: linear-gradient(90deg, var(--bg-dark) 0%, transparent 20%, transparent 80%, var(--bg-dark) 100%); 
            padding: 30px 0; 
        }

        .wheel-container { 
            position: relative; 
            width: 100%; 
            height: 150px; 
            overflow: hidden; 
            background: rgba(163, 230, 53, 0.03); 
            border-top: 2px solid rgba(163, 230, 53, 0.2); 
            border-bottom: 2px solid rgba(163, 230, 53, 0.2); 
            display: flex; 
            align-items: center; 
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }

        .pointer { 
            position: absolute; 
            top: 0; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 4px; 
            height: 100%; 
            background: var(--green-primary); 
            z-index: 50; 
            box-shadow: 0 0 20px var(--green-primary);
        }

        .wheel-line { 
            display: flex; 
            align-items: center; 
            height: 100%; 
            transition: transform 8s cubic-bezier(0.1, 0, 0, 1); 
            will-change: transform; 
        }

        .item { 
            min-width: 120px; 
            height: 120px; 
            margin: 0 8px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid rgba(163, 230, 53, 0.1); 
            backdrop-filter: blur(10px); 
            transition: 0.3s;
        }

        .item img { width: 80px; height: 80px; object-fit: contain; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }

        .btn-main {
            background: var(--green-primary);
            color: black;
            font-weight: 900;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 25px rgba(163, 230, 53, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-main:disabled { 
            background: #2d3f1a; 
            color: #555; 
            box-shadow: none; 
            opacity: 0.6;
        }
        .star-icon { width: 18px; height: 18px; display: inline-block; vertical-align: middle; }

        #win-modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            background: rgba(0, 0, 0, 0.9); 
            backdrop-filter: blur(20px); 
            align-items: center; 
            justify-content: center; 
        }
        .modal-content { 
            background: linear-gradient(180deg, #1a2e0b 0%, #0a1205 100%); 
            border: 2px solid var(--green-primary); 
            border-radius: 35px; 
            width: 85%; 
            max-width: 340px; 
            padding: 40px 25px; 
            text-align: center; 
            box-shadow: 0 0 50px rgba(163, 230, 53, 0.2);
        }

        .status-text { 
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            color: var(--green-primary); 
            margin-top: 15px; 
            font-weight: 800; 
            opacity: 0.7;
        }

        .glitch-text {
            text-shadow: 0 0 15px rgba(163, 230, 53, 0.5);
        }
    </style>
</head>
<body>
    <div class="bg-glow"></div>
    <div class="back-button" onclick="goToMain()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>

    <div class="content">
        <h1 class="text-4xl font-black italic uppercase tracking-tighter mb-12 glitch-text">
            LUCKY <span class="text-green-400">SPIN</span>
        </h1>

        <div class="wheel-outer">
            <div class="wheel-container">
                <div class="pointer"></div>
                <div id="wheel" class="wheel-line"></div>
            </div>
        </div>

        <div class="w-full px-8 mt-14 text-center">
            <button id="spin-btn" class="w-full btn-main py-6 rounded-3xl text-lg uppercase tracking-widest active:scale-95 disabled:opacity-50 transition-all">
                ЗАГРУЗКА...
            </button>
            <div id="timer-display" class="status-text">СИНХРОНИЗАЦИЯ...</div>
        </div>
    </div>

    <div id="win-modal">
        <div class="modal-content">
            <div class="relative inline-block mb-6">
                <div class="absolute inset-0 bg-green-500 blur-2xl opacity-30"></div>
                <img id="won-item-img" src="" class="relative w-28 h-28 mx-auto object-contain">
            </div>
            
            <h2 class="text-3xl font-black mb-2 uppercase italic tracking-tighter">ВЫИГРЫШ!</h2>
            <p id="won-item-name" class="text-green-400 font-black mb-10 uppercase text-xs tracking-widest"></p>
            
            <div class="flex flex-col gap-4">
                <button id="sell-btn" class="w-full bg-green-500 text-black py-5 rounded-2xl font-black uppercase text-sm active:scale-95 shadow-lg">
                    Продать
                </button>
                <button id="keep-btn" class="w-full bg-white/5 border border-white/10 py-5 rounded-2xl font-bold uppercase text-xs text-white/70 active:scale-95">
                    В инвентарь
                </button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spin-btn');
        const timerDisplay = document.getElementById('timer-display');
        const winModal = document.getElementById('win-modal');
        const SPIN_COST = 100;

        const ITEMS_DB = {
            1: { name: "1 May", img: "1may.jpg", price: 100 },
            2: { name: "2025", img: "2025.jpg", price: 500 },
            3: { name: "Bear", img: "bear.png", price: 3500 },
            4: { name: "Book", img: "book.jpg", price: 1000 },
            7: { name: "Jack Box", img: "box.png", price: 600 },
            8: { name: "Car", img: "car.png", price: 5000 },
            23: { name: "Rich Dog", img: "dog.png", price: 500 },
            44: { name: "Atomic Cat", img: "kot.png", price: 10000 },
            65: { name: "Golden Star", img: "star.png", price: 15 },
            27: { name: "Lava Lips", img: "gyba.png", price: 5000 }
        };

        const itemIds = Object.keys(ITEMS_DB);
        let winningItem = null;

        // --- УЛУЧШЕННЫЙ АУДИО КОНТЕКСТ ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioCtx();

        function playTickSound() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, audioCtx.currentTime); // Звонкий клик
            osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.05);
            
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }

        function goToMain() { window.location.href = 'index.html'; }

        function updateStatus() {
            const lastSpin = localStorage.getItem('last_free_spin');
            const now = Date.now();
            const stars = parseInt(localStorage.getItem('user_stars')) || 0;
            const cooldown = 86400000;

            if (!lastSpin || (now - lastSpin) >= cooldown) {
                spinBtn.innerHTML = "КРУТИТЬ БЕСПЛАТНО";
                spinBtn.disabled = false;
                timerDisplay.innerText = "ЕЖЕДНЕВНЫЙ БОНУС ДОСТУПЕН!";
                return "free";
            } else {
                spinBtn.innerHTML = `КРУТИТЬ ЗА 100 <img src="img/star.png" class="star-icon">`;
                if (stars < SPIN_COST) {
                    spinBtn.disabled = true;
                    timerDisplay.innerText = `НУЖНО ${SPIN_COST} ⭐ (У ВАС ${stars})`;
                } else {
                    spinBtn.disabled = false;
                    timerDisplay.innerText = "ПЛАТНЫЙ ПРОКРУТ ДОСТУПЕН";
                }
                return "paid";
            }
        }

        function initWheel() {
            const isCheap = Math.random() > 0.2;
            const winId = isCheap ? "65" : itemIds[Math.floor(Math.random() * itemIds.length)];
            winningItem = { id: winId, ...ITEMS_DB[winId] };
            
            wheel.innerHTML = '';
            wheel.style.transition = 'none';
            wheel.style.transform = 'translateX(0)';
            
            for (let i = 0; i < 95; i++) {
                const id = (i === 80) ? winningItem.id : itemIds[Math.floor(Math.random() * itemIds.length)];
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<img src="img/${ITEMS_DB[id].img}" onerror="this.src='img/star.png'">`;
                wheel.appendChild(div);
            }
        }

        spinBtn.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const mode = updateStatus();
            let stars = parseInt(localStorage.getItem('user_stars')) || 0;

            if (mode === "paid") {
                if (stars < SPIN_COST) return;
                localStorage.setItem('user_stars', (stars - SPIN_COST).toString());
            } else {
                localStorage.setItem('last_free_spin', Date.now().toString());
            }

            spinBtn.disabled = true;
            initWheel();
            
            const itemWidth = 136; // 120px + 16px margins
            const finalPosition = (80 * itemWidth) - (window.innerWidth / 2) + (itemWidth / 2);
            
            wheel.style.transition = 'transform 8s cubic-bezier(0.1, 0, 0.05, 1)';
            wheel.style.transform = `translateX(-${finalPosition}px)`;

            // --- МОЗГ РИТМА ЗВУКА ---
            let lastTickIndex = 0;
            let isSpinning = true;

            function syncTick() {
                if (!isSpinning) return;

                // Получаем реальный текущий X из матрицы трансформации
                const style = window.getComputedStyle(wheel);
                const matrix = new WebKitCSSMatrix(style.transform);
                const currentX = Math.abs(matrix.m41);

                // Считаем, сколько "границ" айтемов мы пересекли
                const currentTickIndex = Math.floor(currentX / itemWidth);

                if (currentTickIndex > lastTickIndex) {
                    playTickSound();
                    tg.HapticFeedback.impactOccurred('light');
                    lastTickIndex = currentTickIndex;
                }

                requestAnimationFrame(syncTick);
            }

            requestAnimationFrame(syncTick);

            setTimeout(() => { 
                isSpinning = false;
                document.getElementById('won-item-img').src = `img/${winningItem.img}`;
                document.getElementById('won-item-name').innerText = winningItem.name;
                document.getElementById('sell-btn').innerText = `ПРОДАТЬ ЗА ${winningItem.price} ⭐`;
                winModal.style.display = 'flex'; 
                tg.HapticFeedback.notificationOccurred('success');
            }, 8200);
        });

        document.getElementById('sell-btn').onclick = () => {
            let s = parseInt(localStorage.getItem('user_stars')) || 0;
            localStorage.setItem('user_stars', (s + winningItem.price).toString());
            goToMain();
        };

        document.getElementById('keep-btn').onclick = () => {
            let inv = JSON.parse(localStorage.getItem('user_inventory')) || [];
            inv.push({ id: winningItem.id, name: winningItem.name, img: `img/${winningItem.img}` });
            localStorage.setItem('user_inventory', JSON.stringify(inv));
            goToMain();
        };

        initWheel();
        updateStatus();
    </script>
</body>
</html>
