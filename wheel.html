<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Lucky Wheel - StarDrop Green</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --green-primary: #a3e635;
            --green-dark: #166534;
            --bg-dark: #0a1205;
        }

        body { 
            background: var(--bg-dark); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            margin: 0; 
        }

        .bg-glow { 
            position: fixed; 
            inset: 0; 
            background: radial-gradient(circle at 50% 50%, rgba(163, 230, 53, 0.15) 0%, transparent 80%); 
            z-index: 1; 
            pointer-events: none; 
        }

        .back-button { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 100; 
            background: rgba(163, 230, 53, 0.1); 
            border: 1px solid rgba(163, 230, 53, 0.3); 
            width: 48px; 
            height: 48px; 
            border-radius: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            backdrop-filter: blur(10px);
            transition: all 0.2s; 
        }
        .back-button:active { transform: scale(0.9); background: var(--green-primary); color: black; }

        .content { 
            position: relative; 
            z-index: 10; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }

        .wheel-outer { 
            position: relative; 
            width: 100%; 
            background: linear-gradient(90deg, var(--bg-dark) 0%, transparent 20%, transparent 80%, var(--bg-dark) 100%); 
            padding: 30px 0; 
        }

        .wheel-container { 
            position: relative; 
            width: 100%; 
            height: 150px; 
            overflow: hidden; 
            background: rgba(163, 230, 53, 0.03); 
            border-top: 2px solid rgba(163, 230, 53, 0.2); 
            border-bottom: 2px solid rgba(163, 230, 53, 0.2); 
            display: flex; 
            align-items: center; 
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }

        .pointer { 
            position: absolute; 
            top: 0; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 4px; 
            height: 100%; 
            background: var(--green-primary); 
            z-index: 50; 
            box-shadow: 0 0 20px var(--green-primary);
        }

        .wheel-line { 
            display: flex; 
            align-items: center; 
            height: 100%; 
            transition: transform 8s cubic-bezier(0.1, 0, 0, 1); 
            will-change: transform; 
        }

        .item { 
            min-width: 120px; 
            height: 120px; 
            margin: 0 8px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid rgba(163, 230, 53, 0.1); 
            backdrop-filter: blur(10px); 
        }

        .item img { width: 80px; height: 80px; object-fit: contain; }

        .btn-main {
            background: var(--green-primary);
            color: black;
            font-weight: 900;
            box-shadow: 0 10px 25px rgba(163, 230, 53, 0.3);
        }

        #win-modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            background: rgba(0, 0, 0, 0.9); 
            backdrop-filter: blur(20px); 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal-content { 
            background: linear-gradient(180deg, #1a2e0b 0%, #0a1205 100%); 
            border: 2px solid var(--green-primary); 
            border-radius: 35px; 
            width: 85%; 
            max-width: 340px; 
            padding: 40px 25px; 
            text-align: center; 
        }

        .status-text { 
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            color: var(--green-primary); 
            margin-top: 15px; 
            font-weight: 800; 
        }
    </style>
</head>
<body>
    <div class="bg-glow"></div>
    <div class="back-button" onclick="goToMain()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>

    <div class="content">
        <h1 class="text-4xl font-black italic uppercase tracking-tighter mb-12">
            LUCKY <span class="text-green-400">SPIN</span>
        </h1>

        <div class="wheel-outer">
            <div class="wheel-container">
                <div class="pointer"></div>
                <div id="wheel" class="wheel-line"></div>
            </div>
        </div>

        <div class="w-full px-8 mt-14 text-center">
            <button id="spin-btn" class="w-full btn-main py-6 rounded-3xl text-lg uppercase tracking-widest active:scale-95 disabled:opacity-50 transition-all">
                ЗАГРУЗКА...
            </button>
            <div id="timer-display" class="status-text">ПОДКЛЮЧЕНИЕ...</div>
        </div>
    </div>

    <div id="win-modal">
        <div class="modal-content">
            <img id="won-item-img" src="" class="w-28 h-28 mx-auto object-contain mb-6">
            <h2 class="text-3xl font-black mb-2 uppercase italic tracking-tighter">ВЫИГРЫШ!</h2>
            <p id="won-item-name" class="text-green-400 font-black mb-10 uppercase text-xs tracking-widest"></p>
            <div class="flex flex-col gap-4">
                <button id="sell-btn" class="w-full bg-green-500 text-black py-5 rounded-2xl font-black uppercase text-sm active:scale-95">Продать</button>
                <button id="keep-btn" class="w-full bg-white/5 border border-white/10 py-5 rounded-2xl font-bold uppercase text-xs text-white/70 active:scale-95">В инвентарь</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        // Берём ID из телеги, либо используем твой реальный из таблицы для теста
        const user = tg.initDataUnsafe?.user || { id: "5270341396" }; 

        // Supabase Config
        const SUPABASE_URL = 'https://mwsbkpfarhdankpyifbm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Bj40x3HKomgXSyLMiVqXig_FqCgOSmA';
        const TABLE_NAME = 'users';

        const SPIN_COST = 100;
        const ITEMS_DB = {
            1: { name: "1 May", img: "1may.jpg", price: 100 },
            2: { name: "2025", img: "2025.jpg", price: 500 },
            3: { name: "Bear", img: "bear.png", price: 3500 },
            4: { name: "Book", img: "book.jpg", price: 1000 },
            7: { name: "Jack Box", img: "box.png", price: 600 },
            8: { name: "Car", img: "car.png", price: 5000 },
            23: { name: "Rich Dog", img: "dog.png", price: 500 },
            44: { name: "Atomic Cat", img: "kot.png", price: 10000 },
            65: { name: "Golden Star", img: "star.png", price: 15 },
            27: { name: "Lava Lips", img: "gyba.png", price: 5000 }
        };

        const itemIds = Object.keys(ITEMS_DB);
        let userRowData = null;
        let isSpinning = false;
        let winningItem = null;

        function goToMain() { window.location.href = 'index.html'; }

        async function supabaseCall(path, method = 'GET', body = null) {
            const headers = {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            };
            const config = { method, headers };
            if (body) config.body = JSON.stringify(body);
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, config);
            return response.json();
        }

        async function loadUserData() {
            try {
                // ИСПРАВЛЕНО: ищем по user_id
                let data = await supabaseCall(`${TABLE_NAME}?user_id=eq.${user.id}`);
                
                if (!data || data.length === 0) {
                    // ИСПРАВЛЕНО: создаем с колонками user_id и stars
                    const newUser = { user_id: user.id.toString(), stars: 500, inventory: "" };
                    const created = await supabaseCall(TABLE_NAME, 'POST', newUser);
                    userRowData = created[0];
                } else {
                    userRowData = data[0];
                }
                updateUI();
            } catch (e) {
                document.getElementById('timer-display').innerText = "ОШИБКА БАЗЫ";
            }
        }

        function updateUI() {
            // ИСПРАВЛЕНО: берем баланс из stars
            const balance = parseInt(userRowData.stars) || 0;
            document.getElementById('timer-display').innerText = `БАЛАНС: ${balance} ⭐`;
            const btn = document.getElementById('spin-btn');
            btn.disabled = balance < SPIN_COST;
            btn.innerText = balance < SPIN_COST ? `НУЖНО ${SPIN_COST} ⭐` : `КРУТИТЬ ЗА ${SPIN_COST} ⭐`;
        }

        document.getElementById('spin-btn').onclick = async () => {
            if (isSpinning) return;
            isSpinning = true;

            const currentBalance = parseInt(userRowData.stars) || 0;
            const newBalance = currentBalance - SPIN_COST;
            
            try {
                // ИСПРАВЛЕНО: обновляем stars по user_id
                await supabaseCall(`${TABLE_NAME}?user_id=eq.${user.id}`, 'PATCH', { stars: newBalance });
                userRowData.stars = newBalance;
                updateUI();
            } catch (e) {
                isSpinning = false;
                return;
            }

            const winId = Math.random() > 0.9 ? itemIds[Math.floor(Math.random() * itemIds.length)] : "65";
            winningItem = { id: winId, ...ITEMS_DB[winId] };
            
            startAnimation(winId);
        };

        function startAnimation(winId) {
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = '';
            wheel.style.transition = 'none';
            wheel.style.transform = 'translateX(0)';
            
            const count = 60; 
            for (let i = 0; i < count + 5; i++) {
                const id = (i === count) ? winId : itemIds[Math.floor(Math.random() * itemIds.length)];
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<img src="img/${ITEMS_DB[id].img}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1828/1828884.png'">`;
                wheel.appendChild(div);
            }

            setTimeout(() => {
                const itemWidth = 136;
                const shift = (count * itemWidth) - (window.innerWidth / 2) + (itemWidth / 2);
                wheel.style.transition = 'transform 8s cubic-bezier(0.1, 0, 0.05, 1)';
                wheel.style.transform = `translateX(-${shift}px)`;
                tg.HapticFeedback.impactOccurred('medium');
            }, 50);

            setTimeout(() => {
                document.getElementById('won-item-img').src = `img/${winningItem.img}`;
                document.getElementById('won-item-name').innerText = winningItem.name;
                document.getElementById('sell-btn').innerText = `ПРОДАТЬ ЗА ${winningItem.price} ⭐`;
                document.getElementById('win-modal').style.display = 'flex';
                tg.HapticFeedback.notificationOccurred('success');
            }, 8500);
        }

        document.getElementById('sell-btn').onclick = async () => {
            const finalBalance = (parseInt(userRowData.stars) || 0) + winningItem.price;
            // ИСПРАВЛЕНО: обновляем stars
            await supabaseCall(`${TABLE_NAME}?user_id=eq.${user.id}`, 'PATCH', { stars: finalBalance });
            location.reload();
        };

        document.getElementById('keep-btn').onclick = async () => {
            const currentInv = userRowData.inventory || "";
            const newInv = currentInv ? `${currentInv}, ${winningItem.name}` : winningItem.name;
            // ИСПРАВЛЕНО: фильтр по user_id
            await supabaseCall(`${TABLE_NAME}?user_id=eq.${user.id}`, 'PATCH', { inventory: newInv });
            location.reload();
        };

        loadUserData();
    </script>
</body>
</html>
