<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>StarDrop Premium Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --bg-main: #080a08;
            --neon-green: #00ff41;
            --ton-blue: #0088cc;
        }

        body {
            background-color: var(--bg-main);
            color: white;
            font-family: 'Inter', sans-serif;
            margin: 0;
            user-select: none;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        .balance-container-v2 {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .balance-item-v2 { display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
        .balance-item-v2 img { width: 18px; height: 18px; }
        .balance-item-v2 span { font-weight: 900; font-size: 0.9rem; }

        .live-header { display: flex; align-items: center; padding: 20px 20px 10px; gap: 12px; }
        .live-label { font-family: 'Orbitron', sans-serif; font-size: 11px; color: var(--neon-green); text-transform: uppercase; letter-spacing: 3px; }
        .live-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 10px var(--neon-green); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        #live-drop-wrapper {
            width: 100%; height: 60px; overflow: hidden; position: relative;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.02), transparent);
        }
        .live-rail { display: flex; position: absolute; left: 0; top: 0; height: 100%; gap: 12px; padding: 10px; transition: transform 0.5s ease; }

        .roulette-container {
            position: relative; width: 100%; height: 160px; 
            background: #0d1408; margin: 20px 0; overflow: hidden; 
            border-top: 1px solid rgba(163, 230, 53, 0.1); border-bottom: 1px solid rgba(163, 230, 53, 0.1);
        }
        .roulette-container::before, .roulette-container::after {
            content: ''; position: absolute; top: 0; width: 30%; height: 100%; z-index: 10; pointer-events: none;
        }
        .roulette-container::before { left: 0; background: linear-gradient(to right, #080a08 10%, transparent 100%); }
        .roulette-container::after { right: 0; background: linear-gradient(to left, #080a08 10%, transparent 100%); }

        .center-line {
            position: absolute; left: 50%; top: 0; width: 2px; height: 100%; background: #a3e635;
            z-index: 50; transform: translateX(-50%); box-shadow: 0 0 15px rgba(163, 230, 53, 0.8);
        }
        .roulette-rail { display: flex; position: absolute; left: 0; align-items: center; height: 100%; will-change: transform; }
        .roulette-item { 
            min-width: 120px; height: 120px; margin: 0 10px;
            display: flex; align-items: center; justify-content: center; 
            background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 24px;
        }
        .roulette-item img { width: 80px; height: 80px; object-fit: contain; }
        
        .win-glow { 
            border-color: #a3e635 !important; 
            background: rgba(163, 230, 53, 0.15) !important; 
            animation: win-pulse 1s infinite ease-in-out; 
            z-index: 20;
        }
        @keyframes win-pulse {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); }
        }

        .case-card {
            background: linear-gradient(145deg, #121612, #0a0c0a);
            border-radius: 35px; border: 1px solid rgba(255,255,255,0.03);
            transition: transform 0.2s;
        }
        .case-card:active { transform: scale(0.95); }
        .cnt-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); color: white; transition: 0.3s; }
        .cnt-btn.active { background: var(--neon-green); color: black; font-weight: 900; }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="p-6 flex justify-between items-center sticky top-0 z-[100] bg-[#080a08]/90 backdrop-blur-xl border-b border-white/5">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='index.html'" class="flex items-center justify-center w-10 h-10 rounded-full bg-white/5 border border-white/10">
                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </button>
            <div class="orbitron text-2xl font-black italic">STAR<span class="text-green-500">DROP</span></div>
        </div>
        <div class="balance-container-v2">
            <div class="balance-item-v2 text-blue-400"><span id="header-ton">0.00</span><img src="img/ton.png"></div>
            <div class="balance-item-v2 text-yellow-400"><span id="header-stars">0</span><img src="img/star.png"></div>
            <div class="balance-item-v2 text-green-400"><span id="header-tickets">0</span><img src="img/ticket.png"></div>
        </div>
    </header>

    <div class="live-header px-6"><div class="live-dot"></div><div class="live-label">Live Drop</div></div>
    <div id="live-drop-wrapper"><div id="live-drop-rail" class="live-rail"></div></div>

    <div class="p-5 flex flex-col gap-5 pb-24">
        <div id="tickets-container"></div>
        <div class="grid grid-cols-2 gap-5" id="main-grid"></div>
    </div>

    <div id="case-modal" class="fixed inset-0 z-[200] hidden flex-col p-6 bg-[#080a08]/98 backdrop-blur-2xl overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <button id="back-btn" onclick="closeModal()" class="text-gray-500 font-bold text-xs uppercase tracking-widest">← Назад</button>
            <div class="orbitron text-[10px] text-green-500 uppercase">System Ready</div>
        </div>

        <div id="view-preview">
            <div class="flex flex-col items-center mb-8">
                <img id="m-img" src="" class="w-64 h-64 object-contain">
                <h1 id="m-title" class="orbitron text-2xl font-black mt-4 uppercase text-center"></h1>
            </div>
            <div class="flex flex-col items-center gap-6 mb-8">
                <div class="flex gap-2">
                    <button onclick="setMul(1)" class="cnt-btn active w-12 h-12 rounded-xl font-black">1</button>
                    <button onclick="setMul(2)" class="cnt-btn w-12 h-12 rounded-xl font-black">2</button>
                    <button onclick="setMul(3)" class="cnt-btn w-12 h-12 rounded-xl font-black">3</button>
                </div>
                <div class="grid grid-cols-2 gap-4 w-full" id="roll-buttons-container">
                    <button id="btn-stars" onclick="startRoll('stars')" class="bg-green-500 text-black py-4 rounded-3xl font-black flex justify-center items-center gap-2 active:scale-95 transition-transform">
                        <img src="img/star.png" class="w-5 h-5"> <span id="p-stars">0</span>
                    </button>
                    <button id="btn-ton" onclick="startRoll('ton')" class="bg-[#0088cc] text-white py-4 rounded-3xl font-black flex justify-center items-center gap-2 active:scale-95 transition-transform">
                        <img src="img/ton.png" class="w-5 h-5"> <span id="p-ton">0</span>
                    </button>
                </div>
            </div>
            <div id="loot-display" class="grid grid-cols-3 gap-2 pb-10"></div>
        </div>

        <div id="view-roulette" class="hidden flex-col items-center">
            <div class="text-center mb-6">
                <h2 id="roul-title" class="orbitron text-xl font-black uppercase text-white"></h2>
                <div class="orbitron text-[10px] text-green-500 animate-pulse mt-1 uppercase tracking-widest">● Анализ вероятностей...</div>
            </div>
            <div id="roulette-rows" class="w-full"></div>
        </div>

        <div id="view-win" class="hidden flex-col items-center gap-6 mt-10">
            <div id="win-grid" class="flex flex-wrap justify-center gap-4"></div>
            <div class="flex items-center gap-2 bg-white/5 px-6 py-3 rounded-2xl border border-white/5">
                <span class="text-gray-400 text-[10px] uppercase font-bold tracking-widest">Общая ценность:</span>
                <div class="flex items-center gap-1">
                    <img src="img/star.png" class="w-4 h-4">
                    <span id="win-total-price" class="orbitron text-green-500 font-black text-lg">0</span>
                </div>
            </div>
            <div class="w-full flex flex-col gap-3">
                <button id="sell-all-btn" onclick="sellAllAndClose()" class="w-full bg-green-500 text-black py-5 rounded-3xl font-black uppercase text-sm active:scale-95 transition-all">Продать</button>
                <button id="keep-all-btn" onclick="saveToInventoryAndClose()" class="w-full bg-white/5 border border-white/10 text-white py-4 rounded-3xl font-bold uppercase text-xs active:scale-95">В инвентарь</button>
            </div>
        </div>
    </div>

<script>
const tg = window.Telegram.WebApp;
const userId = String(tg.initDataUnsafe?.user?.id || '8015661230');

const SB_URL = 'https://mwsbkpfarhdankpyifbm.supabase.co';
const SB_KEY = 'sb_publishable_Bj40x3HKomgXSyLMiVqXig_FqCgOSmA';
const headers = { 
    'apikey': SB_KEY, 
    'Authorization': `Bearer ${SB_KEY}`, 
    'Content-Type': 'application/json',
    'Prefer': 'return=minimal'
};

const ITEMS = {
    "1may.jpg": { name: "1 May Exclusive", price: 100, img: "1may.jpg" },
    "2025.jpg": { name: "Happy 2025", price: 500, img: "2025.jpg" },
    "bear.png": { name: "Honey Bear", price: 3500, img: "bear.png" },
    "book.jpg": { name: "Ancient Book", price: 1000, img: "book.jpg" },
    "booox.png": { name: "Berry Box", price: 700, img: "booox.png" },
    "botinok.png": { name: "Old Boot", price: 400, img: "botinok.png" },
    "box.png": { name: "Jack in Box", price: 600, img: "box.png" },
    "car.png": { name: "Sports Car", price: 5000, img: "car.png" },
    "raketa.png": { name: "Space Rocket", price: 50, img: "raketa.png" },
    "ccolso2.png": { name: "Star Ring", price: 3000, img: "ccolso2.png" },
    "cerrrdce.jpg": { name: "Gingerbread", price: 500, img: "cerrrdce.jpg" },
    "chemodan.jpg": { name: "Traveler Case", price: 5000, img: "chemodan.jpg" },
    "ciga.png": { name: "Luxury Cigar", price: 3000, img: "ciga.png" },
    "colso.png": { name: "Blue Diamond", price: 2500, img: "colso.png" },
    "costum.jpg": { name: "Royal Costume", price: 10000, img: "costum.jpg" },
    "cvetok.png": { name: "Wild Flower", price: 1000, img: "cvetok.png" },
    "dog.png": { name: "Rich Dog", price: 500, img: "dog.png" },
    "dyxi.png": { name: "Gold Perfume", price: 10000, img: "dyxi.png" },
    "fonarik.jpg": { name: "Night Lantern", price: 100, img: "fonarik.jpg" },
    "grob.jpg": { name: "Ancient Coffin", price: 5000, img: "grob.jpg" },
    "gyba.png": { name: "Lava Lips", price: 5000, img: "gyba.png" },
    "happybirthday.jpg": { name: "Birthday Cake", price: 200, img: "happybirthday.jpg" },
    "heart.png": { name: "Heart Lock", price: 2000, img: "heart.png" },
    "helmet.png": { name: "Spartan Helmet", price: 25000, img: "helmet.png" },
    "kalendar.png": { name: "Event Calendar", price: 400, img: "kalendar.png" },
    "kepka.png": { name: "Legendary Cap", price: 100000, img: "kepka.png" },
    "kirpitch.jpg": { name: "Golden Brick", price: 10000, img: "kirpitch.jpg" },
    "koks.jpg": { name: "Party Cocktail", price: 150, img: "koks.jpg" },
    "koktel.png": { name: "Toxic Mix", price: 500, img: "koktel.png" },
    "kot.png": { name: "Atomic Cat", price: 10000, img: "kot.png" },
    "kotel.png": { name: "Witch Cauldron", price: 500, img: "kotel.png" },
    "krovatka.jpg": { name: "Baby Bow", price: 600, img: "krovatka.jpg" },
    "lolipop.png": { name: "Sweet Lollipop", price: 500, img: "lolipop.png" },
    "lucky.jpg": { name: "Clover Lucky", price: 500, img: "lucky.jpg" },
    "mafin.jpg": { name: "Sugar Muffin", price: 700, img: "mafin.jpg" },
    "metch.png": { name: "Star Saber", price: 700, img: "metch.png" },
    "narkotiki.png": { name: "Star Token", price: 600, img: "narkotiki.png" },
    "obyv.jpg": { name: "Sneakers Pro", price: 10000, img: "obyv.jpg" },
    "otchki.jpg": { name: "Cyber Glasses", price: 30000, img: "otchki.jpg" },
    "orel.jpg": { name: "Golden Eagle", price: 5000, img: "orel.jpg" },
    "otkritka.jpg": { name: "Peace Dove", price: 150, img: "otkritka.jpg" },
    "paska.jpg": { name: "Easter Cake", price: 75, img: "paska.jpg" },
    "rozza.png": { name: "Velvet Rose", price: 2000, img: "rozza.png" },
    "rykzak.jpg": { name: "Adventurer Bag", price: 500, img: "rykzak.jpg" },
    "shapka.png": { name: "Santa Hat", price: 500, img: "shapka.png" },
    "shar.jpg": { name: "Magic Ball", price: 1000, img: "shar.jpg" },
    "shlem.png": { name: "Biker Helmet", price: 3500, img: "shlem.png" },
    "soska.jpg": { name: "Diamond Pacifier", price: 3000, img: "soska.jpg" },
    "star.png": { name: "Pure Star", price: 15, img: "star.png" },
    "statyya.jpg": { name: "Hero Statue", price: 41000, img: "statyya.jpg" },
    "venok.jpg": { name: "Wreath Flower", price: 500, img: "venok.jpg" },
    "yayko.png": { name: "Dragon Egg", price: 600, img: "yayko.png" },
    "zhele.png": { name: "Slime Jelly", price: 700, img: "zhele.png" },
    "zmei.png": { name: "Snake Friend", price: 500, img: "zmei.png" },
    "meczcc.png": { name: "Faith Amulet", price: 600, img: "meczcc.png" },
    "kryg.PNG": { name: "Snow Globe", price: 600, img: "kryg.PNG" },
    "gribb.PNG": { name: "Spy Agaric", price: 600, img: "gribb.PNG" },
    "zirka.PNG": { name: "Hanging Star", price: 800, img: "zirka.PNG" },
    "cvetk.PNG": { name: "Sakura Flower", price: 900, img: "cvetk.PNG" },
    "sshapka.PNG": { name: "Khabib's Papakha", price: 2300, img: "sshapka.PNG" },
    "tyfli.PNG": { name: "Sky Stilettos", price: 1800, img: "tyfli.PNG" }
};
const CASES = [
    { name: "Кейс Новичка", type: 'tickets', price: 10, img: "case1.png", loot: [["star.png", 85], ["raketa.png", 5], ["paska.jpg", 3]] },
    { name: "Шкатулка Удачи", type: 'multi', priceStars: 50, priceTon: 0.5, img: "case2.png", loot: [["star.png", 80], ["raketa.png", 10], ["bear.png", 0.1]] },
    { name: "Мистический Шторм", type: 'multi', priceStars: 100, priceTon: 1.0, img: "case3.png", loot: [["paska.jpg", 70], ["car.png", 0.05]] },
    { name: "Лесной Оазис", type: 'multi', priceStars: 250, priceTon: 3.0, img: "case5.png", loot: [["otkritka.jpg", 65], ["helmet.png", 0.1]] },
    { name: "Пиратский Клад", type: 'multi', priceStars: 419, priceTon: 5.5, img: "case7.png", loot: [["dog.png", 60], ["ciga.png", 0.1]] },
    { name: "Детективный поиск", type: 'multi', priceStars: 549, priceTon: 7.0, img: "case4.png", loot: [["botinok.png", 55], ["dyxi.png", 0.1]] },
    { name: "Зимняя история", type: 'multi', priceStars: 799, priceTon: 9.0, img: "case8.png", loot: [["box.png", 50], ["costum.jpg", 0.05]] },
    { name: "Лунная Легенда", type: 'multi', priceStars: 0, priceTon: 19.0, img: "case9.png", loot: [["booox.png", 45], ["kepka.png", 0.01]] }
];

let balance = { stars: 0, ton: 0, tickets: 0 };
let mul = 1, activeCase = null, isBusy = false, currentWinners = [];

async function syncData() {
    try {
        const res = await fetch(`${SB_URL}/rest/v1/users?user_id=eq.${userId}`, { headers });
        const data = await res.json();
        if (data && data[0]) {
            balance.stars = parseInt(data[0].stars || 0);
            balance.ton = parseFloat(data[0].balance || 0);
            balance.tickets = parseInt(data[0].tickets || 0);
            saveAndRefresh();
        }
    } catch (e) { console.error("Sync error:", e); }
}

function saveAndRefresh() {
    document.getElementById('header-stars').innerText = balance.stars.toLocaleString('ru-RU');
    document.getElementById('header-ton').innerText = balance.ton.toFixed(2);
    document.getElementById('header-tickets').innerText = balance.tickets;
}

function openCase(i) {
    if (isBusy) return;
    activeCase = CASES[i];
    setMul(1);
    document.getElementById('case-modal').style.display = 'flex';
    document.getElementById('view-preview').style.display = 'block';
    document.getElementById('view-roulette').style.display = 'none';
    document.getElementById('view-win').style.display = 'none';
    document.getElementById('back-btn').style.display = 'block';
    document.getElementById('m-img').src = `img/${activeCase.img}`;
    document.getElementById('m-title').innerText = activeCase.name;
    updatePriceButtons();
    renderLootPreview();
}

function updatePriceButtons() {
    const btnStars = document.getElementById('btn-stars');
    const btnTon = document.getElementById('btn-ton');
    let btnTickets = document.getElementById('btn-tickets-roll');
    if (!btnTickets) {
        btnTickets = document.createElement('button');
        btnTickets.id = 'btn-tickets-roll';
        btnTickets.className = "col-span-2 bg-green-500 text-black py-4 rounded-3xl font-black flex justify-center items-center gap-2 active:scale-95 transition-transform hidden";
        document.getElementById('roll-buttons-container').appendChild(btnTickets);
    }
    if (activeCase.type === 'tickets') {
        btnStars.classList.add('hidden'); btnTon.classList.add('hidden');
        btnTickets.classList.remove('hidden');
        btnTickets.onclick = () => startRoll('tickets');
        btnTickets.innerHTML = `<img src="img/ticket.png" class="w-5 h-5"> <span>${activeCase.price * mul}</span>`;
    } else {
        btnStars.classList.remove('hidden'); btnTon.classList.remove('hidden');
        btnTickets.classList.add('hidden');
        document.getElementById('p-stars').innerText = activeCase.priceStars * mul;
        document.getElementById('p-ton').innerText = (activeCase.priceTon * mul).toFixed(2);
    }
}

function setMul(n) {
    mul = n;
    document.querySelectorAll('.cnt-btn').forEach(b => b.classList.toggle('active', parseInt(b.innerText) === n));
    updatePriceButtons();
}

async function startRoll(type) {
    if (isBusy) return;
    const priceAttr = type === 'stars' ? 'priceStars' : (type === 'ton' ? 'priceTon' : 'price');
    const cost = activeCase[priceAttr] * mul;
    const balanceKey = type === 'ton' ? 'ton' : type;

    if (balance[balanceKey] < cost) return alert("Недостаточно средств!");

    isBusy = true;
    balance[balanceKey] -= cost;
    saveAndRefresh();

    const dbField = type === 'ton' ? 'balance' : type;
    await fetch(`${SB_URL}/rest/v1/users?user_id=eq.${userId}`, {
        method: 'PATCH', headers, body: JSON.stringify({ [dbField]: balance[balanceKey] })
    });

    document.getElementById('back-btn').style.display = 'none';
    document.getElementById('view-preview').style.display = 'none';
    document.getElementById('view-roulette').style.display = 'flex';
    document.getElementById('roulette-rows').innerHTML = '';

    currentWinners = [];
    for (let i = 0; i < mul; i++) {
        const win = getWin();
        currentWinners.push(win);
        createRow(i, win);
    }
    setTimeout(() => showWin(currentWinners), 7000);
}

function getWin() {
    const loot = activeCase.loot;
    const rand = Math.random() * 100;
    let cumulative = 0;
    for (const [img, chance] of loot) {
        cumulative += chance;
        if (rand <= cumulative) return ITEMS[img] || ITEMS[loot[0][0]];
    }
    return ITEMS[loot[0][0]];
}

function createRow(index, winItem) {
    const container = document.getElementById('roulette-rows');
    const row = document.createElement('div');
    row.className = 'roulette-container animate-fade-in mb-4';
    row.innerHTML = `<div class="center-line"></div><div class="roulette-rail" id="rail-${index}"></div>`;
    container.appendChild(row);
    const rail = document.getElementById(`rail-${index}`);
    const winIndex = 30; 
    for (let i = 0; i < 45; i++) {
        const keys = Object.keys(ITEMS);
        const randomItem = ITEMS[keys[Math.floor(Math.random() * keys.length)]];
        const displayItem = (i === winIndex) ? winItem : randomItem;
        rail.innerHTML += `<div class="roulette-item"><img src="img/${displayItem.img}"></div>`;
    }
    setTimeout(() => {
        const itemWidth = 140;
        const offset = (winIndex * itemWidth) - (window.innerWidth / 2) + (itemWidth / 2);
        rail.style.transition = 'transform 6s cubic-bezier(0.15, 0, 0.05, 1)';
        rail.style.transform = `translateX(-${offset}px)`;
    }, 50);
}

function showWin(winners) {
    document.getElementById('view-roulette').style.display = 'none';
    document.getElementById('view-win').style.display = 'flex';
    const winGrid = document.getElementById('win-grid');
    winGrid.innerHTML = '';
    let total = 0;
    winners.forEach(item => {
        total += item.price;
        winGrid.innerHTML += `<div class="flex flex-col items-center p-4 bg-white/5 rounded-3xl border border-green-500/30 animate-fade-in"><img src="img/${item.img}" class="w-20 h-20 object-contain mb-2"><div class="text-green-500 font-black orbitron text-xs">⭐${item.price}</div></div>`;
    });
    document.getElementById('win-total-price').innerText = total.toLocaleString();
    isBusy = false;
}

async function sellAllAndClose() {
    if (isBusy) return;
    isBusy = true;
    const totalProfit = currentWinners.reduce((sum, item) => sum + item.price, 0);
    balance.stars += totalProfit;
    try {
        await fetch(`${SB_URL}/rest/v1/users?user_id=eq.${userId}`, {
            method: 'PATCH', headers, body: JSON.stringify({ stars: balance.stars })
        });
        saveAndRefresh();
        closeModal();
    } catch (e) { alert("Ошибка при продаже"); }
    finally { isBusy = false; }
}

async function saveToInventoryAndClose() {
    if (isBusy) return;
    isBusy = true;
    try {
        const res = await fetch(`${SB_URL}/rest/v1/users?user_id=eq.${userId}&select=inventory`, { headers });
        const data = await res.json();
        let inv = data[0]?.inventory || [];
        if (!Array.isArray(inv)) inv = [];
        const newItems = currentWinners.map(it => ({ id: Date.now()+Math.random(), name: it.name, img: it.img, price: it.price }));
        const { ok } = await fetch(`${SB_URL}/rest/v1/users?user_id=eq.${userId}`, {
            method: 'PATCH', headers, body: JSON.stringify({ inventory: [...inv, ...newItems] })
        });
        if (ok) closeModal(); else alert("Ошибка сохранения");
    } catch (e) { alert("Ошибка сети"); }
    finally { isBusy = false; }
}

function closeModal() {
    document.getElementById('case-modal').style.display = 'none';
    isBusy = false;
    currentWinners = [];
}

function renderLootPreview() {
    document.getElementById('loot-display').innerHTML = activeCase.loot.map(attr => {
        const itm = ITEMS[attr[0]];
        return itm ? `<div class="bg-white/5 rounded-2xl p-2 flex flex-col items-center border border-white/5"><img src="img/${itm.img}" class="w-10 h-10 mb-1 object-contain"><div class="text-[8px] text-green-500">⭐${itm.price}</div></div>` : '';
    }).join('');
}

function render() {
    const tGrid = document.getElementById('tickets-container');
    const mGrid = document.getElementById('main-grid');
    tGrid.innerHTML = ''; mGrid.innerHTML = '';
    CASES.forEach((c, idx) => {
        if (c.type === 'tickets') {
            tGrid.innerHTML = `<div class="case-card p-6 flex items-center justify-between border-2 border-green-500/30" onclick="openCase(${idx})"><div class="flex items-center gap-6"><img src="img/${c.img}" class="w-24 h-24 object-contain"><div><div class="orbitron text-lg text-green-500 font-black uppercase">${c.name}</div></div></div><div class="bg-green-500 text-black px-5 py-3 rounded-2xl font-black text-sm flex items-center gap-2">${c.price} <img src="img/ticket.png" class="w-4 h-4"></div></div>`;
        } else {
            mGrid.innerHTML += `<div class="case-card p-4 flex flex-col items-center justify-between min-h-[280px]"><div onclick="openCase(${idx})" class="flex flex-col items-center"><img src="img/${c.img}" class="w-28 h-28 mb-2 object-contain"><div class="orbitron text-[10px] text-green-500 font-black mb-4 uppercase text-center">${c.name}</div></div><div class="w-full flex flex-col gap-2"><button onclick="openCase(${idx})" class="w-full bg-white/5 py-2 rounded-xl text-[12px] font-bold">⭐ ${c.priceStars}</button><button onclick="openCase(${idx})" class="w-full bg-blue-500/10 py-2 rounded-xl text-[12px] font-bold text-blue-400">${c.priceTon} TON</button></div></div>`;
        }
    });
}

function startLiveDrop() {
    const rail = document.getElementById('live-drop-rail');
    setInterval(() => {
        const keys = Object.keys(ITEMS);
        const it = ITEMS[keys[Math.floor(Math.random()*keys.length)]];
        const el = document.createElement('div');
        el.className = 'flex-shrink-0 flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/5 animate-fade-in';
        el.innerHTML = `<img src="img/${it.img}" class="w-6 h-6 object-contain"><span class="text-[10px] font-bold text-gray-300">${it.name.split(' ')[0]}</span>`;
        rail.prepend(el);
        if (rail.children.length > 15) rail.removeChild(rail.lastChild);
    }, 3000);
}

window.onload = () => { startLiveDrop(); render(); syncData(); tg.expand(); };
</script>
</body>
</html>
