<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>StarDrop Premium Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --bg-main: #080a08;
            --neon-green: #00ff41;
            --ton-blue: #0088cc;
        }

        body {
            background-color: var(--bg-main);
            color: white;
            font-family: 'Inter', sans-serif;
            margin: 0;
            user-select: none;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        .balance-container-v2 {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .balance-item-v2 { display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
        .balance-item-v2 img { width: 18px; height: 18px; }
        .balance-item-v2 span { font-weight: 900; font-size: 0.9rem; }

        .live-header { display: flex; align-items: center; padding: 20px 20px 10px; gap: 12px; }
        .live-label { font-family: 'Orbitron', sans-serif; font-size: 11px; color: var(--neon-green); text-transform: uppercase; letter-spacing: 3px; }
        .live-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 10px var(--neon-green); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        #live-drop-wrapper {
            width: 100%; height: 60px; overflow: hidden; position: relative;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.02), transparent);
        }
        .live-rail { display: flex; position: absolute; left: 0; top: 0; height: 100%; gap: 12px; padding: 10px; transition: transform 0.5s ease; }

        .roulette-container {
            position: relative; width: 100%; height: 160px; 
            background: #0d1408; margin: 20px 0; overflow: hidden; 
            border-top: 1px solid rgba(163, 230, 53, 0.1); border-bottom: 1px solid rgba(163, 230, 53, 0.1);
        }
        .roulette-container::before, .roulette-container::after {
            content: ''; position: absolute; top: 0; width: 30%; height: 100%; z-index: 10; pointer-events: none;
        }
        .roulette-container::before { left: 0; background: linear-gradient(to right, #080a08 10%, transparent 100%); }
        .roulette-container::after { right: 0; background: linear-gradient(to left, #080a08 10%, transparent 100%); }

        .center-line {
            position: absolute; left: 50%; top: 0; width: 2px; height: 100%; background: #a3e635;
            z-index: 50; transform: translateX(-50%); box-shadow: 0 0 15px rgba(163, 230, 53, 0.8);
        }
        .roulette-rail { display: flex; position: absolute; left: 0; align-items: center; height: 100%; will-change: transform; }
        .roulette-item { 
            min-width: 120px; height: 120px; margin: 0 10px;
            display: flex; align-items: center; justify-content: center; 
            background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 24px;
        }
        .roulette-item img { width: 80px; height: 80px; object-fit: contain; }
        
        .win-glow { 
            border-color: #a3e635 !important; 
            background: rgba(163, 230, 53, 0.15) !important; 
            animation: win-pulse 1s infinite ease-in-out; 
            z-index: 20;
        }
        @keyframes win-pulse {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); }
        }

        .case-card {
            background: linear-gradient(145deg, #121612, #0a0c0a);
            border-radius: 35px; border: 1px solid rgba(255,255,255,0.03);
            transition: transform 0.2s;
        }
        .case-card:active { transform: scale(0.95); }
        .cnt-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); color: white; transition: 0.3s; }
        .cnt-btn.active { background: var(--neon-green); color: black; font-weight: 900; }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="p-6 flex justify-between items-center sticky top-0 z-[100] bg-[#080a08]/90 backdrop-blur-xl border-b border-white/5">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='index.html'" class="flex items-center justify-center w-10 h-10 rounded-full bg-white/5 border border-white/10">
                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </button>
            <div class="orbitron text-2xl font-black italic">STAR<span class="text-green-500">DROP</span></div>
        </div>
        <div class="balance-container-v2">
            <div class="balance-item-v2 text-blue-400"><span id="header-ton">0.00</span><img src="img/ton.png"></div>
            <div class="balance-item-v2 text-yellow-400"><span id="header-stars">0</span><img src="img/star.png"></div>
            <div class="balance-item-v2 text-green-400"><span id="header-tickets">0</span><img src="img/ticket.png"></div>
        </div>
    </header>

    <div class="live-header px-6"><div class="live-dot"></div><div class="live-label">Live Drop</div></div>
    <div id="live-drop-wrapper"><div id="live-drop-rail" class="live-rail"></div></div>

    <div class="p-5 flex flex-col gap-5 pb-24">
        <div id="tickets-container"></div>
        <div class="grid grid-cols-2 gap-5" id="main-grid"></div>
    </div>

    <div id="case-modal" class="fixed inset-0 z-[200] hidden flex-col p-6 bg-[#080a08]/98 backdrop-blur-2xl overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <button id="back-btn" onclick="closeModal()" class="text-gray-500 font-bold text-xs uppercase tracking-widest">← Назад</button>
            <div class="orbitron text-[10px] text-green-500 uppercase">System Ready</div>
        </div>

        <div id="view-preview">
            <div class="flex flex-col items-center mb-8">
                <img id="m-img" src="" class="w-64 h-64 object-contain">
                <h1 id="m-title" class="orbitron text-2xl font-black mt-4 uppercase text-center"></h1>
            </div>
            <div class="flex flex-col items-center gap-6 mb-8">
                <div class="flex gap-2">
                    <button onclick="setMul(1)" class="cnt-btn active w-12 h-12 rounded-xl font-black">1</button>
                    <button onclick="setMul(2)" class="cnt-btn w-12 h-12 rounded-xl font-black">2</button>
                    <button onclick="setMul(3)" class="cnt-btn w-12 h-12 rounded-xl font-black">3</button>
                </div>
                <div class="grid grid-cols-2 gap-4 w-full" id="roll-buttons-container">
                    <button id="btn-stars" onclick="startRoll('stars')" class="bg-green-500 text-black py-4 rounded-3xl font-black flex justify-center items-center gap-2 active:scale-95 transition-transform">
                        <img src="img/star.png" class="w-5 h-5"> <span id="p-stars">0</span>
                    </button>
                    <button id="btn-ton" onclick="startRoll('ton')" class="bg-[#0088cc] text-white py-4 rounded-3xl font-black flex justify-center items-center gap-2 active:scale-95 transition-transform">
                        <img src="img/ton.png" class="w-5 h-5"> <span id="p-ton">0</span>
                    </button>
                </div>
            </div>
            <div id="loot-display" class="grid grid-cols-3 gap-2 pb-10"></div>
        </div>

        <div id="view-roulette" class="hidden flex-col items-center">
            <div class="text-center mb-6">
                <h2 id="roul-title" class="orbitron text-xl font-black uppercase text-white"></h2>
                <div class="orbitron text-[10px] text-green-500 animate-pulse mt-1 uppercase tracking-widest">● Анализ вероятностей...</div>
            </div>
            <div id="roulette-rows" class="w-full"></div>
        </div>

        <div id="view-win" class="hidden flex-col items-center gap-6 mt-10">
            <div id="win-grid" class="flex flex-wrap justify-center gap-4"></div>
            <div class="flex items-center gap-2 bg-white/5 px-6 py-3 rounded-2xl border border-white/5">
                <span class="text-gray-400 text-[10px] uppercase font-bold tracking-widest">Общая ценность:</span>
                <div class="flex items-center gap-1">
                    <img src="img/star.png" class="w-4 h-4">
                    <span id="win-total-price" class="orbitron text-green-500 font-black text-lg">0</span>
                </div>
            </div>
            <div class="w-full flex flex-col gap-3">
                <button id="sell-all-btn" onclick="sellAllAndClose()" class="w-full bg-green-500 text-black py-5 rounded-3xl font-black uppercase text-sm active:scale-95 transition-all">Продать</button>
                <button id="keep-all-btn" onclick="saveToInventoryAndClose()" class="w-full bg-white/5 border border-white/10 text-white py-4 rounded-3xl font-bold uppercase text-xs active:scale-95">В инвентарь</button>
            </div>
        </div>
    </div>

<script>
const tg = window.Telegram.WebApp;
const userId = tg.initDataUnsafe?.user?.id || 12345;

const SB_URL = 'https://mwsbkpfarhdankpyifbm.supabase.co';
const SB_KEY = 'sb_publishable_Bj40x3HKomgXSyLMiVqXig_FqCgOSmA';
const BACKEND_URL = 'https://stars-drop.vercel.app/api';

const headers = { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json' };

const ITEMS = {
    1: { name: "1 May", img: "1may.jpg", price: 100 },
    2: { name: "2025", img: "2025.jpg", price: 500 },
    3: { name: "Bear", img: "bear.png", price: 3500 },
    4: { name: "Book", img: "book.jpg", price: 1000 },
    7: { name: "Jack Box", img: "box.png", price: 600 },
    9: { name: "Rocket", img: "raketa.png", price: 50 },
    18: { name: "Suitcase", img: "chemodan.jpg", price: 5000 },
    21: { name: "Costume", img: "costum.jpg", price: 10000 },
    28: { name: "B-Day Cake", img: "happybirthday.jpg", price: 200 },
    30: { name: "Spartan", img: "helmet.png", price: 25000 },
    40: { name: "Red Cap", img: "kepka.png", price: 100000 },
    51: { name: "SD Token", img: "narkotiki.png", price: 600 },
    56: { name: "Dove Post", img: "otkritka.jpg", price: 150 },
    57: { name: "Easter Cake", img: "paska.jpg", price: 75 },
    59: { name: "Rose", img: "rozza.png", price: 2000 },
    63: { name: "Helmet Biker", img: "shlem.png", price: 3500 },
    66: { name: "Statue", img: "statyya.jpg", price: 41000 },
    70: { name: "Spotted Egg", img: "yayko.png", price: 600 },
    73: { name: "Ring", img: "kolechko.png", price: 100 }
};

const CASES = [
    { name: "Кейс Новичка", type: 'tickets', price: 10, img: "case2.png", loot: [[9, 90], [70, 5], [1, 5]] },
    { name: "Шкатулка Удачи", type: 'stars', price: 100, img: "case2.png", loot: [[9, 99], [70, 0.6], [1, 0.1]] },
    { name: "Мистический", type: 'stars', price: 300, img: "case3.png", loot: [[73, 98], [9, 2]] },
    { name: "Лесной Оазис", type: 'stars', price: 1000, img: "case4.png", loot: [[17, 99], [51, 1]] },
    { name: "Пиратский Клад", type: 'stars', price: 3500, img: "case5.png", loot: [[63, 30], [59, 70]] },
    { name: "Детективный", type: 'stars', price: 5000, img: "case7.png", loot: [[18, 5], [16, 95]] },
    { name: "Технологический", type: 'stars', price: 7500, img: "case8.png", loot: [[63, 10], [59, 90]] },
    { name: "Лимонный", type: 'stars', price: 25000, img: "case9.png", loot: [[21, 50], [18, 50]] }
];

let balance = { stars: 0, ton: 0, tickets: 0 };
let mul = 1, activeCase = null, isBusy = false, currentWinners = [];

async function syncData() {
    try {
        const res = await fetch(`${BACKEND_URL}/get_balance/${userId}?t=${Date.now()}`);
        const data = await res.json();
        balance.stars = parseInt(data.stars || 0);
        balance.ton = parseFloat(data.balance || 0);
        balance.tickets = parseInt(data.tickets || 0);
        saveAndRefresh();
    } catch (e) { console.error("Sync error"); }
}

function saveAndRefresh() {
    document.getElementById('header-stars').innerText = balance.stars.toLocaleString('ru-RU').replace(/\s/g, '.');
    document.getElementById('header-ton').innerText = balance.ton.toFixed(2);
    document.getElementById('header-tickets').innerText = balance.tickets;
}

function render() {
    const tGrid = document.getElementById('tickets-container');
    const mGrid = document.getElementById('main-grid');
    
    // Очищаем контейнеры перед отрисовкой
    tGrid.innerHTML = ''; 
    mGrid.innerHTML = '';
    
    CASES.forEach((c, idx) => {
        if (c.type === 'tickets') {
            // Отрисовка кейса за тикеты (горизонтальный)
            tGrid.innerHTML = `
                <div class="case-card p-6 flex items-center justify-between border-2 border-green-500/30" onclick="openCase(${idx})">
                    <div class="flex items-center gap-6">
                        <img src="img/${c.img}" class="w-24 h-24 object-contain text-white">
                        <div>
                            <div class="orbitron text-lg text-green-500 font-black uppercase">${c.name}</div>
                            <div class="text-[10px] opacity-50 uppercase tracking-widest">Эксклюзив за тикеты</div>
                        </div>
                    </div>
                    <div class="bg-green-500 text-black px-5 py-3 rounded-2xl font-black text-sm flex items-center gap-2">
                         ${c.price} <img src="img/ticket.png" class="w-4 h-4">
                    </div>
                </div>`;
        } else {
            // Отрисовка обычных кейсов (сетка 2х2)
            mGrid.innerHTML += `
                <div class="case-card p-8 flex flex-col items-center justify-center min-h-[220px]" onclick="openCase(${idx})">
                    <img src="img/${c.img}" class="w-32 h-32 mb-4 object-contain drop-shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                    <div class="orbitron text-xs text-green-500 font-black mb-2 uppercase text-center">${c.name}</div>
                    <div class="bg-white/5 px-4 py-1 rounded-full text-[12px] font-bold opacity-70 uppercase tracking-tighter">
                        ⭐ ${c.price}
                    </div>
                </div>`;
        }
    });
}

function openCase(i) {
    activeCase = CASES[i];
    setMul(1);
    document.getElementById('case-modal').style.display = 'flex';
    document.getElementById('view-preview').style.display = 'block';
    document.getElementById('view-roulette').style.display = 'none';
    document.getElementById('view-win').style.display = 'none';
    document.getElementById('m-img').src = `img/${activeCase.img}`;
    document.getElementById('m-title').innerText = activeCase.name;

    const btnStars = document.getElementById('btn-stars');
    const btnTon = document.getElementById('btn-ton');
    let btnTickets = document.getElementById('btn-tickets-roll');

    if (!btnTickets) {
        btnTickets = document.createElement('button');
        btnTickets.id = 'btn-tickets-roll';
        btnTickets.onclick = () => startRoll('tickets');
        btnTickets.className = "col-span-2 bg-green-500 text-black py-4 rounded-3xl font-black flex justify-center items-center gap-2 active:scale-95 transition-transform hidden";
        document.getElementById('roll-buttons-container').appendChild(btnTickets);
    }

    if (activeCase.type === 'tickets') {
        btnStars.classList.add('hidden'); btnTon.classList.add('hidden');
        btnTickets.classList.remove('hidden');
        btnTickets.innerHTML = `<img src="img/ticket.png" class="w-5 h-5"> <span id="p-tickets">${activeCase.price}</span>`;
    } else {
        btnStars.classList.remove('hidden'); btnTon.classList.remove('hidden');
        btnTickets.classList.add('hidden');
        document.getElementById('p-stars').innerText = activeCase.price;
        document.getElementById('p-ton').innerText = (activeCase.price / 100).toFixed(2);
    }

    document.getElementById('loot-display').innerHTML = activeCase.loot.map(attr => {
        const itm = ITEMS[attr[0]];
        return `<div class="bg-white/5 rounded-2xl p-2 flex flex-col items-center border border-white/5">
            <img src="img/${itm.img}" class="w-10 h-10 mb-1 object-contain">
            <div class="text-[8px] text-green-500">⭐${itm.price}</div>
        </div>`;
    }).join('');
}

function setMul(n) {
    mul = n;
    document.querySelectorAll('.cnt-btn').forEach(b => b.classList.toggle('active', parseInt(b.innerText) === n));
    if (activeCase.type === 'tickets') {
        if(document.getElementById('p-tickets')) document.getElementById('p-tickets').innerText = activeCase.price * n;
    } else {
        document.getElementById('p-stars').innerText = activeCase.price * n;
        document.getElementById('p-ton').innerText = ((activeCase.price / 100) * n).toFixed(2);
    }
}

async function startRoll(type) {
    if (isBusy) return;
    const cost = (type === 'tickets') ? activeCase.price * mul : (type === 'stars' ? activeCase.price * mul : (activeCase.price / 100) * mul);
    if (balance[type] < cost) return alert("Недостаточно средств!");
    
    isBusy = true;
    balance[type] -= cost;
    saveAndRefresh();

    try {
        const field = type === 'stars' ? 'stars' : (type === 'tickets' ? 'tickets' : 'balance');
        await fetch(`${SB_URL}/rest/v1/users?user_id=eq.${userId}`, {
            method: 'PATCH', headers, body: JSON.stringify({ [field]: balance[type] })
        });

        document.getElementById('back-btn').style.display = 'none';
        document.getElementById('view-preview').style.display = 'none';
        document.getElementById('view-roulette').style.display = 'flex';
        document.getElementById('roulette-rows').innerHTML = '';

        const winners = [];
        for (let i = 0; i < mul; i++) {
            const win = getWin(); winners.push(win); createRow(i, win);
        }
        setTimeout(() => showWin(winners), 7200);
    } catch (e) { alert("Ошибка транзакции"); isBusy = false; }
}

function getWin() {
    const pool = activeCase.loot.map(attr => ({ id: attr[0], weight: attr[1], ...ITEMS[attr[0]] }));
    const total = pool.reduce((s, i) => s + i.weight, 0);
    let rnd = Math.random() * total;
    for (let i of pool) { if (rnd < i.weight) return i; rnd -= i.weight; }
    return pool[0];
}

function createRow(idx, win) {
    const row = document.createElement('div');
    row.className = 'roulette-container mb-4';
    row.innerHTML = `<div class="center-line"></div><div class="roulette-rail" id="rail-${idx}"></div>`;
    document.getElementById('roulette-rows').appendChild(row);

    const rail = document.getElementById(`rail-${idx}`);
    const winIndex = 35;
    let html = '';
    for (let i = 0; i < 45; i++) {
        const rId = activeCase.loot[Math.floor(Math.random() * activeCase.loot.length)][0];
        const finalId = (i === winIndex) ? win.id : rId;
        html += `<div class="roulette-item" id="item-${idx}-${i}"><img src="img/${ITEMS[finalId].img}"></div>`;
    }
    rail.innerHTML = html;

    setTimeout(() => {
        const shift = (winIndex * 140) - (window.innerWidth / 2) + 70;
        rail.style.transition = 'transform 6.5s cubic-bezier(0.1, 0, 0.05, 1)';
        rail.style.transform = `translateX(-${shift}px)`;
        setTimeout(() => {
            const winEl = document.getElementById(`item-${idx}-${winIndex}`);
            if(winEl) winEl.classList.add('win-glow');
        }, 6500);
    }, 100);
}

function showWin(winners) {
    currentWinners = winners;
    document.getElementById('view-roulette').style.display = 'none';
    document.getElementById('view-win').style.display = 'flex';
    let total = 0, grid = '';
    winners.forEach(w => {
        total += w.price;
        grid += `<div class="bg-white/5 p-4 rounded-[30px] border border-white/10 flex flex-col items-center min-w-[100px]">
            <img src="img/${w.img}" class="w-14 h-14 object-contain">
            <div class="orbitron text-[8px] text-green-500 mt-2 uppercase font-black">${w.name}</div>
        </div>`;
    });
    document.getElementById('win-grid').innerHTML = grid;
    document.getElementById('win-total-price').innerText = total;
    document.getElementById('sell-all-btn').innerText = `Продать: ${total} ⭐`;
    document.getElementById('back-btn').style.display = 'block';
    isBusy = false;
}

function closeModal() { document.getElementById('case-modal').style.display = 'none'; isBusy = false; }

render();
syncData();
</script>
</body>
</html>
