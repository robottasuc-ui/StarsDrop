<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>StarsDrop - Cases</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@700;900&display=swap');
        body { background: #0a1205; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .case-glow { box-shadow: 0 0 30px rgba(163, 230, 53, 0.15); border: 1px solid rgba(163, 230, 53, 0.2); }
        .win-anim { animation: winScale 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes winScale { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .back-btn { position: fixed; top: 20px; left: 20px; z-index: 100; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 12px; border: 1px solid rgba(163,230,53,0.3); }
    </style>
</head>
<body class="p-4">

    <div class="back-btn" onclick="location.href='index.html'">
        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path>
        </svg>
    </div>

    <div class="flex justify-end gap-3 mb-8 mt-2">
        <div class="bg-black/40 px-4 py-2 rounded-full border border-green-500/30 flex items-center gap-2">
            <span id="bal-ton" class="font-black text-blue-400">0.00</span>
            <img src="ton.png" class="w-5 h-5">
        </div>
        <div class="bg-black/40 px-4 py-2 rounded-full border border-yellow-500/30 flex items-center gap-2">
            <span id="bal-stars" class="font-black text-yellow-400">0</span>
            <img src="star.png" class="w-5 h-5">
        </div>
    </div>

    <div class="text-center mb-10">
        <h1 class="text-3xl font-black italic uppercase tracking-tighter">Кейс <span class="text-green-500">Ultimate</span></h1>
        <p class="text-gray-500 text-xs font-bold mt-1">ЦЕНА: 100 STARS</p>
    </div>

    <div class="relative w-full h-40 bg-black/50 rounded-3xl border-2 border-green-500/20 overflow-hidden mb-10">
        <div id="roulette-line" class="absolute top-0 left-1/2 w-1 h-full bg-green-500 z-10 shadow-[0_0_15px_#a3e635]"></div>
        <div id="case-container" class="flex items-center h-full transition-transform duration-[5s] cubic-bezier(0.15, 0, 0.15, 1)">
            </div>
    </div>

    <button id="open-btn" onclick="startOpening()" class="w-full bg-green-500 hover:bg-green-400 text-black font-black py-5 rounded-2xl shadow-[0_10px_20px_rgba(163,230,53,0.3)] transition-all active:scale-95 uppercase">
        Открыть кейс
    </button>

    <div class="mt-12">
        <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-widest mb-4 text-center">Возможное содержимое</h2>
        <div id="drop-list" class="grid grid-cols-3 gap-3">
            </div>
    </div>

    <div id="win-modal" class="fixed inset-0 bg-black/90 z-[200] hidden flex-col items-center justify-center p-6 text-center">
        <div class="win-anim">
            <div class="text-green-500 font-black text-sm uppercase tracking-widest mb-2">Вы выбили</div>
            <img id="win-img" src="" class="w-48 h-48 object-contain mb-4 drop-shadow-[0_0_30px_rgba(163,230,53,0.5)]">
            <div id="win-name" class="text-3xl font-black uppercase mb-8">ITEM NAME</div>
            <button onclick="collectWin()" class="bg-white text-black font-black px-12 py-4 rounded-xl uppercase tracking-tighter active:scale-90 transition-all">Забрать в профиль</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const BACKEND_URL = 'https://stars-drop.vercel.app/api';
        const user = tg.initDataUnsafe?.user;

        // Нормальный список предметов с шансами и ценами
        const ITEMS = [
            { id: 1, name: "Rocket", img: "rocket.png", price: 15, rarity: 0.5 },
            { id: 2, name: "Lolipop", img: "spin.png", price: 400, rarity: 0.2 },
            { id: 3, name: "Mystic Egg", img: "hero.png", price: 550, rarity: 0.15 },
            { id: 4, name: "Laser Sword", img: "mini.png", price: 1200, rarity: 0.1 },
            { id: 5, name: "Cyber Bear", img: "case.png", price: 3500, rarity: 0.05 }
        ];

        let isRolling = false;
        let wonItem = null;

        // 1. Синхронизация баланса
        async function syncBalance() {
            const localStars = localStorage.getItem('user_stars') || 0;
            const localTon = localStorage.getItem('user_ton') || "0.00";
            document.getElementById('bal-stars').innerText = localStars;
            document.getElementById('bal-ton').innerText = localTon;

            if (user?.id) {
                try {
                    const res = await fetch(`${BACKEND_URL}/get_balance/${user.id}`);
                    const data = await res.json();
                    document.getElementById('bal-stars').innerText = data.stars;
                    document.getElementById('bal-ton').innerText = data.balance.toFixed(2);
                    localStorage.setItem('user_stars', data.stars);
                } catch(e) {}
            }
        }

        // 2. Отрисовка дропа снизу (без тупых повторов)
        function renderDropList() {
            const list = document.getElementById('drop-list');
            list.innerHTML = ITEMS.map(item => `
                <div class="bg-white/5 border border-white/10 p-4 rounded-2xl flex flex-col items-center">
                    <img src="${item.img}" class="w-10 h-10 mb-2 object-contain">
                    <div class="text-[10px] font-black uppercase">${item.name}</div>
                    <div class="text-[8px] text-green-500 font-bold">${item.price} ⭐</div>
                </div>
            `).join('');
        }

        // 3. Логика открытия
        function startOpening() {
            if (isRolling) return;
            const currentStars = parseInt(localStorage.getItem('user_stars') || 0);
            if (currentStars < 100) return tg.showAlert("Недостаточно звезд! Пополни баланс на главной.");

            isRolling = true;
            tg.HapticFeedback.impactOccurred('heavy');
            
            const container = document.getElementById('case-container');
            container.style.transition = 'none';
            container.style.transform = 'translateX(0)';
            
            // Генерируем 50 предметов для прокрутки
            let html = '';
            for(let i=0; i<50; i++) {
                const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
                html += `<div class="min-w-[120px] flex flex-col items-center justify-center">
                            <img src="${item.img}" class="w-20 h-20 object-contain">
                         </div>`;
            }
            container.innerHTML = html;

            // Выбираем победителя по шансам
            wonItem = getWeightedRandom();

            // Вставляем победителя на 45-ю позицию
            const winIndex = 44;
            const items = container.children;
            items[winIndex].innerHTML = `<img src="${wonItem.img}" class="w-20 h-20 object-contain">`;

            setTimeout(() => {
                container.style.transition = 'transform 5s cubic-bezier(0.15, 0, 0.15, 1)';
                const shift = (winIndex * 120) - (window.innerWidth / 2) + 60;
                container.style.transform = `translateX(-${shift}px)`;
            }, 50);

            setTimeout(() => {
                showWin(wonItem);
                isRolling = false;
            }, 5200);
        }

        function getWeightedRandom() {
            const rand = Math.random();
            let cumulative = 0;
            for (const item of ITEMS) {
                cumulative += item.rarity;
                if (rand < cumulative) return item;
            }
            return ITEMS[0];
        }

        function showWin(item) {
            document.getElementById('win-img').src = item.img;
            document.getElementById('win-name').innerText = item.name;
            document.getElementById('win-modal').style.display = 'flex';
            tg.HapticFeedback.notificationOccurred('success');
        }

        // КНОПКА ЗАБРАТЬ - ТЕПЕРЬ РАБОТАЕТ
        async function collectWin() {
            if (!user) return location.reload();

            try {
                // Списываем 100 за кейс и прибавляем цену шмотки (или саму шмотку в будущем)
                // Сейчас для простоты начислим "стоимость" шмотки в звездах
                await fetch(`${BACKEND_URL}/update_balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user.id,
                        stars: wonItem.price - 100, // Цена шмотки минус цена кейса
                        points: 1
                    })
                });
                
                tg.showAlert(`Предмет ${wonItem.name} добавлен в коллекцию!`);
                location.href = 'index.html'; // Возвращаемся, чтобы обновить профиль
            } catch (e) {
                tg.showAlert("Ошибка сохранения. Попробуй еще раз.");
            }
        }

        window.onload = () => {
            syncBalance();
            renderDropList();
        };
    </script>
</body>
</html>
