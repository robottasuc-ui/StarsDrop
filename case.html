<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>StarDrop Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@400;700;900&display=swap');
        :root { --bg-main: #080a08; --neon-green: #00ff41; }
        body { background-color: var(--bg-main); color: white; font-family: 'Inter', sans-serif; user-select: none; overflow-x: hidden; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .roulette-container { position: relative; width: 100%; height: 180px; background: rgba(0,0,0,0.8); margin: 20px 0; overflow: hidden; border-top: 1px solid rgba(0,255,65,0.1); border-bottom: 1px solid rgba(0,255,65,0.1); }
        .center-line { position: absolute; left: 50%; width: 3px; height: 100%; background: var(--neon-green); z-index: 50; transform: translateX(-50%); box-shadow: 0 0 20px var(--neon-green); }
        .roulette-rail { display: flex; position: absolute; left: 0; align-items: center; height: 100%; will-change: transform; }
        .roulette-item { min-width: 140px; display: flex; justify-content: center; opacity: 0.3; filter: grayscale(1); transition: 0.5s; }
        .roulette-item img { width: 90px; height: 90px; object-fit: contain; }
        .win-glow { opacity: 1 !important; filter: grayscale(0) drop-shadow(0 0 20px var(--neon-green)); transform: scale(1.1); }
        .case-card { background: #121612; border-radius: 25px; border: 1px solid rgba(255,255,255,0.05); }
        #case-modal { backdrop-filter: blur(20px); background: rgba(8, 10, 8, 0.95); }
        .cnt-btn { background: rgba(255,255,255,0.05); border-radius: 12px; transition: 0.2s; }
        .cnt-btn.active { background: var(--neon-green); color: black; font-weight: 900; }
        .back-link { position: absolute; top: 25px; left: 20px; color: #555; font-weight: 900; font-size: 12px; z-index: 110; }
    </style>
</head>
<body>

    <a href="index.html" class="back-link uppercase">← Назад</a>

    <header class="p-6 flex justify-between items-center sticky top-0 z-[100] bg-[#080a08]/90 border-b border-white/5">
        <div class="orbitron text-xl font-black italic">STAR<span class="text-green-500">DROP</span></div>
        <div class="flex flex-col items-end gap-1">
            <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-xl border border-white/10 text-xs">
                <img src="img/star.png" class="w-3"> <b id="header-stars">...</b>
            </div>
            <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-xl border border-white/10 text-xs">
                <img src="img/ton.png" class="w-3"> <b id="header-ton" class="text-[#0088cc]">...</b>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-2 gap-4 p-4" id="main-grid"></div>

    <div id="case-modal" class="fixed inset-0 z-[200] hidden flex-col p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-6 mt-4">
            <button onclick="closeModal()" class="text-gray-500 font-bold text-xs uppercase">← Отмена</button>
            <div class="orbitron text-[10px] text-green-500">System Active</div>
        </div>

        <div id="view-preview">
            <div class="flex flex-col items-center mb-6">
                <img id="m-img" src="" class="w-48 h-48 object-contain drop-shadow-2xl">
                <h1 id="m-title" class="orbitron text-xl font-black mt-4 uppercase text-center"></h1>
            </div>

            <div class="flex flex-col items-center gap-4 mb-8">
                <div class="flex gap-2">
                    <button onclick="setMul(1)" class="cnt-btn active w-10 h-10">1</button>
                    <button onclick="setMul(2)" class="cnt-btn w-10 h-10">2</button>
                    <button onclick="setMul(3)" class="cnt-btn w-10 h-10">3</button>
                </div>
                <button onclick="startRoll('stars')" class="w-full bg-green-500 text-black py-4 rounded-2xl font-black uppercase shadow-lg shadow-green-500/20">
                    Открыть за ⭐ <span id="p-stars">0</span>
                </button>
            </div>

            <div id="loot-display" class="grid grid-cols-3 gap-2 opacity-60"></div>
        </div>

        <div id="view-roulette" class="hidden flex-col items-center justify-center min-h-[40vh]">
            <div id="roulette-rows" class="w-full"></div>
        </div>

        <div id="view-win" class="hidden flex-col items-center gap-6 mt-6">
            <div id="win-grid" class="flex flex-wrap justify-center gap-4"></div>
            <button onclick="saveToInventory()" class="w-full bg-white text-black py-5 rounded-2xl font-black uppercase">Забрать в профиль</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const BACKEND_URL = 'https://stars-drop.vercel.app/api';
        const user = tg.initDataUnsafe?.user;

        const ITEMS = {
            1: { id:1, name: "Rocket", img: "img/raketa.png", price: 15, weight: 100 },
            2: { id:2, name: "Sword", img: "img/metch.png", price: 500, weight: 20 },
            4: { id:4, name: "Cat", img: "img/kot.png", price: 12500, weight: 1 },
            5: { id:5, name: "Bear", img: "img/bear.png", price: 3500, weight: 5 },
            6: { id:6, name: "Egg", img: "img/yayko.png", price: 550, weight: 15 },
            9: { id:9, name: "Pop", img: "img/lolipop.png", price: 400, weight: 40 }
        };

        const CASES = [
            { name: "Шкатулка", stars: 100, ton: 1, img: "case2.png", loot: [1,9,6,2] },
            { name: "Адская Печать", stars: 2000, ton: 13, img: "case7.png", loot: [2,5,4] }
        ];

        let currentBalance = { stars: 0, ton: 0 };
        let mul = 1, activeCase = null, winners = [];

        async function syncBalance() {
            if (!user) return;
            try {
                const res = await fetch(`${BACKEND_URL}/get_balance/${user.id}`);
                const data = await res.json();
                currentBalance.stars = data.stars;
                currentBalance.ton = data.balance;
                document.getElementById('header-stars').innerText = data.stars.toLocaleString();
                document.getElementById('header-ton').innerText = data.balance.toFixed(2);
            } catch (e) { console.error("Sync error"); }
        }

        function render() {
            document.getElementById('main-grid').innerHTML = CASES.map((c, i) => `
                <div class="case-card p-5 flex flex-col items-center" onclick="openCase(${i})">
                    <img src="img/${c.img}" class="w-20 h-20 mb-3 object-contain">
                    <div class="orbitron text-[10px] text-green-500 font-black">${c.name}</div>
                    <div class="text-[10px] opacity-40">⭐ ${c.stars}</div>
                </div>
            `).join('');
        }

        function openCase(i) {
            activeCase = CASES[i]; setMul(1);
            document.getElementById('case-modal').style.display = 'flex';
            document.getElementById('view-preview').classList.remove('hidden');
            document.getElementById('view-roulette').classList.add('hidden');
            document.getElementById('view-win').classList.add('hidden');
            document.getElementById('m-img').src = `img/${activeCase.img}`;
            document.getElementById('m-title').innerText = activeCase.name;
            document.getElementById('loot-display').innerHTML = activeCase.loot.map(id => `
                <div class="flex flex-col items-center bg-white/5 p-2 rounded-lg">
                    <img src="${ITEMS[id].img}" class="w-8 h-8">
                    <div class="text-[6px] mt-1 uppercase">${ITEMS[id].name}</div>
                </div>`).join('');
        }

        function setMul(n) {
            mul = n;
            document.querySelectorAll('.cnt-btn').forEach((b, i) => b.classList.toggle('active', i === n-1));
            document.getElementById('p-stars').innerText = activeCase.stars * n;
        }

        function startRoll(type) {
            const cost = activeCase.stars * mul;
            if(currentBalance.stars < cost) return tg.showAlert("Недостаточно звёзд!");
            
            tg.HapticFeedback.impactOccurred('medium');
            document.getElementById('view-preview').classList.add('hidden');
            document.getElementById('view-roulette').classList.remove('hidden');
            document.getElementById('roulette-rows').innerHTML = '';
            
            winners = [];
            for(let i=0; i<mul; i++) {
                const win = getWin(); 
                winners.push(win);
                createRow(i, win);
            }
            setTimeout(() => { showWinDisplay(); }, 8500);
        }

        function getWin() {
            const pool = activeCase.loot.map(id => ITEMS[id]);
            const total = pool.reduce((s, it) => s + it.weight, 0);
            let rnd = Math.random() * total;
            for(let it of pool) { if(rnd < it.weight) return it; rnd -= it.weight; }
            return pool[0];
        }

        function createRow(idx, win) {
            const row = document.createElement('div');
            row.className = 'roulette-container mb-2';
            row.innerHTML = `<div class="center-line"></div><div class="roulette-rail" id="rail-${idx}"></div>`;
            document.getElementById('roulette-rows').appendChild(row);
            const rail = document.getElementById(`rail-${idx}`);
            let html = '';
            for(let i=0; i<85; i++) {
                const it = (i === 80) ? win : ITEMS[activeCase.loot[Math.floor(Math.random()*activeCase.loot.length)]];
                html += `<div class="roulette-item ${i===80?'win-target':''}"><img src="${it.img}"></div>`;
            }
            rail.innerHTML = html;
            setTimeout(() => {
                rail.style.transition = 'transform 8s cubic-bezier(0.1, 0, 0.05, 1)';
                rail.style.transform = `translateX(-${(80 * 140) - (window.innerWidth / 2) + 70}px)`;
                setTimeout(() => rail.querySelector('.win-target').classList.add('win-glow'), 8000);
            }, 50);
        }

        function showWinDisplay() {
            document.getElementById('view-roulette').classList.add('hidden');
            document.getElementById('view-win').classList.remove('hidden');
            document.getElementById('win-grid').innerHTML = winners.map(w => `
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 flex flex-col items-center">
                    <img src="${w.img}" class="w-16 h-16">
                    <div class="orbitron text-[10px] text-green-500 mt-2">${w.name}</div>
                </div>`).join('');
        }

        // КЛЮЧЕВАЯ ФУНКЦИЯ: ЗАПИСЬ В ИНВЕНТАРЬ
        function saveToInventory() {
            let inv = JSON.parse(localStorage.getItem('user_inventory')) || [];
            winners.forEach(w => { if(inv.length < 6) inv.push(w); });
            localStorage.setItem('user_inventory', JSON.stringify(inv));
            tg.showAlert("Предметы добавлены в профиль!");
            closeModal();
            syncBalance();
        }

        function closeModal() { document.getElementById('case-modal').style.display = 'none'; }
        window.onload = () => { syncBalance(); render(); };
    </script>
</body>
</html>
