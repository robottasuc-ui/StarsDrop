<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>StarDrop Premium Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --bg-main: #080a08;
            --neon-green: #00ff41;
            --ton-blue: #0088cc;
        }

        body {
            background-color: var(--bg-main);
            color: white;
            font-family: 'Inter', sans-serif;
            margin: 0;
            user-select: none;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ФИКС ИКОНОК В КНОПКАХ */
        button img {
            width: 20px !important;
            height: 20px !important;
            object-fit: contain;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        .balance-container-v2 {
            display: flex; flex-direction: column; gap: 4px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 12px; border-radius: 18px;
            backdrop-filter: blur(15px);
        }
        .balance-item-v2 { display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
        .balance-item-v2 img { width: 18px; height: 18px; }
        .balance-item-v2 span { font-weight: 900; font-size: 0.9rem; }

        .live-header { display: flex; align-items: center; padding: 20px 20px 10px; gap: 12px; }
        .live-label { font-family: 'Orbitron', sans-serif; font-size: 11px; color: var(--neon-green); text-transform: uppercase; letter-spacing: 3px; }
        .live-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 10px var(--neon-green); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        #live-drop-wrapper {
            width: 100%; height: 100px; overflow: hidden; position: relative;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.02), transparent);
        }
        .live-rail { display: flex; position: absolute; left: 0; top: 0; height: 100%; gap: 12px; padding: 10px; }
        .drop-item {
            min-width: 80px; height: 80px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07);
            border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .drop-item img { width: 35px; height: 35px; object-fit: contain; }

        .roulette-container {
            position: relative; width: 100%; height: 160px; 
            background: #0d1408; margin: 20px 0; overflow: hidden; 
            border-top: 1px solid rgba(163, 230, 53, 0.1); border-bottom: 1px solid rgba(163, 230, 53, 0.1);
        }
        .roulette-container::before, .roulette-container::after {
            content: ''; position: absolute; top: 0; width: 30%; height: 100%; z-index: 10; pointer-events: none;
        }
        .roulette-container::before { left: 0; background: linear-gradient(to right, #080a08 10%, transparent 100%); }
        .roulette-container::after { right: 0; background: linear-gradient(to left, #080a08 10%, transparent 100%); }

        .center-line {
            position: absolute; left: 50%; top: 0; width: 2px; height: 100%; background: #a3e635;
            z-index: 50; transform: translateX(-50%); box-shadow: 0 0 15px rgba(163, 230, 53, 0.8);
        }
        .roulette-rail { display: flex; position: absolute; left: 0; align-items: center; height: 100%; will-change: transform; }
        .roulette-item { 
            min-width: 120px; height: 120px; margin: 0 10px;
            display: flex; align-items: center; justify-content: center; 
            background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 24px;
        }
        .roulette-item img { width: 80px; height: 80px; object-fit: contain; }
        .win-glow { border-color: #a3e635 !important; background: rgba(163, 230, 53, 0.1) !important; box-shadow: 0 0 30px rgba(163, 230, 53, 0.2); }

        .scan-text { animation: blink 1.5s infinite; color: var(--neon-green); font-size: 10px; letter-spacing: 2px; }
        @keyframes blink { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

        .possible-loot-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            padding: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 24px;
        }
        .loot-preview-card { aspect-ratio: 1; background: rgba(0, 0, 0, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255, 255, 255, 0.05); }
        .loot-preview-card img { width: 65%; opacity: 0.5; }

        .case-card {
            background: linear-gradient(145deg, #121612, #0a0c0a);
            border-radius: 35px; border: 1px solid rgba(255,255,255,0.03);
            transition: transform 0.2s;
        }
        .case-card:active { transform: scale(0.95); }
        .cnt-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); color: white; transition: 0.3s; }
        .cnt-btn.active { background: var(--neon-green); color: black; font-weight: 900; box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
    </style>
</head>
<body>

    <header class="p-6 flex justify-between items-center sticky top-0 z-[100] bg-[#080a08]/90 backdrop-blur-xl border-b border-white/5">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='index.html'" class="flex items-center justify-center w-10 h-10 rounded-full bg-white/5 border border-white/10 active:scale-90 transition-transform">
                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="orbitron text-2xl font-black italic cursor-pointer" onclick="window.location.href='index.html'">STAR<span class="text-green-500">DROP</span></div>
        </div>
        
        <div class="balance-container-v2">
            <div class="balance-item-v2 text-blue-400"><span id="header-ton">0.00</span><img src="img/ton.png"></div>
            <div class="balance-item-v2 text-yellow-400"><span id="header-stars">0</span><img src="img/star.png"></div>
        </div>
    </header>

    <div class="live-header px-6"><div class="live-dot"></div><div class="live-label">Live Drop</div></div>
    <div id="live-drop-wrapper"><div id="live-drop-rail" class="live-rail"></div></div>

    <div class="grid grid-cols-2 gap-5 p-5 pb-24" id="main-grid"></div>

    <div id="case-modal" class="fixed inset-0 z-[200] hidden flex-col p-6 bg-[#080a08]/98 backdrop-blur-2xl overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <button onclick="closeModal()" class="text-gray-500 font-bold text-xs uppercase tracking-widest">← Назад</button>
            <div class="orbitron text-[10px] text-green-500 uppercase">System Ready</div>
        </div>

        <div id="view-preview">
            <div class="flex flex-col items-center mb-8">
                <img id="m-img" src="" class="w-64 h-64 object-contain">
                <h1 id="m-title" class="orbitron text-2xl font-black mt-4 uppercase text-center"></h1>
            </div>
            <div class="flex flex-col items-center gap-6 mb-8">
                <div class="flex gap-2">
                    <button onclick="setMul(1)" class="cnt-btn active w-12 h-12 rounded-xl font-black">1</button>
                    <button onclick="setMul(2)" class="cnt-btn w-12 h-12 rounded-xl font-black">2</button>
                    <button onclick="setMul(3)" class="cnt-btn w-12 h-12 rounded-xl font-black">3</button>
                </div>
                <div class="grid grid-cols-2 gap-4 w-full">
                    <button onclick="startRoll('stars')" class="bg-green-500 text-black py-4 rounded-3xl font-black flex justify-center items-center gap-2">
                        <img src="img/star.png"> <span id="p-stars">0</span>
                    </button>
                    <button onclick="startRoll('ton')" class="bg-[#0088cc] text-white py-4 rounded-3xl font-black flex justify-center items-center gap-2">
                        <img src="img/ton.png"> <span id="p-ton">0</span>
                    </button>
                </div>
            </div>
            <div id="loot-display" class="grid grid-cols-3 gap-2 pb-10"></div>
        </div>

        <div id="view-roulette" class="hidden flex-col items-center">
            <div class="text-center mb-6">
                <h2 id="roul-title" class="orbitron text-xl font-black uppercase text-white"></h2>
                <div class="scan-text orbitron uppercase mt-1">● СКАНИРОВАНИЕ СИСТЕМЫ...</div>
            </div>
            <div id="roulette-rows" class="w-full"></div>
            <div class="w-full mt-8">
                <div class="orbitron text-[10px] text-gray-500 mb-3 text-center uppercase">Возможные призы:</div>
                <div id="possible-loot" class="possible-loot-grid"></div>
            </div>
        </div>

        <div id="view-win" class="hidden flex-col items-center gap-6 mt-10">
            <div id="win-grid" class="flex flex-wrap justify-center gap-4"></div>
            <div class="w-full space-y-3 pt-6">
                <button onclick="saveToInventoryAndClose()" class="w-full bg-white text-black py-5 rounded-3xl font-black uppercase">Забрать</button>
                <button id="sell-btn" class="w-full bg-white/5 border border-white/10 text-green-500 py-5 rounded-3xl font-black uppercase flex justify-center items-center gap-2">
                    Продать за <img src="img/star.png"> <span id="sell-price">0</span>
                </button>
            </div>
        </div>
    </div>

    <script>
    const tg = window.Telegram.WebApp;
    const BACKEND_URL = 'https://stars-drop.vercel.app/api';
    const user = tg.initDataUnsafe?.user;

    let currentWinners = [];
    let balance = { stars: 1000, ton: 5.00 }; // Стартовый баланс для теста
    let mul = 1;
    let activeCase = null;

    const ITEMS = {
        1: { name: "1 May", img: "1may.jpg", price: 100 },
        2: { name: "2025", img: "2025.jpg", price: 500 },
        3: { name: "Bear", img: "bear.png", price: 3500 },
        4: { name: "Book", img: "book.jpg", price: 1000 },
        5: { name: "Berry Box", img: "boooox.png", price: 700 },
        6: { name: "Boot", img: "botinok.png", price: 400 },
        7: { name: "Jack Box", img: "box.png", price: 600 },
        8: { name: "Car", img: "car.png", price: 5000 },
        9: { name: "Rocket", img: "raketa.png", price: 50 },
        16: { name: "Star Ring", img: "ccolso2.png", price: 3000 },
        17: { name: "Gingerbread", img: "cerrrdce.jpg", price: 500 },
        18: { name: "Suitcase", img: "chemodan.jpg", price: 5000 },
        19: { name: "Cigar", img: "ciga.png", price: 3000 },
        20: { name: "Blue Ring", img: "colso.png", price: 2500 },
        21: { name: "Costume", img: "costum.jpg", price: 10000 },
        22: { name: "Flower", img: "cvetok.png", price: 1000 },
        23: { name: "Rich Dog", img: "dog.png", price: 500 },
        24: { name: "Perfume", img: "dyxi.png", price: 10000 },
        25: { name: "Lantern", img: "fonarik.jpg", price: 100 },
        26: { name: "Coffin", img: "grob.jpg", price: 5000 },
        27: { name: "Lava Lips", img: "gyba.png", price: 5000 },
        28: { name: "B-Day Cake", img: "happybirthday.jpg", price: 200 },
        29: { name: "Heart Lock", img: "heart.png", price: 2000 },
        30: { name: "Spartan", img: "helmet.png", price: 25000 },
        39: { name: "Calendar", img: "kalendar.png", price: 400 },
        40: { name: "Red Cap", img: "kepka.png", price: 100000 },
        41: { name: "Brick", img: "kirpitch.jpg", price: 10000 },
        42: { name: "Cocktail", img: "koks.jpg", price: 150 },
        43: { name: "Green Mix", img: "koktel.png", price: 500 },
        44: { name: "Atomic Cat", img: "kot.png", price: 10000 },
        45: { name: "Cauldron", img: "kotel.png", price: 500 },
        46: { name: "Bow Tie", img: "krovatka.jpg", price: 600 },
        47: { name: "Lollipop", img: "lolipop.png", price: 500 },
        48: { name: "Clover", img: "lucky.jpg", price: 500 },
        49: { name: "Muffin", img: "mafin.jpg", price: 700 },
        50: { name: "Lightsaber", img: "metch.png", price: 700 },
        51: { name: "SD Token", img: "narkotiki.png", price: 600 },
        53: { name: "Sneakers", img: "obyv.jpg", price: 10000 },
        54: { name: "Glasses", img: "otchki.jpg", price: 30000 },
        55: { name: "Eagle", img: "orel.jpg", price: 5000 },
        56: { name: "Dove Post", img: "otkritka.jpg", price: 150 },
        57: { name: "Easter Cake", img: "paska.jpg", price: 75 },
        59: { name: "Rose", img: "rozza.png", price: 2000 },
        60: { name: "Backpack", img: "rykzak.jpg", price: 500 },
        61: { name: "Santa Hat", img: "shapka.png", price: 500 },
        62: { name: "Crystal Ball", img: "shar.jpg", price: 1000 },
        63: { name: "Helmet Biker", img: "shlem.png", price: 3500 },
        64: { name: "Pacifier", img: "soska.jpg", price: 3000 },
        65: { name: "Golden Star", img: "star.png", price: 15 },
        66: { name: "Statue", img: "statyya.jpg", price: 41000 },
        69: { name: "Wreath", img: "venok.jpg", price: 500 },
        70: { name: "Spotted Egg", img: "yayko.png", price: 600 },
        71: { name: "Green Slime", img: "zhele.png", price: 700 },
        72: { name: "Snake", img: "zmei.png", price: 500 },
        73: { name: "Ring", img: "kolechko.png", price: 100 },
        74: { name: "Plush Pepe", img: "pepe.png", price: 10000000 },
        75: { name: "Golden Watch", img: "chassiki.png", price: 1000000 },
        76: { name: "Golden Ring", img: "kkolso.png", price: 1500000 },
        77: { name: "Nail Bracelet", img: "kkoolsoo.png", price: 3000000 },
        78: { name: "Precious Peach", img: "sliva.png", price: 4000000 },
        79: { name: "Figurine", img: "statyyetka.png", price: 3500000 },
        80: { name: "Figurine of Durov", img: "statyya.jpg", price: 2000000 },
    };

const CASES = [
        { name: "Шкатулка Удачи", stars: 5, ton: 1, img: "case2.png", loot: [[9, 99], [70, 0.6], [1, 0.1], [56, 0.1], [57, 0.1], [28, 0.1]] },

        { name: "Мистический", stars: 100, ton: 2, img: "case3.png", loot: [[73, 98], [42, 1], [9, 0.1], [7, 0.8], [62, 0.1]] },

        { name: "Лесной Оазис", stars: 200, ton: 3, img: "case4.png", loot: [[29, 0], [20, 0], [8, 0], [17, 99], [51, 1]] },

        { name: "Пиратский Клад", stars: 150, ton: 5, img: "case5.png", loot: [[55, 0], [27, 0], [63, 30], [59, 65], [20, 5]] },

        { name: "Детективный", stars: 350, ton: 7, img: "case7.png", loot: [[30, 0], [41, 1], [18, 5], [16, 70], [27, 25]] },

        { name: "Технологический", stars: 450, ton: 10, img: "case8.png", loot: [[40, 0], [41, 0], [24, 0], [63, 10], [59, 90]] },

        // ВОТ ТУТ БЫЛА ОШИБКА (добавлена запятая перед [4, 10])
        { name: "Лимонный", stars: 500, ton: 15, img: "case9.png", loot: [[74, 20], [75, 20], [76, 20], [77, 20], [78, 20]] }, 

        { name: "Case of Durov", stars: 100, ton: 15, img: "chemodan.jpg", loot: [[80, 20], [79, 20], [78, 20], [77, 20], [76, 20]] }, 
    ];

    async function syncBalance() {
        const fakeStars = parseInt(localStorage.getItem('fake_stars') || '0');
        if (!user) {
            balance.stars = 1000 + fakeStars;
            updateUI();
            return;
        }
        try {
            const res = await fetch(`${BACKEND_URL}/get_balance/${user.id}?t=${Date.now()}`);
            const data = await res.json();
            balance.stars = data.stars + fakeStars;
            balance.ton = data.balance;
        } catch (e) {
            balance.stars = 1000 + fakeStars;
        }
        updateUI();
    }

function updateUI() {
    // Форматируем число, заменяя пробелы на точки
    const formattedStars = Math.floor(balance.stars).toLocaleString('ru-RU').replace(/\s/g, '.');
    document.getElementById('header-stars').innerText = formattedStars;
    
    document.getElementById('header-ton').innerText = balance.ton.toFixed(2);
}


    function render() {
        document.getElementById('main-grid').innerHTML = CASES.map((c, i) => `
            <div class="case-card p-6 flex flex-col items-center" onclick="openCase(${i})">
                <img src="img/${c.img}" class="w-24 h-24 mb-4 object-contain">
                <div class="orbitron text-[10px] text-green-500 font-black mb-1 uppercase">${c.name}</div>
                <div class="text-[11px] font-bold opacity-40 uppercase">${c.stars === 0 ? 'Бесплатно' : '⭐ ' + c.stars}</div>
            </div>
        `).join('');
    }

    function openCase(i) {
        activeCase = CASES[i];
        setMul(1);
        document.getElementById('case-modal').style.display = 'flex';
        document.getElementById('view-preview').style.display = 'block';
        document.getElementById('view-roulette').style.display = 'none';
        document.getElementById('view-win').style.display = 'none';
        
        document.getElementById('m-img').src = `img/${activeCase.img}`;
        document.getElementById('m-title').innerText = activeCase.name;

        document.getElementById('loot-display').innerHTML = activeCase.loot.map(itemArr => {
            const item = ITEMS[itemArr[0]];
            return `
            <div class="bg-white/5 border border-white/5 rounded-2xl p-2 flex flex-col items-center">
                <img src="img/${item.img}" class="w-10 h-10 mb-1">
                <div class="text-[8px] text-green-500">⭐ ${item.price}</div>
            </div>`;
        }).join('');
    }

    function setMul(n) {
        mul = n;
        document.querySelectorAll('.cnt-btn').forEach(b => b.classList.toggle('active', parseInt(b.innerText) === n));
        document.getElementById('p-stars').innerText = activeCase.stars * n;
        document.getElementById('p-ton').innerText = (activeCase.ton * n).toFixed(2);
    }

    function getWin() {
        const pool = activeCase.loot.map(attr => ({ id: attr[0], weight: attr[1], ...ITEMS[attr[0]] }));
        const totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
        let rnd = Math.random() * totalWeight;
        for (let item of pool) {
            if (rnd < item.weight) return item;
            rnd -= item.weight;
        }
        return pool[0];
    }

    function startRoll(type) {
        const cost = type === 'stars' ? activeCase.stars * mul : activeCase.ton * mul;
        if (balance[type] < cost) return alert("Недостаточно средств");
        
        balance[type] -= cost;
        updateUI();

        document.getElementById('view-preview').style.display = 'none';
        document.getElementById('view-roulette').style.display = 'flex';
        document.getElementById('roul-title').innerText = activeCase.name;
        document.getElementById('roulette-rows').innerHTML = '';

        document.getElementById('possible-loot').innerHTML = activeCase.loot.map(attr => `
            <div class="loot-preview-card"><img src="img/${ITEMS[attr[0]].img}"></div>
        `).join('');

        const winners = [];
        for (let i = 0; i < mul; i++) {
            const win = getWin();
            winners.push(win);
            createRow(i, win);
        }
        setTimeout(() => showWin(winners), 7200);
    }

    function createRow(idx, win) {
        const row = document.createElement('div');
        row.className = 'roulette-container mb-4';
        row.innerHTML = `<div class="center-line"></div><div class="roulette-rail" id="rail-${idx}"></div>`;
        document.getElementById('roulette-rows').appendChild(row);

        const rail = document.getElementById(`rail-${idx}`);
        const winIndex = 35;
        const itemWidth = 140;
        
        let html = '';
        for (let i = 0; i < 45; i++) {
            const randomItem = activeCase.loot[Math.floor(Math.random() * activeCase.loot.length)];
            const id = (i === winIndex) ? win.id : randomItem[0];
            html += `<div class="roulette-item" id="item-${idx}-${i}"><img src="img/${ITEMS[id].img}"></div>`;
        }
        rail.innerHTML = html;

        setTimeout(() => {
            const center = window.innerWidth / 2;
            const targetPos = (winIndex * itemWidth) + (itemWidth / 2) - center;
            rail.style.transition = 'transform 6.5s cubic-bezier(0.15, 0, 0.05, 1)';
            rail.style.transform = `translateX(-${targetPos}px)`;
            
            setTimeout(() => {
                const el = document.getElementById(`item-${idx}-${winIndex}`);
                if (el) el.classList.add('win-glow');
                if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            }, 6500);
        }, 100);
    }

function showWin(winners) {
        currentWinners = winners;
        document.getElementById('view-roulette').style.display = 'none';
        document.getElementById('view-win').style.display = 'flex';
        
        let totalSellPrice = 0;
        document.getElementById('win-grid').innerHTML = winners.map(w => {
            totalSellPrice += w.price;
            addLiveItem(false, w);
            return `
            <div class="bg-white/5 p-4 rounded-[30px] border border-white/10 flex flex-col items-center min-w-[100px]">
                <img src="img/${w.img}" class="w-16 h-16">
                <div class="orbitron text-[8px] text-green-500 mt-2 uppercase">${w.name}</div>
            </div>`;
        }).join('');

        // Форматируем общую цену: разделяем разряды и меняем пробелы на точки
        const formattedPrice = totalSellPrice.toLocaleString('ru-RU').replace(/\s/g, '.');
        document.getElementById('sell-price').innerText = formattedPrice;
        
        document.getElementById('sell-btn').onclick = () => {
            balance.stars += totalSellPrice;
            localStorage.setItem('fake_stars', (parseInt(localStorage.getItem('fake_stars') || '0') + totalSellPrice));
            updateUI();
            closeModal();
        };
    }

    function saveToInventoryAndClose() {
        let inventory = JSON.parse(localStorage.getItem('user_inventory') || '[]');
        currentWinners.forEach(item => {
            inventory.push({ name: item.name, img: `img/${item.img}`, price: item.price });
        });
        localStorage.setItem('user_inventory', JSON.stringify(inventory));
        closeModal();
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    }

    function addLiveItem(first = false, it = null) {
        const rail = document.getElementById('live-drop-rail');
        if (!rail) return;
        const keys = Object.keys(ITEMS);
        const item = it || ITEMS[keys[Math.floor(Math.random() * keys.length)]];
        const div = document.createElement('div');
        div.className = 'drop-item';
        div.innerHTML = `<img src="img/${item.img}" onerror="this.src='img/star.png'"><div class="text-[7px] mt-1 font-black" style="color:${it ? '#00ff41' : '#333'}">${it ? 'YOU' : 'DROP'}</div>`;
        first ? rail.appendChild(div) : rail.prepend(div);
    }

    function initLive() {
        const rail = document.getElementById('live-drop-rail');
        for (let i = 0; i < 15; i++) addLiveItem(true);
        let x = 0;
        function run() {
            x -= 0.5;
            if (x <= -92) {
                x = 0;
                if (rail.firstElementChild) rail.appendChild(rail.firstElementChild);
            }
            rail.style.transform = `translateX(${x}px)`;
            requestAnimationFrame(run);
        }
        run();
    }

    function closeModal() {
        document.getElementById('case-modal').style.display = 'none';
        currentWinners = [];
    }

    // ИСПРАВЛЕННЫЙ ЗАГРУЗЧИК
    window.onload = () => {
        render(); // Сначала рисуем
        initLive(); // Запускаем ленту
        syncBalance(); // Потом баланс
    };
</script>
</body>
</html>
